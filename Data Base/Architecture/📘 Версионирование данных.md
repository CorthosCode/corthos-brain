# üìò –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–∫, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ:

* –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, **–∫—Ç–æ** –∏ **–∫–æ–≥–¥–∞** –≤–Ω–µ—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è;
* –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ **—Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏** –¥–∞–Ω–Ω—ã—Ö;
* —Ö—Ä–∞–Ω–∏—Ç—å **–∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π**;
* —Ä–µ—à–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.



–í –ë–î —ç—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è:

* –∏—Å—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (audit log),
* –∫–æ–Ω—Ç—Ä–æ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (optimistic locking),
* –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ—Ä—Å–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞).





***

## –†—É—á–Ω–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Å–∞–º–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö.



### –í–µ—Ä—Å–∏–æ–Ω–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ (version, revision, row\_version)

* –í —Ç–∞–±–ª–∏—Ü—É –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–µ `version INT` –∏–ª–∏ `revision`.
* –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤–µ—Ä—Å–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

```sql
CREATE TABLE contracts (
    id SERIAL PRIMARY KEY,
    title TEXT,
    amount NUMERIC,
    version INT DEFAULT 1
);

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–µ—Ä—Å–∏–∏
UPDATE contracts
SET amount = 2000, version = version + 1
WHERE id = 1 AND version = 1;
```

‚úÖ –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫—É –∫—Ç–æ-—Ç–æ –ø–æ–º–µ–Ω—è–ª ‚Üí `version` —É–∂–µ –¥—Ä—É–≥–æ–π ‚Üí update –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è.



### –§–ª–∞–≥ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ + –∏—Å—Ç–æ—Ä–∏—è

–í —Ç–∞–±–ª–∏—Ü–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π –∑–∞–ø–∏—Å–∏, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è.

```sql
CREATE TABLE employee (
    id INT,
    name TEXT,
    salary NUMERIC,
    valid_from DATE,
    valid_to DATE,
    is_active BOOLEAN
);
```

* `is_active = TRUE` ‚Üí —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è.
* –°—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.



### Audit trail (–∂—É—Ä–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π)

* –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –µ—ë –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø–∏—à–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `employee_history`.
* –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π, –Ω–æ —Ç–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π.

```sql
CREATE TABLE employee_history (
    id INT,
    name TEXT,
    salary NUMERIC,
    changed_at TIMESTAMP,
    operation TEXT
);
```





***

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—á–µ—Ä–µ–∑ –°–£–ë–î –∏–ª–∏ ORM)

–ú–Ω–æ–≥–∏–µ –°–£–ë–î –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:

* **PostgreSQL ‚Üí MVCC (Multiversion Concurrency Control)**
  * –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–µ—Ä—Å–∏—è—Ö (–ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç VACUUM).
  * –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –≤–∏–¥–µ—Ç—å "—Å–≤–æ—é" –≤–µ—Ä—Å–∏—é –¥–∞–Ω–Ω—ã—Ö.
  * –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞, –Ω–æ –æ–±—ã—á–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –±–∏–∑–Ω–µ—Å-–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –ø–æ–ª—è).
* **ORM (Hibernate, JPA, Django ORM –∏ —Ç. –¥.)**
  * Hibernate –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `@Version` –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:

```java
@Entity
public class Contract {
    @Id
    private Long id;
    private String title;
    private Double amount;

    @Version
    private Integer version;
}
```

‚úÖ Hibernate –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `version` –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.





***

## –°–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏—è–º–∏ –¥–∞–Ω–Ω—ã—Ö (temporal databases)

–ü–æ–¥—Ö–æ–¥, –∫–æ–≥–¥–∞ –ë–î —Ö—Ä–∞–Ω–∏—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–æ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –∏—Ö –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏.

* **–°–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (system-time)** ‚Üí –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å —Ä–µ–∞–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ –ë–î.
* **–í—Ä–µ–º—è –±–∏–∑–Ω–µ—Å–∞ (valid-time)** ‚Üí –ø–µ—Ä–∏–æ–¥, –≤ –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø–∏—Å—å –±—ã–ª–∞ "–∏—Å—Ç–∏–Ω–Ω–∞" –≤ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.

–ü—Ä–∏–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã —Å temporal-–¥–∞–Ω–Ω—ã–º–∏:

```sql
CREATE TABLE contract_versions (
    id INT,
    contract_id INT,
    title TEXT,
    amount NUMERIC,
    valid_from DATE,
    valid_to DATE
);
```

üëâ –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å: "–∫–∞–∫–æ–π –±—ã–ª –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ 01.01.2022?"





***

## –í–∏–¥—ã –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

* **–ü–æ–ª–Ω–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**
  * –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
  * –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª—é–±—É—é –≤–µ—Ä—Å–∏—é.
  * –ú–∏–Ω—É—Å: –±—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç –¥–∞–Ω–Ω—ã—Ö.
* **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ (–¥–µ–ª—å—Ç–∞-–≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)**
  * –•—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (diff).
  * –ù–∞–ø—Ä–∏–º–µ—Ä, Git, Event Sourcing.
  * –ü–ª—é—Å: —ç–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞.
  * –ú–∏–Ω—É—Å: —Å–ª–æ–∂–Ω–µ–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É.
* **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ**
  * –•—Ä–∞–Ω–∏–º –ø–æ–ª–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ + –¥–µ–ª—å—Ç—ã.
  * –ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–∞–∂–¥—ã–µ N –∏–∑–º–µ–Ω–µ–Ω–∏–π, –º–µ–∂–¥—É –Ω–∏–º–∏ —Ç–æ–ª—å–∫–æ —Ä–∞–∑–Ω–∏—Ü—ã.





***

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

* **Optimistic locking** (–º—è–≥–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ø–æ–ª–µ version).
* **–ò—Å—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (audit trail)** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏.
* **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π** ‚Äî –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é "—á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å".
* **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤** ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–¥–∞–∫—Ü–∏–π –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –∑–∞—è–≤–æ–∫ –∏ —Ç. –¥.
* **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏** ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å "–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—à–ª–æ–µ" –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –¥–∞—Ç—É.



