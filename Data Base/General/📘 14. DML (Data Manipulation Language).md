# üìò DML (Data Manipulation Language)

**DML (Data Manipulation Language)** ‚Äî —ç—Ç–æ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ SQL, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –¥–ª—è **—Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü**.

–ï—Å–ª–∏ **DDL** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (—Ç–∞–±–ª–∏—Ü—ã, —Å—Ö–µ–º—ã –∏ —Ç.–¥.), —Ç–æ **DML —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —ç—Ç–∏—Ö —Ç–∞–±–ª–∏—Ü**.





***

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã DML

–í PostgreSQL –∫ DML –æ—Ç–Ω–æ—Å—è—Ç:

* `INSERT` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É
* `UPDATE` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
* `DELETE` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
* `MERGE` (—Å –≤–µ—Ä—Å–∏–∏ PostgreSQL 15) ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ INSERT/UPDATE/DELETE





***

## –ö–æ–º–∞–Ω–¥–∞ `INSERT`

–°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
INSERT INTO table_name (column1, column2, ...)
VALUES (value1, value2, ...);
```



–í—Å—Ç–∞–≤–∫–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```sql
INSERT INTO users (name, age, email)
VALUES ('Ivan', 25, 'ivan@mail.com');
```

–í—Å—Ç–∞–≤–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫

```sql
INSERT INTO users (name, age)
VALUES 
    ('Anna', 30),
    ('Petr', 40),
    ('Maria', 22);
```

–í—Å—Ç–∞–≤–∫–∞ —Å –≤—ã–±–æ—Ä–∫–æ–π –∏–∑ –¥—Ä—É–≥–æ–π —Ç–∞–±–ª–∏—Ü—ã

```sql
INSERT INTO archive_users (id, name, age)
SELECT id, name, age FROM users WHERE age > 60;
```

–í—Å—Ç–∞–≤–∫–∞ —Å –ø—Ä–æ–ø—É—Å–∫–æ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ (–±—É–¥—É—Ç default/null)

```sql
INSERT INTO users (name) VALUES ('Olga');
```

–í—Å—Ç–∞–≤–∫–∞ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ (`ON CONFLICT`)

> PostgreSQL —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç SQL ‚Äî –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UPSERT.

```sql
INSERT INTO users (id, name, age)
VALUES (1, 'Alex', 28)
ON CONFLICT (id) DO UPDATE
SET name = EXCLUDED.name, age = EXCLUDED.age;
```

`EXCLUDED` ‚Äî –ø—Å–µ–≤–¥–æ–Ω–∏–º –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—ã—Ç–∞–ª–∏—Å—å –≤—Å—Ç–∞–≤–∏—Ç—å.





***

## –ö–æ–º–∞–Ω–¥–∞ `UPDATE`

–°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
UPDATE table_name
SET column1 = value1, column2 = value2, ...
WHERE condition;
```



–ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```sql
UPDATE users
SET age = 26
WHERE name = 'Ivan';
```

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–ª–æ–Ω–æ–∫

```sql
UPDATE users
SET age = age + 1,
    email = LOWER(email);
```

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º

```sql
UPDATE users
SET age = (SELECT AVG(age) FROM users)
WHERE id = 5;
```

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫

```sql
UPDATE users SET age = age + 1;
```





***

## –ö–æ–º–∞–Ω–¥–∞ `DELETE`

–°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
DELETE FROM table_name
WHERE condition;
```



–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```sql
DELETE FROM users
WHERE id = 10;
```

–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ —É—Å–ª–æ–≤–∏—é

```sql
DELETE FROM users
WHERE age < 18;
```

–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫

```sql
DELETE FROM users;
```





***

## –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `TRUNCATE` –∏ `DELETE`

–í–∞–∂–Ω–æ: –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `TRUNCATE`, –∫–æ–º–∞–Ω–¥–∞ `DELETE` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ –∂—É—Ä–Ω–∞–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å).

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞     | `DELETE`           | `TRUNCATE`            |
| ------------------ | ------------------ | --------------------- |
| –£—Å–ª–æ–≤–∏–µ `WHERE`    | ‚úÖ –µ—Å—Ç—å             | ‚ùå –Ω–µ—Ç                 |
| –õ–æ–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π     | –ü–æ–ª–Ω—ã–π (–º–µ–¥–ª–µ–Ω–Ω–µ–µ) | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (–±—ã—Å—Ç—Ä–µ–µ) |
| –í–æ–∑–≤—Ä–∞—Ç (ROLLBACK) | ‚úÖ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è   | ‚úÖ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è      |
| –°–±—Ä–æ—Å IDENTITY     | ‚ùå –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é     | ‚úÖ –º–æ–∂–Ω–æ (`RESTART`)   |





***

## –ö–æ–º–∞–Ω–¥–∞ `MERGE` (PostgreSQL 15+)

**`MERGE`** ‚Äî –∫–æ–º–∞–Ω–¥–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ SQL:2003, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É `INSERT`, `UPDATE` –∏ `DELETE`. –≠—Ç–æ —Å–≤–æ–µ–≥–æ —Ä–æ–¥–∞ **`UPSERT`**(update + insert).



–°–º—ã—Å–ª: —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ **–∏—Å—Ç–æ—á–Ω–∏–∫–∞** —Å **—Ü–µ–ª–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ–π** –∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:

* –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å,
* –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é,
* —É–¥–∞–ª–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—É—é.



–°–∏–Ω—Ç–∞–∫—Å–∏—Å

```sql
MERGE INTO target_table AS t
USING source_table AS s
ON (—É—Å–ª–æ–≤–∏–µ_—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è)
WHEN MATCHED THEN
    UPDATE SET column1 = s.column1, column2 = s.column2
WHEN NOT MATCHED THEN
    INSERT (column1, column2) VALUES (s.column1, s.column2);
```



### –ü—Ä–∏–º–µ—Ä —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π

–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –¶–µ–ª–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–∫—É–¥–∞ –ø–∏—à–µ–º)
CREATE TABLE products (
    id INT PRIMARY KEY,
    name TEXT,
    price NUMERIC
);

-- –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–≥—Ä—É–∑–∫–∞)
CREATE TABLE new_data (
    id INT,
    name TEXT,
    price NUMERIC
);

INSERT INTO products VALUES
(1, 'Phone', 500),
(2, 'Laptop', 1000);

INSERT INTO new_data VALUES
(2, 'Laptop', 1200),   -- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
(3, 'Tablet', 700);    -- –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
```

–ó–∞–ø—Ä–æ—Å

```sql
MERGE INTO products p
USING new_data n
ON p.id = n.id
WHEN MATCHED THEN
    UPDATE SET price = n.price
WHEN NOT MATCHED THEN
    INSERT (id, name, price) VALUES (n.id, n.name, n.price);
```

–†–µ–∑—É–ª—å—Ç–∞—Ç

```sql
products:
(1, 'Phone', 500)   -- –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
(2, 'Laptop', 1200) -- –æ–±–Ω–æ–≤–ª—ë–Ω
(3, 'Tablet', 700)  -- –¥–æ–±–∞–≤–ª–µ–Ω
```

üëâ –û–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –º—ã —Å–¥–µ–ª–∞–ª–∏ **–∏ UPDATE, –∏ INSERT**.



### –ü—Ä–∏–º–µ—Ä –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ (–∫–æ—Ä—Ç–µ–∂)

```sql
MERGE INTO users u
USING (VALUES (1, 'Oleg', 35),
              (2, 'Irina', 29)) AS s(id, name, age)
ON u.id = s.id
WHEN MATCHED THEN
    UPDATE SET name = s.name, age = s.age
WHEN NOT MATCHED THEN
    INSERT (id, name, age) VALUES (s.id, s.name, s.age);
```



### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `MERGE`

* `WHEN MATCHED THEN UPDATE` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –Ω–∞–π–¥–µ–Ω–∞.
* `WHEN MATCHED THEN DELETE` ‚Üí —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏.
* `WHEN NOT MATCHED THEN INSERT` ‚Üí –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç.

–ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å:

```sql
MERGE INTO target t
USING source s
ON (t.id = s.id)
WHEN MATCHED AND s.is_deleted = true THEN
    DELETE
WHEN MATCHED THEN
    UPDATE SET col = s.col
WHEN NOT MATCHED THEN
    INSERT (id, col) VALUES (s.id, s.col);
```



### –î–ª—è —á–µ–≥–æ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç

* **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–≤–∞—Ä—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–∞—Ç–∞–ª–æ–≥–∏).
* **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –º–µ–∂–¥—É –¥–≤—É–º—è —Å–∏—Å—Ç–µ–º–∞–º–∏.
* **–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö** (—á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å –∫—É—á—É IF-–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–æ–∫).
* –ö–∞–∫ **upsert** (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `INSERT ... ON CONFLICT DO UPDATE` –≤ PostgreSQL).



### –û—Ç–ª–∏—á–∏–µ –æ—Ç `INSERT ... ON CONFLICT`

–í PostgreSQL –¥–æ –≤–µ—Ä—Å–∏–∏ 15 —á–∞—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:

```sql
INSERT INTO products (id, name, price)
VALUES (2, 'Laptop', 1200)
ON CONFLICT (id) DO UPDATE
SET price = EXCLUDED.price;
```

üëâ –ù–æ `ON CONFLICT` —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –¥–ª—è INSERT ‚Üí UPDATE**, –∞ `MERGE` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª–µ–Ω: –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å –µ—â—ë –∏ `DELETE`, –∏ —Å–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.





***

## –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å DML

* DML-–∫–æ–º–∞–Ω–¥—ã **–Ω–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç DDL).
* –ò—Ö –º–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

```sql
BEGIN;

INSERT INTO users (name, age) VALUES ('Svetlana', 31);
UPDATE users SET age = age + 1 WHERE id = 5;
DELETE FROM users WHERE age > 100;

COMMIT;
```

–ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å:

```sql
ROLLBACK;
```



