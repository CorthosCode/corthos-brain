
## Внешний уровень (External Level)

* Пользователь работает через:
  * **SQL-клиенты** (`psql`, DBeaver, PgAdmin, приложения на Python/Java и т. д.);
  * **views** (представления), **materialized views**;
  * механизмы прав доступа (`GRANT`, `REVOKE`).
* Каждый пользователь может видеть свою "картину данных".
  👉 Пример: бухгалтеру можно дать доступ только к `SELECT` на таблицу `invoices`, а HR только к `employees`.


***

## Концептуальный уровень (Conceptual Level)

* Представлен **логической моделью данных** в схеме PostgreSQL:
  * **таблицы** (`CREATE TABLE`);
  * **связи (PK/FK)**;
  * **ограничения целостности** (`NOT NULL`, `CHECK`, `UNIQUE`);
  * **типы данных** (в PostgreSQL очень богаты: от `INTEGER` до `JSONB`, `ARRAY`, `UUID`).
* В этом уровне мы мыслим **сущностями и связями**, а не файлами и страницами.


***

## Внутренний уровень (Internal Level)

В PostgreSQL именно тут кроется его сила.

* **Физическое хранение**:
  * данные в таблицах хранятся в **heap-файлах** (страницы по 8 КБ);
  * индексы: `B-Tree`, `Hash`, `GIN`, `GiST`, `BRIN`;
  * поддержка **TOAST** (система хранения больших значений, например длинных строк/JSON).
* **Буферный кэш**: PostgreSQL использует собственный shared buffer pool + page cache ОС.
* **WAL (Write-Ahead Log)**: журнализация изменений (важно для отказоустойчивости и репликации).
* **Фоновые процессы**:
  * `checkpointer` — сброс грязных страниц;
  * `wal writer` — пишет WAL;
  * `autovacuum` — чистка "мертвых" строк (MVCC);
  * `bgwriter` — оптимизация записи страниц.


***

## Архитектурные компоненты PostgreSQL


### 1. Ядро (Server Backend)

* Управление процессами (каждое соединение = отдельный backend-процесс).
* **Менеджер транзакций**:
  * реализация **MVCC** (каждая транзакция видит свою "снимок" БД);
  * блокировки (row-level locks, advisory locks);
  * изоляция транзакций (Read Committed, Repeatable Read, Serializable).


### 2. Оптимизатор запросов

* PostgreSQL имеет один из самых мощных оптимизаторов:
  * строит план (Seq Scan, Index Scan, Bitmap Scan, Hash Join, Nested Loop, Merge Join);
  * умеет использовать **статистику (ANALYZE)**;
  * поддерживает **параллельное выполнение** (parallel query).


### 3. Модуль расширений

* PostgreSQL — **extensible**:
  можно добавлять свои типы данных, функции, индексы, языки процедур (`plpgsql`, `plpythonu` и др.).
* Существуют популярные расширения:
  * `PostGIS` (геоданные),
  * `pg_partman` (партиционирование),
  * `timescaledb` (тайм-серии).


### 4. Безопасность

* Аутентификация: md5, scram-sha-256, Kerberos, SSL.
* Авторизация: роли и привилегии.
* Row-Level Security (RLS) — политики доступа на уровне строк.


***

## PostgreSQL в трёхуровневой модели ANSI/SPARC

```text
┌───────────────────────────────────────────────┐
│ Пользователи, клиенты, приложения             │
└───────────────────────────────────────────────┘
                     │
   ┌─────────────────▼─────────────────┐
   │        Внешний уровень            │
   │  (External / View Level)          │
   │  – Представления (VIEW,           │
   │    MATERIALIZED VIEW)             │
   │  – Роли и привилегии(GRANT/REVOKE)│
   │  – Схемы как пространства имён    │
   └─────────────────┬─────────────────┘
                     │
   ┌─────────────────▼─────────────────┐
   │      Концептуальный уровень       │
   │  (Conceptual / Logical Level)     │
   │  – Таблицы, типы данных           │
   │  – Первичные/внешние ключи (PK/FK)│
   │  – Ограничения (CHECK, UNIQUE)    │
   │  – Расширенные типы (JSONB, ARRAY,│
   │    RANGE, пользовательские типы)  │
   │  – Схемы (logical grouping)       │
   └─────────────────┬─────────────────┘
                     │
   ┌─────────────────▼─────────────────┐
   │        Внутренний уровень         │
   │  (Internal / Physical Level)      │
   │  – Heap-файлы и TOAST             │
   │  – Страницы по 8 КБ               │
   │  – Индексы (B-tree, GIN, GiST)    │
   │  – WAL (Write-Ahead Logging)      │
   │  – Буферный кэш (shared buffers)  │
   │  – MVCC (механизм изоляции)       │
   │  – Фоновые процессы (autovacuum,  │
   │    bgwriter, WAL writer)          │
   └─────────────────┬─────────────────┘
                     │
   ┌─────────────────▼─────────────────┐
   │    Файловая система ОС и          │
   │    дисковая подсистема            │
   │    (data directories, tablespaces)│
   └───────────────────────────────────┘
```

