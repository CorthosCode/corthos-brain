
**Предикаты подзапросов** — это конструкции, которые позволяют использовать результат подзапроса (`SELECT`) в условиях внешнего запроса.

Они помогают сравнивать отдельные значения или наборы значений.


***

## `IN` / `NOT IN`

Сравнение значения с множеством, возвращённым подзапросом.

```sql
-- Найти сотрудников, работающих в департаментах Нью-Йорка
SELECT name, department_id
FROM employees
WHERE department_id IN (
    SELECT id
    FROM departments
    WHERE location = 'New York'
);
```

⚠️ Особенность `NOT IN`: если подзапрос вернёт `NULL`, результат может быть `UNKNOWN`, и строка не попадёт в выборку. Лучше использовать `NOT EXISTS`.


***

## `EXISTS` / `NOT EXISTS`

Проверка **наличия строк** в подзапросе.

```sql
-- Сотрудники, у которых есть премии
SELECT e.name
FROM employees e
WHERE EXISTS (
    SELECT 1
    FROM bonuses b
    WHERE b.employee_id = e.id
);

-- Сотрудники без премий
SELECT e.name
FROM employees e
WHERE NOT EXISTS (
    SELECT 1
    FROM bonuses b
    WHERE b.employee_id = e.id
  );
```

✔ `EXISTS` возвращает `TRUE`, если подзапрос вернул хотя бы одну строку.

✔ Часто используется в коррелирующих подзапросах.


***

## `ANY` / `SOME`

Сравнение значения с **каждым элементом набора** (достаточно совпадения с одним).

```sql
-- Сотрудники с зарплатой больше хотя бы одной зарплаты из департамента 10
SELECT name, salary
FROM employees
WHERE salary > ANY (
    SELECT salary
    FROM employees
    WHERE department_id = 10
);
```

✔ `= ANY` эквивалентно `IN`.

✔ `> ANY` — «больше, чем минимум» из множества.


***

## `ALL`

Сравнение значения с набором: условие должно выполняться **для всех элементов**.

```sql
-- Сотрудники с зарплатой выше всех зарплат в департаменте 10
SELECT name, salary
FROM employees
WHERE salary > ALL (
    SELECT salary
    FROM employees
    WHERE department_id = 10
);
```

✔ `> ALL` — «больше максимума».

✔ `< ALL` — «меньше минимума».


***

## Скалярные подзапросы

Подзапрос возвращает одно значение (одно поле и одну строку).

Его можно сравнивать через `=`, `>`, `<` и т. д.

```sql
-- Сотрудники с зарплатой выше средней
SELECT name, salary
FROM employees
WHERE salary > (
    SELECT AVG(salary)
    FROM employees
);
```

⚠️ Если скалярный подзапрос возвращает больше одной строки → ошибка.


***

## Сравнение с кортежами (PostgreSQL)

PostgreSQL позволяет сравнивать не только скаляры, но и **кортежи (tuple)**.

```sql
-- Сотрудники, у которых (департамент, должность) совпадают с кем-то из таблицы вакансий
SELECT name, department_id, job_id
FROM employees
WHERE (department_id, job_id) IN (
    SELECT department_id, job_id
    FROM vacancies
);
```


***

## Таблица предикатов

| Предикат                         | Значение                                                            |
| -------------------------------- | ------------------------------------------------------------------- |
| `IN` / `NOT IN`                  | Проверка принадлежности множеству                                   |
| `EXISTS` / `NOT EXISTS`          | Проверка наличия строк                                              |
| `ANY` / `SOME`                   | Достаточно выполнения условия хотя бы для одного элемента множества |
| `ALL`                            | Условие выполняется для всех элементов множества                    |
| Скалярный подзапрос              | Возвращает одно значение, сравнивается напрямую                     |
| Кортежный подзапрос (PostgreSQL) | Сравнение по нескольким полям сразу                                 |

