
**Ссылочная целостность** — это правило, которое гарантирует, что значения во **внешнем ключе (FOREIGN KEY)** таблицы всегда ссылаются на существующие значения в **первичном (PRIMARY KEY)** или уникальном (UNIQUE) ключе другой таблицы.

➡️ Другими словами: нельзя ссылаться на несуществующую запись.


Ссылочная целостность:

* Предотвращает «висячие ссылки» (orphan records).
* Гарантирует логическую согласованность данных между связанными таблицами.
* Обеспечивает правильность связей **«один ко многим»** и **«многие ко многим»**.
* Упрощает сопровождение базы данных.


***

## Основные правила ссылочной целостности

Пусть есть две таблицы:

* **Parent (родительская)** — таблица с первичным ключом.
* **Child (дочерняя)** — таблица, ссылающаяся на Parent.

**Правила:**

1. В `Child` внешний ключ может содержать:
   * значение, равное одному из ключей в `Parent`;
   * или NULL (если это допускается).
2. В `Parent` нельзя удалить или изменить запись, если на неё всё ещё ссылаются строки в `Child` (кроме случаев, когда явно задано поведение при удалении/обновлении).


***

## Средства поддержания ссылочной целостности в PostgreSQL


### Ограничение FOREIGN KEY

* Основное средство обеспечения ссылочной целостности.
* Проверяется автоматически СУБД при `INSERT`, `UPDATE`, `DELETE`.

Пример:

```sql
CREATE TABLE department (
    dept_id SERIAL PRIMARY KEY,
    dept_name TEXT NOT NULL
);

CREATE TABLE employee (
    emp_id SERIAL PRIMARY KEY,
    emp_name TEXT NOT NULL,
    dept_id INT REFERENCES department(dept_id)
);
```

Здесь `employee.dept_id` **не может содержать значения**, которых нет в `department.dept_id`.


### Действия при нарушении ссылок

При создании FOREIGN KEY можно задать, что делать при изменении или удалении строки из родительской таблицы:

```sql
CREATE TABLE employee (
    emp_id SERIAL PRIMARY KEY,
    emp_name TEXT NOT NULL,
    dept_id INT REFERENCES department(dept_id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

Варианты:

| Правило                        | Значение                                                                            |
| ------------------------------ | ----------------------------------------------------------------------------------- |
| `ON DELETE / UPDATE RESTRICT`  | Запрещает удаление/обновление, если есть зависимые строки (по умолчанию).           |
| `ON DELETE / UPDATE NO ACTION` | То же самое, но проверка откладывается до конца транзакции.                         |
| `ON DELETE CASCADE`            | При удалении строки из Parent автоматически удаляются все связанные строки в Child. |
| `ON UPDATE CASCADE`            | При изменении ключа в Parent обновляется значение внешнего ключа в Child.           |
| `ON DELETE SET NULL`           | При удалении строки Parent внешний ключ в Child становится `NULL`.                  |
| `ON UPDATE SET NULL`           | При обновлении Parent внешний ключ в Child становится `NULL`.                       |
| `ON DELETE SET DEFAULT`        | В Child подставляется значение по умолчанию.                                        |
| `ON UPDATE SET DEFAULT`        | То же самое при обновлении.                                                         |


### Индексы

* Для внешнего ключа PostgreSQL автоматически создаёт **индекс в родительской таблице** (на referenced колонку), чтобы ускорить проверки ссылочной целостности.
* Для дочерней таблицы индекс на внешний ключ не обязателен, но часто полезен (ускоряет JOIN и каскадные проверки).


### Триггеры

* PostgreSQL реализует `FOREIGN KEY` через **системные триггеры**.
* Можно писать свои пользовательские триггеры для кастомной логики ссылочной целостности (например, для сложных бизнес-правил).


### Ограничения отложенной проверки (DEFERRABLE)

* По умолчанию FOREIGN KEY проверяется **сразу при каждом изменении**.
* Но можно задать **DEFERRABLE INITIALLY DEFERRED**, тогда проверка будет происходить только **в конце транзакции**.

Пример:

```sql
CREATE TABLE employee (
    emp_id INT PRIMARY KEY,
    dept_id INT REFERENCES department(dept_id)
        DEFERRABLE INITIALLY DEFERRED
);
```

Используется, если в одной транзакции сначала нарушается, а потом восстанавливается ссылочная целостность.


***

## Примеры


Пример 1 — Запрещённая вставка:

```sql
INSERT INTO employee (emp_name, dept_id) VALUES ('Alice', 999);
-- Ошибка: ключ (dept_id) отсутствует в department
```


Пример 2 — ON DELETE CASCADE:

```sql
DELETE FROM department WHERE dept_id = 1;
-- автоматически удалятся все сотрудники из отдела 1
```


Пример 3 — ON DELETE SET NULL:

```sql
DELETE FROM department WHERE dept_id = 2;
-- все сотрудники отдела 2 теперь будут иметь dept_id = NULL
```

