
**SAVEPOINT** ‚Äî —ç—Ç–æ "–º–µ—Ç–∫–∞" –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

–û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç:

* –û—Ç–∫–∞—Ç–∏—Ç—å —á–∞—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–µ —Ç–µ—Ä—è—è –≤—Å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.
* –ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å —à–∞–≥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∏ –Ω–µ –ª–æ–º–∞–ª–∏ –≤—Å—ë.


***

## –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç—ã

```sql
BEGIN;

-- –¥–µ–π—Å—Ç–≤–∏—è 1
SAVEPOINT sp1;

-- –¥–µ–π—Å—Ç–≤–∏—è 2
SAVEPOINT sp2;

-- –¥–µ–π—Å—Ç–≤–∏—è 3

ROLLBACK TO sp2;  -- –æ—Ç–∫–∞—Ç —Ç–æ–ª—å–∫–æ –∫ sp2 (–¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –Ω–µ–≥–æ –æ—Ç–º–µ–Ω–µ–Ω—ã)

COMMIT;  -- —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–æ, —á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å
```


***

## –û—à–∏–±–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ SAVEPOINT

```sql
BEGIN;

UPDATE products SET price = price * 0.9;  -- –æ—à–∏–±–∫–∞ —Ç—É—Ç!
SAVEPOINT sp1;

INSERT INTO log VALUES ('ok');

ROLLBACK;  -- –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤—Å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —Ç–∞–∫ –∫–∞–∫ —Å–µ–π–≤–ø–æ–∏–Ω—Ç–æ–≤ –µ—â—ë –Ω–µ –±—ã–ª–æ
```

üëâ –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ **–¥–æ —Å–æ–∑–¥–∞–Ω–∏—è SAVEPOINT**, —Ç–æ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ `ROLLBACK` –≤—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.


***

## –û—à–∏–±–∫–∞ –º–µ–∂–¥—É SAVEPOINT-–∞–º–∏

```sql
BEGIN;

INSERT INTO users VALUES (1, 'Alice');
SAVEPOINT sp1;

INSERT INTO users VALUES (2, 'Bob');
SAVEPOINT sp2;

-- —Ç—É—Ç –æ—à–∏–±–∫–∞
UPDATE orders SET total = NULL WHERE id = 5;

ROLLBACK TO sp2;  -- –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ sp2
COMMIT;
```

üëâ –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

* Alice –∏ Bob –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ.
* –û—à–∏–±–æ—á–Ω—ã–π `UPDATE` –æ—Ç–º–µ–Ω—ë–Ω.
* –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å—Å—è –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ.


***

## –û—à–∏–±–∫–∞ –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö SAVEPOINT

```sql
BEGIN;

INSERT INTO users VALUES (1, 'Alice');
SAVEPOINT sp1;

INSERT INTO users VALUES (2, 'Bob');
SAVEPOINT sp2;

INSERT INTO users VALUES (3, 'Charlie');
SAVEPOINT sp3;

-- –æ—à–∏–±–∫–∞
DELETE FROM payments WHERE id = 'abc';  -- –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø

ROLLBACK TO sp1;  -- –æ—Ç–∫–∞—Ç –∫ sp1 (–æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Alice)

COMMIT;
```

üëâ –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:

* –í —Ç–∞–±–ª–∏—Ü–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ Alice**.
* –í—Å—Ç–∞–≤–∫–∏ Bob –∏ Charlie + –æ—à–∏–±–∫–∞ ‚Äî –æ—Ç–º–µ–Ω–µ–Ω—ã.


***

## –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç

–î–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å SAVEPOINT-—ã, –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π `ROLLBACK`

```sql
BEGIN;

INSERT INTO temp_data VALUES (1);
SAVEPOINT sp1;

INSERT INTO temp_data VALUES (2);
SAVEPOINT sp2;

ROLLBACK;  -- –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –í–°–Å (–∏–≥–Ω–æ—Ä–∏—Ä—É—è savepoint-—ã)
```


***

## –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å SAVEPOINT

* **–°–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ SAVEPOINT-–æ–≤** –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
* **ROLLBACK TO spX** –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –≤—Å—ë, —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –ø–æ—Å–ª–µ —ç—Ç–æ–π —Ç–æ—á–∫–∏.
* SAVEPOINT, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã **–ø–æ—Å–ª–µ spX**, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è.
  * –ü—Ä–∏–º–µ—Ä: `ROLLBACK TO sp1` ‚Üí sp2 –∏ sp3 –∏—Å—á–µ–∑–Ω—É—Ç.
* –ú–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞ –∏ –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞—Ç—å `COMMIT`.
* SAVEPOINT –Ω–µ –∂–∏–≤—ë—Ç –≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–æ–Ω –∏—Å—á–µ–∑–∞–µ—Ç –ø–æ—Å–ª–µ `COMMIT` –∏–ª–∏ `ROLLBACK`).

