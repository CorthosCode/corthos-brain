
**Транзакция** — это последовательность SQL-операторов, объединённых в единое целое, которое должно выполняться либо **полностью**, либо **не выполняться вовсе** (атомарность).

Транзакция проходит несколько этапов, и в разных состояниях СУБД ведёт себя по-разному.


***

## Active (Активная)

* Транзакция начинается:
  * Явно: `BEGIN;` или `START TRANSACTION;`
  * Неявно: когда запускается первый оператор (зависит от режима autocommit).
* Выполняются SQL-операторы (`INSERT`, `UPDATE`, `DELETE`, `SELECT … FOR UPDATE` и т. д.).
* Пока транзакция активна, её изменения видны **только самой транзакции** (из-за изоляции).


***

## Partially Committed (Частично зафиксированная)

* Все SQL-операторы внутри транзакции успешно выполнены.
* Выполняется команда `COMMIT`.
* Но пока ещё данные **не записаны окончательно на диск** — они могут находиться в буферах.


***

## Committed (Зафиксированная / Успешная)

* После успешного `COMMIT` изменения становятся:
  * **постоянными** (persisted);
  * **видимыми** для других транзакций.
* В PostgreSQL — это момент, когда запись попала в WAL (журнал предзаписи), что гарантирует сохранность даже при сбое.


***

## Failed (Неуспешная / Ошибочная)

* Если в процессе выполнения команды произошла ошибка (`UNIQUE violation`, `division by zero`, `deadlock detected`), то:
  * В PostgreSQL транзакция помечается как **ошибочная**.
  * Она больше не может выполнять команды, кроме `ROLLBACK`.
* Важно: PostgreSQL очень строгий — после ошибки *нельзя продолжить транзакцию*, нужно откатить.


***

## Aborted (Отменённая)

* Транзакция была **отменена**:
  * Явно: `ROLLBACK;`
  * Неявно: из-за ошибки или сбоя.
* Все изменения, сделанные внутри, **отменяются**.
* Данные возвращаются в исходное состояние.


***

## Граф жизненного цикла (ANSI/ISO SQL)

```sql
          +--------------------+
          |    Active          |
          +--------------------+
            |                \
            |                 \
            v                  v
  +----------------+   +-----------------+
  | Partially      |   | Failed          |
  | Committed      |   +-----------------+
  +----------------+           |
            |                  |
            v                  v
   +----------------+   +-----------------+
   | Committed      |   | Aborted         |
   +----------------+   +-----------------+
```

