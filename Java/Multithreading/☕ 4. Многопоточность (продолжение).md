# ‚òï –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

# `Timer` –∏ `TimerTask`



–ö–ª–∞—Å—Å `Timer` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º: –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ. –†–∞–±–æ—Ç–∞–µ—Ç —Å –ø–æ–º–æ—â—å—é —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–æ–¥–Ω–æ–≥–æ!), –∫–æ—Ç–æ—Ä—ã–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏.



###### üì¶ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã

* **`java.util.Timer`** ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á.
* **`java.util.TimerTask`** ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å, —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–π –∑–∞–¥–∞—á–µ–π.



###### üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```java
Timer timer = new Timer(); // –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å true, –µ—Å–ª–∏ —ç—Ç–æ daemon-–ø–æ—Ç–æ–∫
timer.schedule(new TimerTask() {
    @Override
    public void run() {
        System.out.println("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏!");
    }
}, 1000); // –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º—Å
```



###### üîÅ –í–∞—Ä–∏–∞–Ω—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

| –ú–µ—Ç–æ–¥                                                          | –û–ø–∏—Å–∞–Ω–∏–µ                                                                       |
| -------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| `schedule(TimerTask task, long delay)`                         | –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏                                              |
| `schedule(TimerTask task, Date time)`                          | –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è                                           |
| `schedule(TimerTask task, long delay, long period)`            | –ü–æ–≤—Ç–æ—Ä—è—Ç—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º                                           |
| `scheduleAtFixedRate(TimerTask task, long delay, long period)` | –ü–æ–≤—Ç–æ—Ä—è—Ç—å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π (—Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞, –Ω–µ —É—á–∏—Ç—ã–≤–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ) |



###### üîÑ –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `schedule()` –∏ `scheduleAtFixedRate()`

| –ú–µ—Ç–æ–¥                   | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                                                                                                                   |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| `schedule()`            | –û—Ç—Å—á—ë—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏                                                                        |
| `scheduleAtFixedRate()` | –û—Ç—Å—á—ë—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏ (–º–æ–∂–µ—Ç "–¥–æ–≥–æ–Ω—è—Ç—å" –ø—Ä–∏ –∑–∞–¥–µ—Ä–∂–∫–∞—Ö) |



###### ‚ùó –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

üîπ **–û–¥–∏–Ω –ø–æ—Ç–æ–∫:**`Timer` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ ‚Äî –µ—Å–ª–∏ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –¥–æ–ª–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–ª–∏ –≤—ã–∫–∏–¥—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–≥—É—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å—Å—è –∏–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –≤–æ–≤—Å–µ.

üîπ **–ò—Å–∫–ª—é—á–µ–Ω–∏—è:** –ï—Å–ª–∏ `TimerTask` –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –Ω–µ–ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, `Timer` –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É, –∏ –≤—Å–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –∑–∞–¥–∞—á–∏ –ù–ï –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.

üîπ **–ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è:** –î–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ScheduledExecutorService`.



###### üö´ –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞—á –∏ —Ç–∞–π–º–µ—Ä–∞

```java
timer.cancel(); // –û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–∞–π–º–µ—Ä
```

```java
task.cancel(); // –û—Ç–º–µ–Ω—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–¥–∞—á—É
```



###### üìå –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏

```java
Timer timer = new Timer();
TimerTask task = new TimerTask() {
    public void run() {
        System.out.println("–¢–∏–∫!");
    }
};
timer.scheduleAtFixedRate(task, 0, 2000); // –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
```



###### ‚úÖ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Timer`

üü¢ –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏–µ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
üî¥ **–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç**, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∏ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ–ª–≥–æ –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
üî¥ **–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç** –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ –º–Ω–æ–≥–æ–ø–ª–∞–Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ScheduledExecutorService`





***

# CompletionService



`CompletionService` ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –æ–±–ª–µ–≥—á–∞—é—â–∏–π **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á** —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–ª—É—á–µ–Ω–∏—è **—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –º–µ—Ä–µ –∏—Ö –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏**, –∞ –Ω–µ –≤ –ø–æ—Ä—è–¥–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏.

–û–Ω —Å–æ—á–µ—Ç–∞–µ—Ç –≤ —Å–µ–±–µ:

* **–æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–¥–∞—á** (`ExecutorService`)
* **–ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** (`BlockingQueue`)



###### üîë –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –∫–ª–∞—Å—Å—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                      | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                     |
| ------------------------------ | ------------------------------ |
| `CompletionService<V>`         | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å                      |
| `ExecutorCompletionService<V>` | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è         |
| `ExecutorService`              | –î–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á           |
| `Future<V>`                    | –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏ |



###### üîß –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

–ö–æ–≥–¥–∞ –≤—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á, –æ–Ω–∏ –º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ. `CompletionService` –ø–æ–∑–≤–æ–ª—è–µ—Ç **–∏–∑–≤–ª–µ–∫–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –º–µ—Ä–µ –∏—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**, –∞ –Ω–µ –ø–æ –ø–æ—Ä—è–¥–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏.



###### üîÅ –ß–∞—Å—Ç—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

* –û—Ç–ø—Ä–∞–≤–∏—Ç—å N –∑–∞–¥–∞—á
* –ü–æ–ª—É—á–∞—Ç—å `Future` —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ **–ø–æ –º–µ—Ä–µ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è—Å—å –Ω–∞ –ø–µ—Ä–≤–æ–º



###### üß© –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
ExecutorService executor = Executors.newFixedThreadPool(4);
CompletionService<String> service = new ExecutorCompletionService<>(executor);

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º 10 –∑–∞–¥–∞—á
for (int i = 0; i < 10; i++) {
    int taskId = i;
    service.submit(() -> {
        Thread.sleep((long) (Math.random() * 3000)); // —Å–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        return "Task " + taskId + " done";
    });
}

// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
for (int i = 0; i < 10; i++) {
    Future<String> result = service.take(); // –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ –∑–∞–¥–∞—á–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
    System.out.println(result.get());
}

executor.shutdown();
```



###### üßµ –ú–µ—Ç–æ–¥—ã `CompletionService`

| –ú–µ—Ç–æ–¥                      | –û–ø–∏—Å–∞–Ω–∏–µ                                                |
| -------------------------- | ------------------------------------------------------- |
| `submit(Callable)`         | –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏                                         |
| `submit(Runnable, result)` | –û—Ç–ø—Ä–∞–≤–∫–∞ `Runnable` —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º                       |
| `take()`                   | –ë–ª–æ–∫–∏—Ä—É–µ—Ç, –ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞          |
| `poll()`                   | –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—É—é –∑–∞–¥–∞—á—É, –ª–∏–±–æ `null`   |
| `poll(timeout, unit)`      | –ñ–¥—ë—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`, –µ—Å–ª–∏ –Ω–µ –≥–æ—Ç–æ–≤–æ |



###### üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ `take()` vs `poll()`

| –ú–µ—Ç–æ–¥                 | –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π?      | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç             | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≥–æ—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á              |
| --------------------- | ----------------- | ---------------------- | --------------------------------------------------- |
| `take()`              | ‚úÖ –î–∞              | `Future<V>`            | –ñ–î–Å–¢, –ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç            |
| `poll()`              | ‚ùå –ù–µ—Ç             | `Future<V>` –∏–ª–∏ `null` | –ù–ï –∂–¥–µ—Ç ‚Äî —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—ë—Ç `null`, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç      |
| `poll(timeout, unit)` | ‚è≥ –î–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ) | `Future<V>` –∏–ª–∏ `null` | –ñ–¥–µ—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—Ç–æ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` |



###### üìö –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

`ExecutorCompletionService` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:

1. `Executor` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á
2. `BlockingQueue<Future<V>>` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

–ö–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, `Future` —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –æ—á–µ—Ä–µ–¥—å. –ú–µ—Ç–æ–¥—ã `take()` –∏ `poll()` —á–∏—Ç–∞—é—Ç –∏–∑ —ç—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏.



###### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úî –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å **–º–Ω–æ–∂–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**
‚úî –£–ø—Ä–æ—â–∞–µ—Ç **–æ–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞** –æ—Ç –ø–µ—Ä–≤–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏
‚úî –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –æ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å `Future.isDone()`
‚úî –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç **—Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**



###### ‚ùó –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

‚ö† –ù—É–∂–Ω–æ **—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∑–∞–±–∏—Ä–∞—Ç—å** –≤—Å–µ `Future` –∏ –≤—ã–∑—ã–≤–∞—Ç—å `get()` ‚Äî –∏–Ω–∞—á–µ –≤–æ–∑–º–æ–∂–Ω—ã **—É—Ç–µ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤**
‚ö† –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ExecutorCompletionService`, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∞—Ç—å `ExecutorService`, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è





***

# ThreadLocal



`ThreadLocal<T>` ‚Äî —ç—Ç–æ **—Å–ø–æ—Å–æ–± —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –ª–æ–∫–∞–ª—å–Ω—É—é –¥–ª—è –ø–æ—Ç–æ–∫–∞**, —Ç.–µ. **–∫–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ—é –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π**.

–≠—Ç–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –ø–æ—Ç–æ–∫–∏ **–Ω–µ –¥–æ–ª–∂–Ω—ã –¥–µ–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ** ‚Äî –∫–∞–∂–¥—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å–≤–æ–µ–π "–≤–µ—Ä—Å–∏–µ–π".



###### üìå –ü—Ä–∏–º–µ—Ä:

```java
ThreadLocal<Integer> localValue = ThreadLocal.withInitial(() -> 0);

Runnable task = () -> {
    localValue.set(localValue.get() + 1);
    System.out.println(Thread.currentThread().getName() + ": " + localValue.get());
};

new Thread(task).start();
new Thread(task).start();
```

–ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ —É–≤–∏–¥–∏—Ç **—Å–≤–æ—ë –∑–Ω–∞—á–µ–Ω–∏–µ&#x20;****`localValue`**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥—Ä—É–≥–∏—Ö.



###### ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º?

* –£ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (`Thread`) –µ—Å—Ç—å –ø–æ–ª–µ `threadLocals` (—Ç–∏–ø–∞ `ThreadLocalMap`).
* –ö–æ–≥–¥–∞ —Ç—ã –≤—ã–∑—ã–≤–∞–µ—à—å `threadLocal.set(value)`, –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞** –≤ —ç—Ç–æ–π `ThreadLocalMap`.
* –ö–ª—é—á–æ–º –≤—ã—Å—Ç—É–ø–∞–µ—Ç —Å–∞–º `ThreadLocal`-–æ–±—ä–µ–∫—Ç, –∑–Ω–∞—á–µ–Ω–∏–µ–º ‚Äî —Ç–≤–æ–π –æ–±—ä–µ–∫—Ç.



###### –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

```java
Thread
 ‚îî‚îÄ‚îÄ ThreadLocalMap
       ‚îú‚îÄ‚îÄ Entry(ThreadLocal -> –∑–Ω–∞—á–µ–Ω–∏–µ)
       ‚îî‚îÄ‚îÄ ...
```



###### üß™ –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

| –ú–µ—Ç–æ–¥                      | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                           |
| -------------------------- | -------------------------------------------------------------------- |
| `get()`                    | –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞)         |
| `set(T value)`             | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ                                                  |
| `remove()`                 | –£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞ (–≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫) |
| `withInitial(Supplier<T>)` | –°–æ–∑–¥–∞—ë—Ç `ThreadLocal` —Å –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º                          |



###### ‚úÖ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

* **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –ø–æ—Ç–æ–∫–∞**, –Ω–∞–ø—Ä. `SimpleDateFormat`, `Connection`, `UserContext`
* –í —Ä–∞–º–∫–∞—Ö **—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–ª–æ–≤ –ø–æ—Ç–æ–∫–æ–≤** ‚Äî –∫–æ–≥–¥–∞ —É –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≤–æ–π –æ–±—ä–µ–∫—Ç
* –ü—Ä–∏–º–µ—Ä: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –ø–æ—Ç–æ–∫–∞, —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤



###### ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏:



**üî• –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏**

* `ThreadLocalMap` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å–ª–∞–±—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–ª—é—á–∏** (—á—Ç–æ–±—ã –ø–æ–∑–≤–æ–ª–∏—Ç—å GC —É–¥–∞–ª–∏—Ç—å `ThreadLocal`, –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
* –ù–æ **–∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** ‚Äî –µ—Å–ª–∏ `remove()` –Ω–µ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é, –æ–Ω–∏ –º–æ–≥—É—Ç **–Ω–∞–≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞—Ç—å—Å—è –≤ –ø–æ—Ç–æ–∫–µ** ‚Üí –æ—Å–æ–±–µ–Ω–Ω–æ –æ–ø–∞—Å–Ω–æ –≤ thread pool'–∞—Ö.



**üßº –•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞:**

```java
try {
    threadLocal.set(value);
    // —Ä–∞–±–æ—Ç–∞
} finally {
    threadLocal.remove(); // –≤–∞–∂–Ω–æ!
}
```



###### üì¶ –í–∞—Ä–∏–∞–Ω—Ç—ã:

| –ö–ª–∞—Å—Å                       | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                                                 |
| --------------------------- | ----------------------------------------------------------- |
| `ThreadLocal<T>`            | –û–±—ã—á–Ω–∞—è –≤–µ—Ä—Å–∏—è                                              |
| `InheritableThreadLocal<T>` | –ü–µ—Ä–µ–¥–∞—ë—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ç–æ–º–∫–∞–º (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –¥–æ—á–µ—Ä–Ω–∏–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏) |



###### üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `ThreadLocal` vs —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä        | ThreadLocal                   | synchronized/locks                    |
| --------------- | ----------------------------- | ------------------------------------- |
| –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º | –£ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ç–æ–∫–∞ ‚Äî —Å–≤–æ—è –∫–æ–ø–∏—è | –û–±—â–∏–π –¥–æ—Å—Ç—É–ø (shared state)           |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å    | –ù–µ—Ç –≥–æ–Ω–æ–∫, –Ω–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏  | –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞            |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ   | –ü—Ä–æ—Å—Ç–æ –∏ –±—ã—Å—Ç—Ä–æ               | –ú–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏             |
| –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è    | –•—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ—Ç–æ–∫–µ   | –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –æ–±—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ |



