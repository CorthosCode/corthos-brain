# ‚òï ForkJoinPool ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –∑–∞–¥–∞—á

## üìò –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ

`ForkJoinPool` ‚Äî —ç—Ç–æ **—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤**, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π**, –≥–¥–µ –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å **—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ –ø–æ–¥–∑–∞–¥–∞—á–∏** (fork) –∏ –ø–æ—Ç–æ–º **–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–æ** (join).

–û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–µ:

> *¬´–†–∞–∑–¥–µ–ª—è–π –∏ –≤–ª–∞—Å—Ç–≤—É–π¬ª (divide and conquer).*





***

## ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

* **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ (fork)** ‚Äî –±–æ–ª—å—à–∞—è –∑–∞–¥–∞—á–∞ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –±–æ–ª–µ–µ –º–µ–ª–∫–∏–µ.
* **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** ‚Äî –ø–æ–¥–∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö.
* **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ (join)** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–¥–∑–∞–¥–∞—á –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.



![](assets/C7-oDwYsGh_mUowjN9W7aIL292-Laq6h504AH8eMV6E=.png)





***

## üß© –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã:

| –ö–ª–∞—Å—Å              | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                |
| ------------------ | --------------------------------------------------------- |
| `ForkJoinPool`     | –ü—É–ª –ø–æ—Ç–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º `ForkJoinTask` |
| `ForkJoinTask<V>`  | –ë–∞–∑–æ–≤—ã–π —Ç–∏–ø –∑–∞–¥–∞—á, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö fork/join               |
| `RecursiveTask<V>` | –ó–∞–¥–∞—á–∞ —Å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º                         |
| `RecursiveAction`  | –ó–∞–¥–∞—á–∞ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞                       |





***

## üß± –ü—Ä–∏–º–µ—Ä: RecursiveTask



```java
import java.util.concurrent.*;

class SumTask extends RecursiveTask<Long> {
    private final long[] array;
    private final int start, end;
    private static final int THRESHOLD = 10_000;

    SumTask(long[] array, int start, int end) {
        this.array = array;
        this.start = start;
        this.end = end;
    }

    @Override
    protected Long compute() {
        if (end - start <= THRESHOLD) {
            long sum = 0;
            for (int i = start; i < end; i++) sum += array[i];
            return sum;
        } else {
            int mid = (start + end) / 2;
            SumTask left = new SumTask(array, start, mid);
            SumTask right = new SumTask(array, mid, end);
            left.fork();                // –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            long rightResult = right.compute(); // –≤—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–º –ø–æ—Ç–æ–∫–æ–º
            long leftResult = left.join();      // –∂–¥–µ–º –ª–µ–≤—É—é –∑–∞–¥–∞—á—É
            return leftResult + rightResult;
        }
    }
}

public class ForkJoinExample {
    public static void main(String[] args) {
        long[] numbers = new long[1_000_000];
        ForkJoinPool pool = new ForkJoinPool();
        long sum = pool.invoke(new SumTask(numbers, 0, numbers.length));
        System.out.println("Sum = " + sum);
    }
}
```





***

## üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)

**Work-Stealing (–∫—Ä–∞–∂–∞ —Ä–∞–±–æ—Ç—ã)**

* –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ (`ForkJoinWorkerThread`) –∏–º–µ–µ—Ç **—Å–≤–æ—é –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (deque)**.
* –ü–æ—Ç–æ–∫ **–≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –≥–æ–ª–æ–≤—ã —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏**.
* –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–µ—Ç ‚Äî –æ–Ω **–∫—Ä–∞–¥—ë—Ç –∑–∞–¥–∞—á—É** –∏–∑ **—Ö–≤–æ—Å—Ç–∞** —á—É–∂–æ–π –æ—á–µ—Ä–µ–¥–∏.

–≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ –∏ —É–ª—É—á—à–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∑–∞–≥—Ä—É–∑–∫–∏.





***

## ‚öôÔ∏è –ú–µ—Ç–æ–¥—ã ForkJoinTask

| –ú–µ—Ç–æ–¥                     | –û–ø–∏—Å–∞–Ω–∏–µ                                           |
| ------------------------- | -------------------------------------------------- |
| `fork()`                  | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á—É                        |
| `join()`                  | –û–∂–∏–¥–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç   |
| `invoke()`                | –°–æ—á–µ—Ç–∞–µ—Ç fork –∏ join ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏ –∂–¥—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ |
| `compute()`               | –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Å –ª–æ–≥–∏–∫–æ–π –∑–∞–¥–∞—á–∏                    |
| `invokeAll(task1, task2)` | –£–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É –¥–≤–µ –∑–∞–¥–∞—á–∏          |





***

## üßÆ –í–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `ForkJoinPool`

```java
ForkJoinPool pool = new ForkJoinPool(
    parallelism,          // —É—Ä–æ–≤–µ–Ω—å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ (–æ–±—ã—á–Ω–æ = —á–∏—Å–ª—É —è–¥–µ—Ä)
    factory,              // —Ñ–∞–±—Ä–∏–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    handler,              // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    asyncMode             // true ‚Äî LIFO, false ‚Äî FIFO
);
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `parallelism = Runtime.getRuntime().availableProcessors()`





***

## ‚öñÔ∏è ForkJoinPool vs ThreadPoolExecutor

| –ö—Ä–∏—Ç–µ—Ä–∏–π           | ForkJoinPool                        | ThreadPoolExecutor           |
| ------------------ | ----------------------------------- | ---------------------------- |
| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ         | –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è | –û–±—ã—á–Ω—ã–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–¥–∞—á–∏   |
| –ê–ª–≥–æ—Ä–∏—Ç–º           | Work-stealing                       | –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (FIFO)         |
| –ó–∞–¥–∞—á–∏             | `RecursiveTask` / `RecursiveAction` | `Runnable` / `Callable`      |
| –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å | –ü–æ—Ç–æ–∫–∏ –∫—Ä–∞–¥—É—Ç –∑–∞–¥–∞—á–∏ –¥—Ä—É–≥ —É –¥—Ä—É–≥–∞   | –ü–æ—Ç–æ–∫–∏ –∂–¥—É—Ç –∏–∑ –æ–±—â–µ–π –æ—á–µ—Ä–µ–¥–∏ |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –¥–ª—è CPU-bound –∑–∞–¥–∞—á   | –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è IO-bound        |





***

## üß† –ü–æ—á–µ–º—É ForkJoinPool –±—ã—Å—Ç—Ä–µ–µ?

* **–ú–µ–Ω—å—à–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏** ‚Äî –∫–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥—å—é.
* **Work-stealing** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É.
* **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç "—Ç–æ–Ω–∫–∏–µ" –∑–∞–¥–∞—á–∏**, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
* –ó–∞–¥–∞—á–∏ —á–∞—Å—Ç–æ **–≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ —è–¥—Ä–µ** (cache locality).





***

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏:

* ‚ùó –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–¥–æ–ª–≥–∏—Ö –∏–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (I/O, sleep)** ‚Äî –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é –ø–æ—Ç–æ–∫–æ–≤.
* –ù–µ —Å—Ç–æ–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `synchronized` –≤–Ω—É—Ç—Ä–∏ `compute()` ‚Äî —É–º–µ–Ω—å—à–∏—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
* –ü–æ—Ç–æ–∫–∏ ForkJoinPool ‚Äî —ç—Ç–æ **daemon threads**, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∂–∏–≤—ã–µ.
* –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ ‚Äî –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ManagedBlocker`.





***

## üß© –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `ManagedBlocker` (–¥–ª—è I/O):

```java
ForkJoinPool.managedBlock(new ForkJoinPool.ManagedBlocker() {
    boolean isDone = false;

    @Override
    public boolean block() throws InterruptedException {
        // –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
        doIO();
        isDone = true;
        return true;
    }

    @Override
    public boolean isReleasable() {
        return isDone;
    }
});
```

–ü–æ–∑–≤–æ–ª—è–µ—Ç ForkJoinPool **–¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏**, –µ—Å–ª–∏ —á–∞—Å—Ç—å –∏–∑ –Ω–∏—Ö –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞.



