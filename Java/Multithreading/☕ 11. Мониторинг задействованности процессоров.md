# ☕ Мониторинг задействованности процессоров

Во время тестирования на масштабируемость целью обычно является поддержание процессоров в полностью задейстованном состоянии. Такие инструменты, как **`vmstat`** и **`mpstat`** в системах Unix или **`perfmon`** в системах Windows, могут сообщить вам, насколько «горячими» процессоры являются во время работы.

Если процессоры используются асимметрично (некоторые процессоры работают на повышенной температуре, а другие — нет), то первой целью должна состоять в том, чтобы найти в программе повышенный параллелизм. Асимметричная задействованность означает, что бо́льшая часть вычислений происходит в небольшом наборе потоков, и ваше приложение не сможет воспользоваться преимуществами дополнительных процессоров.

Если процессоры задействованы не полностью, то вам необходимо выяснить причину. Существует несколько вероятных причин:

**Недостаточная нагрузка.** Возможно, тестируемое приложение просто не подвергается достаточной нагрузке. Это можно проверить путём увеличения нагрузки и измерения изменений в задействованности, времени отклика или времени обслуживания. Создание достаточной нагрузки для насыщения приложения может потребовать значительной компьютерной мощности; проблема может заключаться в том, что на пределе возможностей работает не тестируемая система, а клиентские системы.

**Привязанность к вводу-выводу.** С помощью **`iostat`** или **`perfmon`** вы можете установить, привязано ли приложение к диску, а также путём мониторинга уровня трафика в сети выяснить, ограничена ли нет пропускная способность.

**Внешняя ограниченность.** Если приложение зависит от внешних служб, таких как база данных или веб-служба, то узкое место, возможно, находится не в вашем коде. Это можно проверить с помощью профилировщика или средств администрирования баз данных, которые позволят определить, сколько времени тратится на ожидание откликов от внешних служб.

**Конфликт блокировки.** Средства профилирования могут указать на то, сколько в приложении возникает конфликта блокировки и какие замки являются «горячими». Часто можно получить ту же информацию без профилировщика путём случайной выборки, запустив несколько поточных дампов и произведя поиск потоков, конфликтующих за замки. Если поток блокирован в ожидании замка, то соответствующий стековый фрейм в поточном дампе выдает сообщение «ожидание замкового монитора...» (waiting to lock monitor). Замки, за которые в основном нет конфликта, появляются в поточном дампе редко; сильно оспариваемые замки почти всегда имеют хотя бы один поток, который ожидает его приобретения, и потому появляются в поточных дампах часто.

Если ваше приложение поддерживает процессоры в достаточно «горячем» состоянии, то вы можете применить средства мониторинга, чтобы определить полезность для него дополнительных процессоров. Программа, имеющая только четыре потока, возможно, будет задействовать 4-ядерную систему полностью, но вряд ли увидит повышение производительности при переходе на 8-ядерную систему, так как там ей придется ждать, когда работоспособные потоки воспользуются преимуществами дополнительных процессоров. (Вы также можете переконфигурировать программу с целью разделить её рабочую нагрузку на большее число потоков, например, настроив размер поточного пула.)

Одним из столбцов, о котором сообщает **`vmstat`**, является число потоков, которые работоспособны, но не работают в данный момент, поскольку нет в наличии процессора. Если использование процессора высоко и всегда имеются работоспособные потоки, ожидающие процессор, то от большего числа процессоров ваше приложение, скорее всего, выиграет.



