# ‚òï –í—ã–∫–ª—é—á–µ–Ω–∏–µ JVM

###### –¢–∏–ø—ã –≤—ã–∫–ª—é—á–µ–Ω–∏—è JVM

**1. –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ ( orderly shutdown )**

* `System.exit()`
* –ü–æ—Å–ª–µ–¥–Ω–∏–π –Ω–µ-–¥–µ–º–æ–Ω –ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª `Ctrl+C` (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω)

**2. –ë—ã—Å—Ç—Ä–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ ( quick shutdown )**

* `SIGKILL` (kill -9)
* –û—à–∏–±–∫–∞ JVM
* –í—ã–∑–æ–≤ `Runtime.halt()`

**3. –ê–≤–∞—Ä–∏–π–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ ( abrupt termination )**

* –û—à–∏–±–∫–∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
* –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Å–±–æ–∏
* `SIGKILL`



###### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –≤—ã–∫–ª—é—á–µ–Ω–∏—è

```shellscript
[JVM —Ä–∞–±–æ—Ç–∞–µ—Ç] 
      ‚Üì
[–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è]
      ‚Üì
[–ó–∞–ø—Ä–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á]
      ‚Üì
[–ó–∞–ø—É—Å–∫ shutdown hooks] ‚Üí [–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ]
      ‚Üì
[–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ-–¥–µ–º–æ–Ω –ø–æ—Ç–æ–∫–æ–≤]
      ‚Üì
[JVM –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è]
```



###### Shutdown Hooks

–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ JVM. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –æ—á–∏—Å—Ç–∫–∏.

```java
Runtime.getRuntime().addShutdownHook(new Thread(() -> {
    System.out.println("üßπ Shutdown hook –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...");
    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
    cleanup();
}));
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ shutdown hooks:**

* üîÑ **–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
* ‚ö†Ô∏è **–ò—Å–∫–ª—é—á–µ–Ω–∏—è:** –ï—Å–ª–∏ hook –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –æ–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
* üö´ **Deadlock:** –ú–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ hook –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ—Å—É—Ä—Å—ã
* üö´ **–ù–µ–ª—å–∑—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:** –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ shutdown hooks –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å



###### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è shutdown hooks

```java
public class ShutdownHookExample {
    private static final Logger logger = LoggerFactory.getLogger(ShutdownHookExample.class);
    
    public static void main(String[] args) {
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è shutdown hook
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            logger.info("üßπ –ù–∞—á–∏–Ω–∞–µ–º –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤...");
            cleanupResources();
            logger.info("‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
        }));
        
        // –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞
        doWork();
    }
    
    private static void doWork() {
        // –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
        while (!Thread.currentThread().isInterrupted()) {
            try {
                Thread.sleep(1000);
                System.out.println("_working...");
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
    }
    
    private static void cleanupResources() {
        // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
        System.out.println("–û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã...");
    }
}
```



###### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è

**1. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤**

```java
public class GracefulShutdown {
    private final ExecutorService executor = Executors.newFixedThreadPool(10);
    
    public void shutdown() throws InterruptedException {
        // –ó–∞–ø—Ä–µ—â–∞–µ–º –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
        executor.shutdown();
        
        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–¥–∞—á
        if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º
            executor.shutdownNow();
            
            // –ñ–¥–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                System.err.println("Pool did not terminate");
            }
        }
    }
}
```



**2. –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**

```java
public class CancellableTask implements Runnable {
    private volatile boolean cancelled = false;
    
    @Override
    public void run() {
        while (!cancelled && !Thread.currentThread().isInterrupted()) {
            // –†–∞–±–æ—Ç–∞
            doWork();
        }
    }
    
    public void cancel() {
        cancelled = true;
    }
}
```



**3. Poison Pill**

```java
public class PoisonPillExample {
    private final BlockingQueue<Task> queue = new LinkedBlockingQueue<>();
    
    // –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å
    public void produce() {
        queue.put(new Task());
        // –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º "—è–¥"
        queue.put(POISON_PILL);
    }
    
    // –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å
    public void consume() {
        while (true) {
            Task task = queue.take();
            if (task == POISON_PILL) {
                break; // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
            }
            processTask(task);
        }
    }
    
    private static final Task POISON_PILL = new Task();
}
```



###### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–∏—è

```java
@Test
public void testGracefulShutdown() throws InterruptedException {
    ExecutorService executor = Executors.newFixedThreadPool(2);
    CountDownLatch latch = new CountDownLatch(1);
    
    executor.submit(() -> {
        try {
            Thread.sleep(5000); // –î–æ–ª–≥–∞—è –∑–∞–¥–∞—á–∞
        } catch (InterruptedException e) {
            // –û–∂–∏–¥–∞–µ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
        } finally {
            latch.countDown();
        }
    });
    
    // –ò–º–∏—Ç–∏—Ä—É–µ–º –≤—ã–∫–ª—é—á–µ–Ω–∏–µ
    executor.shutdown();
    assertTrue(executor.awaitTermination(10, TimeUnit.SECONDS));
    assertEquals(0, latch.getCount());
}
```



###### –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

**‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. –í—Å–µ–≥–¥–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ shutdown hooks –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ try-with-resources –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
3. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ interrupted status –≤ —Ü–∏–∫–ª–∞—Ö
4. –ò–∑–±–µ–≥–∞–π—Ç–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –≤ shutdown hooks
5. –ë—ã—Å—Ç—Ä–æ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ cleanup –≤ shutdown hooks



**‚ùå –ê–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã:**

1. –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ shutdown hooks
2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –≤ shutdown hooks
3. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É–∂–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã
4. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ InterruptedException



###### –ü–æ—Ç–æ–∫–∏-–¥–µ–º–æ–Ω—ã

–û–±—ã—á–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∏ –¥–µ–º–æ–Ω—ã –æ—Ç–ª–∏—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏ —Å–≤–æ–µ–≥–æ –≤—ã—Ö–æ–¥–∞. –ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ –≤—ã—Ö–æ–¥–∏—Ç, JVM –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é –∑–∞–ø—É —â–µ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤. –ï—Å–ª–∏ –æ–Ω–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç, —á—Ç–æ –æ—Å—Ç–∞–ª–∏—Å—å —Ç–æ–ª—å–∫–æ –¥–µ–º–æ–Ω—ã, –æ–Ω–∞ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ. –ö–æ–≥–¥–∞ JVM –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –≤—Å–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ—Ç–æ–∫–∏-–¥–µ–º–æ–Ω—ã –ø–æ–∫–∏–¥–∞—é—Ç—Å—è - –±–ª–æ–∫–∏ finally –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è, —Å—Ç–µ–∫–∏ –Ω–µ —Ä–∞–∑–º–∞—Ç—ã–≤–∞—é—Ç—Å—è, JVM –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏—Ç.



