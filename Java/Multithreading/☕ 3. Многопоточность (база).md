
# –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤

Java-–ø–æ—Ç–æ–∫–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ **—Å–æ—Å—Ç–æ—è–Ω–∏—è**, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –≤ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–∏ `java.lang.Thread.State`.

###### üìå –ü–µ—Ä–µ—á–µ–Ω—å –°–æ—Å—Ç–æ—è–Ω–∏–π –ü–æ—Ç–æ–∫–∞ (`Thread.State`)

| –°–æ—Å—Ç–æ—è–Ω–∏–µ       | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                     |
| --------------- | -------------------------------------------------------------------------------------------- |
| `NEW`           | –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω, –Ω–æ –µ—â—ë **–Ω–µ –∑–∞–ø—É—â–µ–Ω** (`start()`–Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è)                                  |
| `RUNNABLE`      | –ü–æ—Ç–æ–∫ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–±—Ä–∞–Ω –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º                                   |
| `BLOCKED`       | –ü–æ—Ç–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç **–º–æ–Ω–∏—Ç–æ—Ä –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `synchronized`)            |
| `WAITING`       | –ü–æ—Ç–æ–∫ –∂–¥—ë—Ç, –ø–æ–∫–∞ **–¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –µ–≥–æ –Ω–µ —Ä–∞–∑–±—É–¥–∏—Ç** (`wait()`, `join()`, `LockSupport.park()`) |
| `TIMED_WAITING` | –ü–æ—Ç–æ–∫ –∂–¥—ë—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è (`sleep()`, `wait(timeout)`, `join(timeout)`)                  |
| `TERMINATED`    | –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏–ª–∏ —á–µ—Ä–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)                                   |

###### üìå –ú–µ—Ç–æ–¥—ã –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

```java
Thread.State state = thread.getState();
System.out.println("–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ç–æ–∫–∞: " + state);
```

###### üîÅ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–æ—Ç–æ–∫–∞ (—Å–æ—Å—Ç–æ—è–Ω–∏—è + –ø–µ—Ä–µ—Ö–æ–¥—ã)

```
     NEW
      |
   start()
      ‚Üì
  RUNNABLE ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê
      ‚Üì      ‚Üë            ‚Üë             ‚Üë
      ‚Üì      ‚Üë            ‚Üë             ‚Üë
   BLOCKED   ‚Üë      WAITING / TIMED_WAITING
      ‚Üì      ‚Üì            ‚Üì             ‚Üì
      ‚Üì   lock –ø–æ–ª—É—á–µ–Ω   notify()/timeout
      ‚Üì
 TERMINATED (–ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ run())
```

###### üìÇ –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–¥—Ä–æ–±–Ω–æ

`NEW`

* –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω: `Thread t = new Thread(...)`
* –ú–µ—Ç–æ–¥ `start()` **–µ—â—ë –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è**

`RUNNABLE`

* –ü–æ—Ç–æ–∫ **–≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é** (–Ω–æ –º–æ–∂–µ—Ç –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è)
* –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –û–° —Ä–µ—à–∞–µ—Ç, –∫–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ –æ–Ω –±—É–¥–µ—Ç "–±–µ–∂–∞—Ç—å"

`BLOCKED`

* –ü–æ—Ç–æ–∫ –ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ–π—Ç–∏ –≤ **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫**, –Ω–æ **–º–æ–Ω–∏—Ç–æ—Ä –∑–∞–Ω—è—Ç**
* –í–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ `synchronized`, –µ—Å–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä —É–∂–µ –∑–∞—Ö–≤–∞—á–µ–Ω –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º

`WAITING`

* –ü–æ—Ç–æ–∫ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω **–Ω–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è**, –ø–æ–∫–∞ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –µ–≥–æ –Ω–µ "—Ä–∞–∑–±—É–¥–∏—Ç"
* –ú–µ—Ç–æ–¥—ã:
  * `Object.wait()`
  * `Thread.join()`
  * `LockSupport.park()`

`TIMED_WAITING`

* –¢–æ –∂–µ, —á—Ç–æ –∏ `WAITING`, –Ω–æ **—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏**
* –ú–µ—Ç–æ–¥—ã:
  * `Thread.sleep(milliseconds)`
  * `Object.wait(milliseconds)`
  * `Thread.join(milliseconds)`
  * `LockSupport.parkNanos()`,`parkUntil()`

`TERMINATED`

* –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
  * –ù–æ—Ä–º–∞–ª—å–Ω–æ (–∑–∞–∫–æ–Ω—á–∏–ª`run()`)
  * –° –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º
* –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –º–µ—Ç–æ–¥–æ–º: `thread.getState() == Thread.State.TERMINATED`

###### üß© –ú–µ—Ç–æ–¥—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

| –ú–µ—Ç–æ–¥                    | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                              | –°–æ—Å—Ç–æ—è–Ω–∏–µ                                             |
| ------------------------ | --------------------------------------- | ----------------------------------------------------- |
| `start()`                | –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ—Ç–æ–∫                         | `NEW ‚Üí RUNNABLE`                                      |
| `sleep(ms)`              | –ó–∞—Å—ã–ø–∞–µ—Ç –Ω–∞ –≤—Ä–µ–º—è                       | `RUNNABLE ‚Üí TIMED_WAITING`                            |
| `join()`                 | –ñ–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ –ø–æ—Ç–æ–∫–∞          | `RUNNABLE ‚Üí WAITING/TIMED_WAITING`                    |
| `wait()`                 | –ñ–¥—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                        | `RUNNABLE ‚Üí WAITING`                                  |
| `notify()`/`notifyAll()` | –ü—Ä–æ–±—É–∂–¥–∞—é—Ç `WAITING`-–ø–æ—Ç–æ–∫–∏             | `WAITING ‚Üí RUNNABLE`                                  |
| `synchronized`           | –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É                | `RUNNABLE ‚Üí BLOCKED`                                  |
| `interrupt()`            | –ü—Ä–µ—Ä—ã–≤–∞–µ—Ç `sleep()`, `wait()`, `join()` | –ü–µ—Ä–µ—Ö–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ –≤ `RUNNABLE` —Å `InterruptedException` |
| `run()` –∑–∞–≤–µ—Ä—à–∏–ª—Å—è       | –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è                       | `‚Üí TERMINATED`                                        |

###### üß™ –ü—Ä–∏–º–µ—Ä—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π


–ü—Ä–∏–º–µ—Ä 1: `NEW ‚Üí RUNNABLE ‚Üí TERMINATED`

```java
Thread t = new Thread(() -> System.out.println("Hello"));
System.out.println(t.getState()); // NEW
t.start();
System.out.println(t.getState()); // RUNNABLE –∏–ª–∏ TERMINATED
```


–ü—Ä–∏–º–µ—Ä 2: `TIMED_WAITING` —á–µ—Ä–µ–∑ `sleep(timeout)`

```java
Thread t = new Thread(() -> {
    try {
        Thread.sleep(5000);
    } catch (InterruptedException e) {}
});
t.start();
Thread.sleep(100); // –ü–æ–¥–æ–∂–¥—ë–º —á—É—Ç—å-—á—É—Ç—å
System.out.println(t.getState()); // TIMED_WAITING
```


–ü—Ä–∏–º–µ—Ä 3: `WAITING` —á–µ—Ä–µ–∑ `join()`

```java
Thread t = new Thread(() -> {
    try {
        Thread.sleep(3000);
    } catch (InterruptedException e) {}
});
t.start();
t.join(); // –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –≤ WAITING
```


–ü—Ä–∏–º–µ—Ä 4: `BLOCKED`

```java
Object lock = new Object();

Thread t1 = new Thread(() -> {
    synchronized (lock) {
        try { Thread.sleep(3000); } catch (InterruptedException e) {}
    }
});

Thread t2 = new Thread(() -> {
    synchronized (lock) {
        System.out.println("t2: –ø–æ–ª—É—á–∏–ª –º–æ–Ω–∏—Ç–æ—Ä");
    }
});

t1.start();
Thread.sleep(100); // –¥–∞—ë–º t1 –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä
t2.start();
Thread.sleep(100); // –¥–∞—ë–º t2 –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–æ–π—Ç–∏

System.out.println(t2.getState()); // BLOCKED
```


###### üìä –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –º–µ—Ç–æ–¥–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π

| –ú–µ—Ç–æ–¥              | –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ              | –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ                     |
| ------------------ | ------------------------- | ----------------------------------- |
| `start()`          | `NEW`                     | `RUNNABLE`                          |
| `sleep()`          | `RUNNABLE`                | `TIMED_WAITING`                     |
| `join()`           | `RUNNABLE`                | `WAITING`/`TIMED_WAITING`           |
| `wait()`           | `RUNNABLE`                | `WAITING`                           |
| `interrupt()`      | `WAITING`/`TIMED_WAITING` | `RUNNABLE` + `InterruptedException` |
| `run()` –∑–∞–∫–æ–Ω—á–∏–ª—Å—è | –õ—é–±–æ–µ                     | `TERMINATED`                        |


###### üß† –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

* –°–æ—Å—Ç–æ—è–Ω–∏–µ `RUNNABLE` ‚Äî –Ω–µ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –ø–æ—Ç–æ–∫ **–∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å**. –û–Ω **–≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É**, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ –≤ –ø—É–ª–µ.
* –°–æ—Å—Ç–æ—è–Ω–∏–µ `BLOCKED` –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å `synchronized`, –Ω–µ —Å `Lock`.
* `WAITING` –∏ `TIMED_WAITING` ‚Äî **—Ä–∞–∑–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è**. –ü–µ—Ä–≤–æ–µ —Ç—Ä–µ–±—É–µ—Ç —è–≤–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –≤—Ç–æ—Ä–æ–µ ‚Äî –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –ø–æ —Ç–∞–π–º–µ—Ä—É.
* `TERMINATED` ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –Ω–µ–ª—å–∑—è.


###### üìù –°–æ—Å—Ç–æ—è–Ω–∏–µ `BLOCKED` –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å `synchronized`, –Ω–µ —Å `Lock`.

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class NoBlockedWithLock {
    private static final Lock lock = new ReentrantLock();

    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            lock.lock();
            try {
                System.out.println("T1: –ó–∞—Ö–≤–∞—Ç–∏–ª lock –∏ —Å–ø–∏—Ç...");
                Thread.sleep(5000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } finally {
                lock.unlock();
            }
        });

        Thread t2 = new Thread(() -> {
            System.out.println("T2: –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock...");
            lock.lock();
            try {
                System.out.println("T2: –ó–∞—Ö–≤–∞—Ç–∏–ª lock");
            } finally {
                lock.unlock();
            }
        });

        t1.start();
        Thread.sleep(100); // –î–∞—ë–º t1 –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock

        t2.start();
        Thread.sleep(100); // –î–∞—ë–º t2 –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å lock

        System.out.println("T2 state: " + t2.getState()); // NOT BLOCKED ‚Äî –æ–±—ã—á–Ω–æ RUNNABLE
    }
}
```

–ü–æ—Ç–æ–∫ `t2`, –æ–∂–∏–¥–∞—è `lock.lock()`, –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ `BLOCKED`, –∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `RUNNABLE`, –ø–æ—Ç–æ–º—É —á—Ç–æ `Lock` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ user-space (–Ω–∞ —É—Ä–æ–≤–Ω–µ Java), –∞ –Ω–µ —á–µ—Ä–µ–∑ `synchronized`/–º–æ–Ω–∏—Ç–æ—Ä JVM.


***

# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ—Ç–æ–∫–æ–≤


–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ—Ç–æ–∫–∞ (Thread Priority) ‚Äî —ç—Ç–æ —á–∏—Å–ª–æ–≤–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫—É (scheduler), –Ω–∞—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–µ–Ω –ø–æ—Ç–æ–∫ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –¥—Ä—É–≥–∏–º–∏.

–≠—Ç–æ –ª–∏—à—å –Ω–∞–º—ë–∫, –∞ –Ω–µ —Å—Ç—Ä–æ–≥–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è!

‚ùó –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω—É–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å **–¥–æ –≤—ã–∑–æ–≤–∞** `start()`.


###### üî¢ –î–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

–í Java –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ—Ç–æ–∫–æ–≤ ‚Äî —ç—Ç–æ —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ –æ—Ç **1 –¥–æ 10**:

| –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞              | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                      |
| ---------------------- | -------- | ------------------------------- |
| `Thread.MIN_PRIORITY`  | 1        | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç           |
| `Thread.NORM_PRIORITY` | 5        | –û–±—ã—á–Ω—ã–π (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π) –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
| `Thread.MAX_PRIORITY`  | 10       | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç          |


###### üìå –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

```java
Thread t = new Thread(() -> {
    // –∫–æ–¥ –ø–æ—Ç–æ–∫–∞
});
t.setPriority(Thread.MAX_PRIORITY); // 10
```


###### üìç –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

```java
int p = t.getPriority();
System.out.println("Priority: " + p);
```


###### ü§ñ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫?

Java –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ—Ç–æ–∫–æ–≤ (Thread Scheduler)**, –∫–æ—Ç–æ—Ä—ã–π **–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã**.

| –û–°      | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–æ–∂–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç? |
| ------- | -------------------------------------- |
| Windows | –î–∞ (–≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ—Ä—è–¥–æ–∫)                 |
| Linux   | –ù–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç)          |
| macOS   | –ß–∞—Å—Ç–∏—á–Ω–æ                               |


###### üß† –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å

* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç**, —á—Ç–æ –ø–æ—Ç–æ–∫ —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º **–±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–µ—Ä–≤—ã–º –∏–ª–∏ —á–∞—â–µ**.
* –ü–æ—Ç–æ–∫–∏ **–º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã—Ç–µ—Å–Ω–µ–Ω—ã** –∏–ª–∏ **–Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è**, –¥–∞–∂–µ —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º, –µ—Å–ª–∏ –û–° –∏—Ö –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç.
* –õ—É—á—à–µ –Ω–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `Executors`, `Locks`, `Semaphore`, –∏ —Ç. –¥.


###### üß™ –ü—Ä–∏–º–µ—Ä: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

```java
public class PriorityTest {
    public static void main(String[] args) {
        Runnable r = () -> {
            for (int i = 0; i < 5; i++) {
                System.out.println(Thread.currentThread().getName() + " - " + i);
            }
        };

        Thread low = new Thread(r, "LOW");
        Thread high = new Thread(r, "HIGH");

        low.setPriority(Thread.MIN_PRIORITY);   // 1
        high.setPriority(Thread.MAX_PRIORITY);  // 10

        low.start();
        high.start();
    }
}
```


###### üîÑ –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

–ö–æ–≥–¥–∞ –≤—ã —Å–æ–∑–¥–∞—ë—Ç–µ –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫, –æ–Ω **–Ω–∞—Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** –æ—Ç –ø–æ—Ç–æ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –µ–≥–æ —Å–æ–∑–¥–∞–ª:

```java
Thread.currentThread().setPriority(7);
Thread t = new Thread(() -> {});
System.out.println(t.getPriority()); // 7
```


###### ‚ö†Ô∏è –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç **–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–æ–ª–∏—Ç–∏–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (****`SecurityManager`****)**.
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –≤—Å–µ–º –ø–æ—Ç–æ–∫–∞–º –º–æ–∂–µ—Ç **–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏ —Å –Ω–∏–∑–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º** (–≤ Windows).
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ ‚Äî **–∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω**, –µ—Å–ª–∏ –≤—ã –Ω–∞–¥–µ–µ—Ç–µ—Å—å –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Ä—è–¥–∫–∞.


***

# –ü–æ—Ç–æ–∫–∏-–¥–µ–º–æ–Ω—ã


###### üß† –ß—Ç–æ —Ç–∞–∫–æ–µ –ø–æ—Ç–æ–∫-–¥–µ–º–æ–Ω?

**–ü–æ—Ç–æ–∫-–¥–µ–º–æ–Ω (daemon thread)** ‚Äî —ç—Ç–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –∏ **–Ω–µ –º–µ—à–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã Java-–ø—Ä–æ–≥—Ä–∞–º–º—ã**.

–¢–∞–∫–∏–µ –ø–æ—Ç–æ–∫–∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã –¥–ª—è **–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è** –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–æ–∫–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä:

* –°–±–æ—Ä –º—É—Å–æ—Ä–∞
* –¢–∞–π–º–µ—Ä—ã
* –õ–æ–≥–≥–µ—Ä—ã
* –§–æ–Ω–æ–≤—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏


###### üõ†Ô∏è –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫-–¥–µ–º–æ–Ω?

–ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø–æ—Ç–æ–∫ –¥–µ–º–æ–Ω–æ–º:

```java
Thread t = new Thread(...);
t.setDaemon(true); // –í–ê–ñ–ù–û: –¥–æ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Ç–æ–∫–∞!
t.start();
```

> ‚ö†Ô∏è –ï—Å–ª–∏ –≤—ã–∑–≤–∞—Ç—å `setDaemon(true)` –ø–æ—Å–ª–µ `start()`,  –±—É–¥–µ—Ç `IllegalThreadStateException`.


###### üõ†Ô∏è –ü—Ä–∏–º–µ—Ä –ø–æ—Ç–æ–∫–∞-–¥–µ–º–æ–Ω–∞:

```java
public class DaemonExample {
    public static void main(String[] args) {
        Thread daemon = new Thread(() -> {
            while (true) {
                System.out.println("–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞...");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    break;
                }
            }
        });

        daemon.setDaemon(true); // –æ–±–æ–∑–Ω–∞—á–∞–µ–º –∫–∞–∫ –¥–µ–º–æ–Ω
        daemon.start();

        try {
            Thread.sleep(3000); // –ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–∏–≤–µ—Ç 3 —Å–µ–∫
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println("main –∑–∞–≤–µ—Ä—à—ë–Ω");
    }
}
```

> ‚öôÔ∏è –î–µ–º–æ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è `main`.


###### üîç –†–∞–∑–Ω–∏—Ü–∞: –ø–æ—Ç–æ–∫-–¥–µ–º–æ–Ω vs –æ–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫

| üßµ –°–≤–æ–π—Å—Ç–≤–æ                            | üü¢ –û–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫ | üîµ –ü–æ—Ç–æ–∫-–¥–µ–º–æ–Ω                 |
| -------------------------------------- | ---------------- | ------------------------------ |
| JVM –∂–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞             | ‚úÖ –î–∞             | ‚ùå –ù–µ—Ç                          |
| –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ | ‚úÖ –î–∞             | ‚ùå –ù–µ—Ç (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏) |
| –ó–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ `main`      | ‚ùå –ù–µ—Ç            | ‚úÖ –î–∞                           |
| –ù—É–∂–Ω–æ —è–≤–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å               | ‚úÖ –î–∞             | ‚ùå –ù–µ—Ç (–µ—Å–ª–∏ `main` –∑–∞–≤–µ—Ä—à—ë–Ω)   |


###### üîÑ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ—Ç–æ–∫–∏: –∫—Ç–æ –∫–æ–≥–æ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å?

üîµ –î–µ–º–æ–Ω —Å–æ–∑–¥–∞—ë—Ç –ø–æ—Ç–æ–∫:

* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é **–ø–æ—Ç–æ–º–æ–∫ —Ç–æ–∂–µ —Å—Ç–∞–Ω–µ—Ç –¥–µ–º–æ–Ω–æ–º**.
* –ï—Å–ª–∏ –Ω—É–∂–µ–Ω **–æ–±—ã—á–Ω—ã–π** –ø–æ—Ç–æ–∫ ‚Äî –Ω–∞–¥–æ –∑–∞–¥–∞—Ç—å —è–≤–Ω–æ:

```java
child.setDaemon(false);
```

üü¢ –û–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞—ë—Ç –¥–µ–º–æ–Ω:

* –ú–æ–∂–Ω–æ: —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫, –∑–∞–¥–∞—Ç—å `setDaemon(true)` ‚Äî –∏ –æ–Ω —Å—Ç–∞–Ω–µ—Ç –¥–µ–º–æ–Ω–æ–º.


###### üí° –ü—Ä–∏–º–µ—Ä: –¥–µ–º–æ–Ω —Å–æ–∑–¥–∞—ë—Ç –æ–±—ã—á–Ω—ã–π –ø–æ—Ç–æ–∫

```java
Thread daemon = new Thread(() -> {
    Thread child = new Thread(() -> {
        System.out.println("–†–µ–±—ë–Ω–æ–∫-–¥–µ–º–æ–Ω? " + Thread.currentThread().isDaemon());
    });
    child.setDaemon(false); // –¥–µ–ª–∞–µ–º –æ–±—ã—á–Ω—ã–º
    child.start();
});

daemon.setDaemon(true);
daemon.start();
```


###### üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏-–¥–µ–º–æ–Ω–∞–º–∏

–¢—ã –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ –º–µ—Ç–æ–¥—ã, —á—Ç–æ –∏ —Å –æ–±—ã—á–Ω—ã–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏:

* `start()`
* `interrupt()`
* `join()`

–ù–æ:

‚ö†Ô∏è –ü–æ—Ç–æ–∫–∏-–¥–µ–º–æ–Ω—ã **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏**‚Äî –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã JVM –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤—Å–µ—Ö –æ–±—ã—á–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤.


***

# interrupt() –∏ interrupted(), –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è


###### üö¶ –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

`Thread.currentThread().interrupt()` - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞.

`Thread.interrupted()` - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞.

`Thread.currentThread().isInterrupted()` - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–ª–∞–≥ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞.


###### üò¥ –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è —Å–Ω–∞ (`Thread.sleep()`):

–ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ "—Å–ø–∏—Ç" –∏ –µ–≥–æ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç (–¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç —É –Ω–µ–≥–æ `interrupt()`):

```java
try {
    Thread.sleep(1000);
} catch (InterruptedException e) {
    // –ó–¥–µ—Å—å —Ñ–ª–∞–≥ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —É–∂–µ –°–ë–†–û–®–ï–ù
    Thread.currentThread().interrupt(); // <- –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
}

```

‚ö†Ô∏è –ü–æ—Å–ª–µ `InterruptedException` —Ñ–ª–∞–≥ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è. –ï—Å–ª–∏ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ‚Äî —Ü–∏–∫–ª –ø–æ `isInterrupted()` –º–æ–∂–µ—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è.


###### üõ†Ô∏è –ü—Ä–∏–º–µ—Ä: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –ø–æ—Ç–æ–∫–∞

```java
public class InterruptExample {

    public static void main(String[] args) throws InterruptedException {
        // –°–æ–∑–¥–∞—ë–º –ø–æ—Ç–æ–∫
        Thread worker = new Thread(() -> {
            while (!Thread.currentThread().isInterrupted()) {
                try {
                    System.out.println("–†–∞–±–æ—Ç–∞—é...");
                    Thread.sleep(1000); // –ü–æ—Ç–æ–∫ "—Å–ø–∏—Ç"
                } catch (InterruptedException e) {
                    System.out.println("–ú–µ–Ω—è –ø—Ä–µ—Ä–≤–∞–ª–∏ –≤–æ –≤—Ä–µ–º—è —Å–Ω–∞!");
                    Thread.currentThread().interrupt(); // <-- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
                }
            }
            System.out.println("–ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.");
        });

        worker.start(); // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫

        Thread.sleep(3000); // –ñ–¥—ë–º 3 —Å–µ–∫—É–Ω–¥—ã
        System.out.println("–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫: –ø—Ä–µ—Ä—ã–≤–∞—é —Ä–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫...");
        worker.interrupt(); // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫

        worker.join(); // –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
        System.out.println("–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫: —Ä–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
    }
}

```

üîé –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞?

* –ü–æ—Ç–æ–∫ `worker` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ü–∏–∫–ª–µ: –ø–∏—à–µ—Ç `"–†–∞–±–æ—Ç–∞—é..."` –∏ –∑–∞—Å—ã–ø–∞–µ—Ç.
* –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã `main` –≤—ã–∑—ã–≤–∞–µ—Ç `interrupt()` ‚Üí –ø–æ—Ç–æ–∫ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è —Å `InterruptedException`.
* –ú—ã **–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥**, –∏–Ω–∞—á–µ `isInterrupted()` –¥–∞—Å—Ç `false`, –∏ –ø–æ—Ç–æ–∫ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.


###### üß† –†–∞–∑–±–æ—Ä `Thread.interrupted()`

```java
public static boolean Thread.interrupted()
```

* ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–ª–∞–≥ **—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞**.
* üîÑ **–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç** —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞.
* üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:

```java
if (Thread.interrupted()) {
    // –ø–æ—Ç–æ–∫ –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω
    // —Ñ–ª–∞–≥ —Ç–µ–ø–µ—Ä—å —Å–±—Ä–æ—à–µ–Ω (false)
    return; // –∏–ª–∏ break / throw
}
```

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ `interrupted()`:

```java
boolean getAndClearInterrupt() {
    boolean oldValue = interrupted;
    // We may have been interrupted the moment after we read the field,
    // so only clear the field if we saw that it was set and will return
    // true; otherwise we could lose an interrupt.
    if (oldValue) {
        interrupted = false;
        clearInterruptEvent();
    }
    return oldValue;
}
```

‚û°Ô∏è –§–ª–∞–≥ –æ—á–∏—â–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.


###### ‚ö†Ô∏è –ß–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞:

```java
worker.interrupted(); // üö´ –ù–µ —Ç–æ, —á—Ç–æ —Ç—ã –¥—É–º–∞–µ—à—å
```

* `interrupted()` ‚Äî **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π** –º–µ—Ç–æ–¥, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —É **—Ç–µ–∫—É—â–µ–≥–æ –ø–æ—Ç–æ–∫–∞**, –∞ –Ω–µ `worker`.
* –≠—Ç–æ—Ç –≤—ã–∑–æ–≤ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–µ–Ω `Thread.interrupted()` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫, **–Ω–µ** `worker`.


###### üîß –ü–æ—á–µ–º—É Java —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–ª–∞–≥ –ø—Ä–∏ `InterruptedException`?

üìå **–ü—Ä–∏—á–∏–Ω–∞ 1**: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Äî —É–∂–µ —Å–∏–≥–Ω–∞–ª –æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏.

üìå **–ü—Ä–∏—á–∏–Ω–∞ 2**: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∞–º —Ä–µ—à–∞–µ—Ç, **–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ñ–ª–∞–≥ –∏–ª–∏ –Ω–µ—Ç**.

üìå **–ü—Ä–∏—á–∏–Ω–∞ 3**: –ò–∑–±–µ–∂–∞–Ω–∏–µ **–ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π** –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º –∫–æ–¥–µ.


***

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –ø–æ—Ç–æ–∫–∞—Ö Java


###### ‚ùì –ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ –ø–æ—Ç–æ–∫–µ?

–ö–æ–≥–¥–∞ –≤ –ø–æ—Ç–æ–∫–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç **–∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–æ (****`try-catch`****)**, –æ–Ω–æ:

* **–ó–∞–≤–µ—Ä—à–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞**
* **–ù–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –¥–∞–ª—å—à–µ –≤** `main()`
* –ú–æ–∂–µ—Ç –±—ã—Ç—å **–Ω–µ–≤–∏–¥–∏–º—ã–º**, –µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫

```java
new Thread(() -> {
    throw new RuntimeException("–û—à–∏–±–∫–∞!");
}).start();
```

‚û°Ô∏è JVM –Ω–∞–ø–µ—á–∞—Ç–∞–µ—Ç —Å—Ç–µ–∫-—Ç—Ä–µ–π—Å, –Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ `main`.


###### üß† –†–µ—à–µ–Ω–∏–µ: `UncaughtExceptionHandler`

Java –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π **–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π**, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∏—Ö –≤ –ø–æ—Ç–æ–∫–∞—Ö.


üîß –°–ø–æ—Å–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:

1\. üßµ –ù–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Ç–æ–∫

```java
Thread t = new Thread(() -> {
    throw new RuntimeException("–û—à–∏–±–∫–∞!");
});

t.setUncaughtExceptionHandler((thread, throwable) -> {
    System.out.println("–ü–æ—Ç–æ–∫ " + thread.getName() + " –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: " + throwable.getMessage());
});

t.start();
```

2\. üèõÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```java
Thread.setDefaultUncaughtExceptionHandler((thread, throwable) -> {
    System.out.println("‚ö†Ô∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç: –ø–æ—Ç–æ–∫ " + thread.getName() + " –≤—ã–±—Ä–æ—Å–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: " + throwable);
});
```

> üí° –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –≤–æ –≤—Å–µ—Ö –ø–æ—Ç–æ–∫–∞—Ö, –∫—Ä–æ–º–µ`main`, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –Ω–µ —Å–≤–æ–π.

3\. üß© –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–ª–∞—Å—Å-–ø–æ—Ç–æ–∫

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –∫–ª–∞—Å—Å, —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–π –æ—Ç `Thread`, –∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.


###### üîé –ß—Ç–æ —Ç–∞–∫–æ–µ `UncaughtExceptionHandler`?

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

```java
public interface Thread.UncaughtExceptionHandler {
    void uncaughtException(Thread t, Throwable e);
}
```


###### üõ†Ô∏è –ü—Ä–∏–º–µ—Ä: —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º

```java
public class GlobalHandlerExample {
    public static void main(String[] args) {
        Thread.setDefaultUncaughtExceptionHandler((t, e) -> {
            System.out.println("üî• –û—à–∏–±–∫–∞ –≤ –ø–æ—Ç–æ–∫–µ " + t.getName() + ": " + e);
        });

        new Thread(() -> {
            throw new RuntimeException("–û—à–∏–±–∫–∞ –≤ –ø–æ—Ç–æ–∫–µ!");
        }).start();

        System.out.println("main –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...");
    }
}
```

```
main –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...
üî• –û—à–∏–±–∫–∞ –≤ –ø–æ—Ç–æ–∫–µ Thread-0: java.lang.RuntimeException: –û—à–∏–±–∫–∞ –≤ –ø–æ—Ç–æ–∫–µ!

```


***

# `ThreadFactory` ‚Äî —Ñ–∞–±—Ä–∏–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –≤ Java


###### üìå –ß—Ç–æ —ç—Ç–æ?

`ThreadFactory` ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è **–∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤**.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å —Å **—ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏** `ExecutorService`, –æ—Å–æ–±–µ–Ω–Ω–æ `ThreadPoolExecutor`.


###### üß† –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `ThreadFactory`

```java
public interface ThreadFactory {
    Thread newThread(Runnable r);
}
```

–¢—ã —Ä–µ–∞–ª–∏–∑—É–µ—à—å —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å:

* –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º –ø–æ—Ç–æ–∫–æ–≤
* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
* –î–µ–º–æ–Ω-—Å—Ç–∞—Ç—É—Å–æ–º
* –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
* –ì—Ä—É–ø–ø–∞–º–∏ –ø–æ—Ç–æ–∫–æ–≤ –∏ –ø—Ä–æ—á–∏–º


###### üõ†Ô∏è –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–Ω–æ–π —Ñ–∞–±—Ä–∏–∫–∏

```java
public class NamedThreadFactory implements ThreadFactory {
    private final AtomicInteger counter = new AtomicInteger(1);
    private final String baseName;

    public NamedThreadFactory(String baseName) {
        this.baseName = baseName;
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = new Thread(r);
        t.setName(baseName + "-thread-" + counter.getAndIncrement());
        t.setDaemon(false); // –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–µ–º–æ–Ω–æ–º
        return t;
    }
}
```


###### ü§ù –ü—Ä–∏–º–µ—Ä: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `NamedThreadFactory` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –≤—Ä—É—á–Ω—É—é

```java
public static void main(String[] args) {
    ThreadFactory factory = new NamedThreadFactory("custom");

    // –°–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫
    Thread t = factory.newThread(() -> {
        System.out.println("–ü—Ä–∏–≤–µ—Ç –∏–∑ –ø–æ—Ç–æ–∫–∞: " + Thread.currentThread().getName());
    });

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫
    t.start();
}
```


###### ü§ù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å `ExecutorService`

```java
ExecutorService executor = Executors.newFixedThreadPool(
    3, new NamedThreadFactory("worker")
);
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –ø–æ—Ç–æ–∫–∏ –±—É–¥—É—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `worker-thread-1`, `worker-thread-2`, –∏ —Ç. –¥.


***

# `synchronized`, –º–æ–Ω–∏—Ç–æ—Ä –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–æ–≤


###### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ `synchronized`?

`Synchronized` ‚Äî —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –≤ Java, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–µ–µ **–≤–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (mutual exclusion, mutex)** –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–º —Ä–µ—Å—É—Ä—Å–∞–º.

–° –µ–≥–æ –ø–æ–º–æ—â—å—é **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é**, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç.


###### üß† –ß—Ç–æ —Ç–∞–∫–æ–µ –º–æ–Ω–∏—Ç–æ—Ä?

* –ö–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É –≤ Java —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç **–º–æ–Ω–∏—Ç–æ—Ä**(–∏–ª–∏ intrinsic lock).
* `synchronized` –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫ **–∑–∞—Ö–≤–∞—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞**, –ø—Ä–µ–∂–¥–µ —á–µ–º –≤–æ–π—Ç–∏ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é.
* –¢–æ–ª—å–∫–æ **–æ–¥–∏–Ω –ø–æ—Ç–æ–∫** –º–æ–∂–µ—Ç –≤–ª–∞–¥–µ—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–æ–º –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏.
* –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ ‚Äî –æ–∂–∏–¥–∞—é—Ç, –ø–æ–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è.

![](assets/j70r4aMP-7J0kMeb6yRvruwg5TFf2GXiWk2fflxlIYc=.png)


###### üß± –§–æ—Ä–º—ã `synchronized`

1. üì¶ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π **–±–ª–æ–∫**

```java
synchronized (someObject) {
    // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
}
```

üîπ –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞ `someObject`.


1. üß∞ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π **–º–µ—Ç–æ–¥ (—ç–∫–∑–µ–º–ø–ª—è—Ä–Ω—ã–π)**

```java
public synchronized void doSomething() {
    // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
}
```

üîπ –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ:

```java
public void doSomething() {
    synchronized (this) {
        // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
    }
}
```


1. üèõÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥**

```java
public static synchronized void doStaticThing() {
    // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
}
```

üîπ –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ:

```java
public static void doStaticThing() {
    synchronized (ClassName.class) {
        // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
    }
}
```

> üí° –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–º–æ–Ω–∏—Ç–æ—Ä –∫–ª–∞—Å—Å–∞**, –∞ –Ω–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞.


###### üîÑ –ü—Ä–∏–º–µ—Ä: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥

```java
public class Counter {
    private int count = 0;

    public synchronized void increment() {
        count++;
    }

    public int getCount() {
        return count;
    }
}
```

> üëÜ –ü–æ—Ç–æ–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ `count`, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–æ—Å—Ç—É–ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.


###### –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø–æ —ç–∫–∑–µ–º–ø–ª—è—Ä—É **(`this`)** –∏ –ø–æ –∫–ª–∞—Å—Å—É **(`ClassName.class`)**


1. `synchronized` –ø–æ **—ç–∫–∑–µ–º–ø–ª—è—Ä—É**(`this`, `someObject`)

üî∏ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ **–Ω–µ—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–∞—Ö** –∏–ª–∏ –±–ª–æ–∫–∞—Ö:

üß† **–ú–æ–Ω–∏—Ç–æ—Ä –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞**, —Ç–æ –µ—Å—Ç—å:

* –£ –∫–∞–∂–¥–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–≤–æ–π **–º–æ–Ω–∏—Ç–æ—Ä**
* –ü–æ—Ç–æ–∫–∏, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ —Å **—Ä–∞–∑–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏** ‚Äî **–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç** –¥—Ä—É–≥ –¥—Ä—É–≥–∞

üìå **–ü—Ä–∏–º–µ—Ä**:

```java
Printer p1 = new Printer();
Printer p2 = new Printer();

p1.print(); // –ü–æ—Ç–æ–∫ 1
p2.print(); // –ü–æ—Ç–æ–∫ 2
```

–û–Ω–∏ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**, —Ç–∞–∫ –∫–∞–∫ —É `p1` –∏ `p2` **—Ä–∞–∑–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä—ã**.


1. `synchronized` –ø–æ **–∫–ª–∞—Å—Å—É**(`ClassName.class`)

üî∏ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ **—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–∞—Ö** –∏–ª–∏ –±–ª–æ–∫–∞—Ö:

üß† **–ú–æ–Ω–∏—Ç–æ—Ä –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è —É –æ–±—ä–µ–∫—Ç–∞ –∫–ª–∞—Å—Å–∞**, —Ç.–µ. `ClassName.class`.

* –ë–ª–æ–∫–∏—Ä—É–µ—Ç **–≤—Å–µ –ø–æ—Ç–æ–∫–∏**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ —Ä–∞–∑–¥–µ–ª—è–µ–º—ã–π —Ä–µ—Å—É—Ä—Å ‚Äî **–æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤**

üìå **–ü—Ä–∏–º–µ—Ä**:

```java
Printer.staticPrint(); // –ü–æ—Ç–æ–∫ 1
new Printer().staticPrint(); // –ü–æ—Ç–æ–∫ 2
```

–û–Ω–∏ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è **–ø–æ –æ—á–µ—Ä–µ–¥–∏**, –¥–∞–∂–µ –µ—Å–ª–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Ä–∞–∑–Ω—ã–µ ‚Äî –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ `Printer.class`.


‚úÖ –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

* –ï—Å–ª–∏ –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ **—Å–≤–æ–∏–º–∏** –¥–∞–Ω–Ω—ã–º–∏ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π –ø–æ **—ç–∫–∑–µ–º–ø–ª—è—Ä—É**
* –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ **–æ–±—â–∏–µ –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Å** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `static` –ø–æ–ª–µ, –ª–æ–≥-—Ñ–∞–π–ª –∏ —Ç.–¥.) ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π –ø–æ **–∫–ª–∞—Å—Å—É**


###### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑ `synchronized` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏

```java
public class UnsafeCounter {
    private int count = 0;

    public void increment() {
        count++; // race condition!
    }
}
```

‚ò†Ô∏è –ü–æ—Ç–æ–∫–∏ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å `count`, —á—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ **–Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º**.


###### üîß –¢–æ–Ω–∫–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

* üö´ **–ù–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π –ø–æ** `String`**–∏** `Integer` ‚Äî –æ–Ω–∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è JVM
* ‚úîÔ∏è –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π `lock`-–æ–±—ä–µ–∫—Ç
* ‚ö†Ô∏è –ò–∑–±–µ–≥–∞–π **–¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏** `synchronized` (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏—Ö)


###### üõ† –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `synchronized`

| –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞                       | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                       |
| ---------------------------------- | ------------------------------------------------- |
| `ReentrantLock`                    | –ë–æ–ª—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏ (—Ä—É—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞) |
| `AtomicInteger`, `AtomicReference` | –ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π              |
| `StampedLock`, `ReadWriteLock`     | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á—Ç–µ–Ω–∏–∏               |


***

# –ú–µ—Ç–æ–¥—ã `wait()`, `notify()`, `notifyAll()`


–≠—Ç–∏ –º–µ—Ç–æ–¥—ã ‚Äî —á–∞—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º–∞ **–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ—Ç–æ–∫–æ–≤ (thread communication)** –Ω–∞ —É—Ä–æ–≤–Ω–µ **–º–æ–Ω–∏—Ç–æ—Ä–∞ (intrinsic lock)**.


###### üß© –ì–¥–µ –æ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã?

üîπ –í –∫–ª–∞—Å—Å–µ `java.lang.Object` (–∞ –Ω–µ `Thread`!)

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ **–ª—é–±–æ–π –æ–±—ä–µ–∫—Ç** –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ **–º–æ–Ω–∏—Ç–æ—Ä** –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–æ–≤.


###### üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

–ú–µ—Ç–æ–¥—ã `wait()` –∏ `notify()` –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–æ—Ç–æ–∫–∞–º:

* üì≠ **–∂–¥–∞—Ç—å** –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (`wait`)
* üì¢ **—Å–æ–æ–±—â–∞—Ç—å** –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–∞–º, —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ (`notify`)


###### üîß –°–∏–≥–Ω–∞—Ç—É—Ä—ã

```java
void wait() throws InterruptedException
void notify()
void notifyAll()
```

–í—Å–µ —ç—Ç–∏ –º–µ—Ç–æ–¥—ã:

* –í—ã–∑—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ –∏–ª–∏ –º–µ—Ç–æ–¥–∞**
* –†–∞–±–æ—Ç–∞—é—Ç **—Ç–æ–ª—å–∫–æ —Å –º–æ–Ω–∏—Ç–æ—Ä–æ–º –æ–±—ä–µ–∫—Ç–∞**, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è


###### ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `wait()`?



* –ü–æ—Ç–æ–∫ –≤—Ö–æ–¥–∏—Ç –≤ `synchronized` –±–ª–æ–∫ (–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç **–º–æ–Ω–∏—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞**)
* –í—ã–∑—ã–≤–∞–µ—Ç `obj.wait()`:
  * –ü–æ—Ç–æ–∫ **–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä**
  * –£—Ö–æ–¥–∏—Ç –≤ **–æ–∂–∏–¥–∞–Ω–∏–µ**(–≤ "—Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è" —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞)
* –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `notify()` –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º:
  * –ü–æ—Ç–æ–∫ **–±—É–¥–µ—Ç —Ä–∞–∑–±—É–∂–µ–Ω**, –Ω–æ
  * –î–æ–ª–∂–µ–Ω **–∑–∞–Ω–æ–≤–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä**, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å


###### üß™ –ü—Ä–∏–º–µ—Ä

```java
class Shared {
    private boolean ready = false;

    public synchronized void waitForSignal() throws InterruptedException {
        while (!ready) {
            wait(); // –∂–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞
        }
        System.out.println("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª!");
    }

    public synchronized void sendSignal() {
        ready = true;
        notify(); // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª
    }
}
```


###### üîÅ –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `notify()` –∏ `notifyAll()`

| –ú–µ—Ç–æ–¥         | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                      |
| ------------- | ----------------------------------------------- |
| `notify()`    | –ë—É–¥–∏—Ç **–æ–¥–∏–Ω —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ç–æ–∫** –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö     |
| `notifyAll()` | –ë—É–¥–∏—Ç **–≤—Å–µ –ø–æ—Ç–æ–∫–∏**, –æ–∂–∏–¥–∞—é—â–∏–µ –º–æ–Ω–∏—Ç–æ—Ä –æ–±—ä–µ–∫—Ç–∞ |

> ‚úÖ `notifyAll()` –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω, —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –∂–¥—É—Ç –∏ –∫–∞–∫–æ–µ —É—Å–ª–æ–≤–∏–µ —É –Ω–∏—Ö.


###### üß∑ –ü–æ—á–µ–º—É `wait()` —á–∞—Å—Ç–æ –≤—ã–∑—ã–≤–∞—é—Ç –≤ `while`,  –∞ –Ω–µ –≤ `if`?

–ü–æ—Ç–æ–º—É —á—Ç–æ –ø–æ—Å–ª–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è:

* –ü–æ—Ç–æ–∫ –º–æ–∂–µ—Ç **–Ω–µ —Å—Ä–∞–∑—É –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä**
* –ú–æ–∂–µ—Ç –±—ã—Ç—å **–ª–æ–∂–Ω–æ–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ (spurious wakeup)**
* –ò–ª–∏ **—É—Å–ª–æ–≤–∏–µ –º–æ–∂–µ—Ç –±–æ–ª—å—à–µ –Ω–µ –±—ã—Ç—å –∏—Å—Ç–∏–Ω–Ω—ã–º**

```java
while (!—É—Å–ª–æ–≤–∏–µ) {
    wait();
}
```

> üîê –≠—Ç–æ **—à–∞–±–ª–æ–Ω "–æ–∂–∏–¥–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏—è"** (condition loop).


###### üí• –ï—Å–ª–∏ –≤—ã–∑–≤–∞—Ç—å `wait()`–±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏?

üëâ –ë—É–¥–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:

```java
IllegalMonitorStateException
```


###### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

* –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Å –º–æ–Ω–∏—Ç–æ—Ä–æ–º –æ–±—ä–µ–∫—Ç–∞**(–Ω–µ —Å –ø—Ä–∏–º–∏—Ç–∏–≤–∞–º–∏)
* –ù–µ–ª—å–∑—è –≤—ã–∑–≤–∞—Ç—å `wait()` –≤–Ω–µ `synchronized`-–±–ª–æ–∫–∞
* –°–ª–æ–∂–Ω–µ–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º —á–∏—Å–ª–µ –ø–æ—Ç–æ–∫–æ–≤ ‚Üí –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Lock/Condition`


###### üìå –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø–æ—Ç–æ—á–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ (simplified)

```java
class MyQueue {
    private final List<Integer> buffer = new ArrayList<>();
    private final int LIMIT = 5;

    public synchronized void produce(int value) throws InterruptedException {
        while (buffer.size() == LIMIT) {
            wait();
        }
        buffer.add(value);
        notify(); // –±—É–¥–∏–º –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
    }

    public synchronized int consume() throws InterruptedException {
        while (buffer.isEmpty()) {
            wait();
        }
        int val = buffer.remove(0);
        notify(); // –±—É–¥–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è
        return val;
    }
}
```


###### üß† –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `wait/notify` ‚Äî –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ API

| –ö–ª–∞—Å—Å/–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å                                | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
| ---------------------------------------------- | --------------------------------------------- |
| `ReentrantLock` + `Condition`                  | –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –æ–∂–∏–¥–∞–Ω–∏—è, –≥–∏–±–∫–æ—Å—Ç—å         |
| `BlockingQueue`                                | –ì–æ—Ç–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Producer-Consumer |
| `CountDownLatch`, `Semaphore`, `CyclicBarrier` | –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á                       |


***

# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Lock` (`java.util.concurrent.locks`)


–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Lock` ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É `synchronized`.
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–±–æ–ª–µ–µ –≥–∏–±–∫–∏–π –º–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**.


###### üì¶ –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî `ReentrantLock`

`ReentrantLock` = **–≤–∑–∞–∏–º–Ω–æ-–∏—Å–∫–ª—é—á–∞—é—â–∞—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**.

**–í–∑–∞–∏–º–Ω–æ-–∏—Å–∫–ª—é—á–∞—é—â–∞—è** - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–≤—É–º –ø–æ—Ç–æ–∫–∞–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–π—Ç–∏ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —Å–µ–∫—Ü–∏—é –∫–æ–¥–∞.

> –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ—Ç–æ–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —É–∂–µ —É–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∏–º –∑–∞–º–æ–∫.


###### üìå –ú–µ—Ç–æ–¥—ã `Lock`

| –ú–µ—Ç–æ–¥                    | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                            |
| ------------------------ | ----------------------------------------------------- |
| `lock()`                 | –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–º–æ–∫, –±–ª–æ–∫–∏—Ä—É—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏         |
| `unlock()`               | –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –∑–∞–º–æ–∫                                     |
| `tryLock()`              | –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –∑–∞–º–æ–∫, **–Ω–µ –±–ª–æ–∫–∏—Ä—É—è—Å—å**           |
| `tryLock(timeout, unit)` | –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –∑–∞–º–æ–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ |
| `lockInterruptibly()`    | –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–º–∫–∞                     |


###### ‚úÖ –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class Counter {
    private int count = 0;
    private final Lock lock = new ReentrantLock();

    public void increment() {
        lock.lock(); // –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∑–∞–º–æ–∫
        try {
            count++;
        } finally {
            lock.unlock(); // –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∑–∞–º–æ–∫
        }
    }

    public int getCount() {
        return count;
    }
}
```


###### üîÅ –û—Ç–ª–∏—á–∏–µ –æ—Ç `synchronized`

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å            | `synchronized`     | `ReentrantLock`               |
| ---------------------- | ------------------ | ----------------------------- |
| –ó–∞—Ö–≤–∞—Ç                 | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π     | –Ø–≤–Ω—ã–π (`lock()`)              |
| –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ           | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ     | –Ø–≤–Ω–æ–µ (`unlock()`)            |
| –ü—Ä–µ—Ä—ã–≤–∞–µ–º–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ   | ‚ùå                  | ‚úÖ `lockInterruptibly()`       |
| –ü–æ–ø—ã—Ç–∫–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è   | ‚ùå                  | ‚úÖ `tryLock()`                 |
| –û—á–µ—Ä–µ–¥–Ω–æ—Å—Ç—å (fairness) | ‚ùå –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ | ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å |
| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å–ª–æ–≤–∏–π    | ‚ùå                  | ‚úÖ –ß–µ—Ä–µ–∑ `Condition`           |


###### ‚öñÔ∏è –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å (`fairness`)

```java
new ReentrantLock(true); // "—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π" –∑–∞–º–æ–∫
```

üìå –ü–æ—Ç–æ–∫–∏ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç—Å—è **–≤ –ø–æ—Ä—è–¥–∫–µ –æ–∂–∏–¥–∞–Ω–∏—è**(FIFO).
–ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ **—Å–Ω–∏–∂–µ–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**.


###### üîÑ –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞

```java
lock.lock();  
lock.lock();  // –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Äî –ø–æ—Ç–æ–∫ —Ç–æ—Ç –∂–µ
...
lock.unlock();
lock.unlock();
```

üß† –ü–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∑–∞—Ö–≤–∞—Ç–∏—Ç—å `ReentrantLock` –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Äî –Ω–æ –¥–æ–ª–∂–µ–Ω –∏ **–æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Å—Ç–æ–ª—å–∫–æ –∂–µ**.


###### ‚è± –ü—Ä–∏–º–µ—Ä: `tryLock()` —Å —Ç–∞–π–º–∞—É—Ç–æ–º

```java
if (lock.tryLock(1, TimeUnit.SECONDS)) {
    try {
        // –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è
    } finally {
        lock.unlock();
    }
} else {
    // –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–º–æ–∫
}
```


###### üì¢ –†–∞–±–æ—Ç–∞ —Å `Condition`

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Condition` ‚Äî –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `wait()` / `notify()`.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ **–±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏—è –æ–∂–∏–¥–∞–Ω–∏—è** –Ω–∞ –æ–¥–∏–Ω –∑–∞–º–æ–∫.

```java
Lock lock = new ReentrantLock();
Condition condition = lock.newCondition();

lock.lock();
try {
    condition.await();     // –≤–º–µ—Å—Ç–æ wait()
    condition.signal();    // –≤–º–µ—Å—Ç–æ notify()
    condition.signalAll(); // –≤–º–µ—Å—Ç–æ notifyAll()
} finally {
    lock.unlock();
}
```


###### üß† –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ReentrantLock` –≤–º–µ—Å—Ç–æ `synchronized`?

* –ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω **–≥–∏–±–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –∑–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏
* –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ **–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ**
* –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `tryLock()` –∏ —Ç–∞–π–º–∞—É—Ç
* –ö–æ–≥–¥–∞ –Ω—É–∂–Ω—ã **–Ω–µ—Å–∫–æ–ª—å–∫–æ** `Condition` **–¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π**
* –ö–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ **—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è**


***

# ReentrantReadWriteLock


–≠—Ç–æ **—Ä–µ–µ–Ω—Ç—Ä–∞–Ω—Ç–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å** –∏–∑ –ø–∞–∫–µ—Ç–∞ `java.util.concurrent.locks`.

–ü–æ–∑–≤–æ–ª—è–µ—Ç **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ** –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤, –Ω–æ **–∏—Å–∫–ª—é—á–∞–µ—Ç –∑–∞–ø–∏—Å—å**, –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —á–∏—Ç–∞–µ—Ç –∏–ª–∏ –ø–∏—à–µ—Ç.


###### üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```java
ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();

Lock readLock = rwLock.readLock();   // üîé –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è
Lock writeLock = rwLock.writeLock(); // ‚úèÔ∏è –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏
```


###### üìå –ü–æ–≤–µ–¥–µ–Ω–∏–µ:

| –°–∏—Ç—É–∞—Ü–∏—è               | –†–∞–∑—Ä–µ—à–µ–Ω–æ?          |
| ---------------------- | ------------------- |
| üîé –ù–µ—Å–∫–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π | ‚úÖ –î–∞ (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ) |
| ‚úèÔ∏è –û–¥–∏–Ω –ø–∏—Å–∞—Ç–µ–ª—å       | ‚úÖ –î–∞ (—ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ)  |
| üîé –ß—Ç–µ–Ω–∏–µ + ‚úèÔ∏è –ó–∞–ø–∏—Å—å  | ‚ùå –ù–µ—Ç               |
| ‚úèÔ∏è –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–∏—Å–∞—Ç–µ–ª–µ–π | ‚ùå –ù–µ—Ç               |


###### üß† –ó–∞—á–µ–º –Ω—É–∂–Ω–æ?

–ö–æ–≥–¥–∞ —É —Ç–µ–±—è –µ—Å—Ç—å **–æ–±—â–∏–π —Ä–µ—Å—É—Ä—Å**, –∫–æ—Ç–æ—Ä—ã–π:

* —á–∞—Å—Ç–æ **—á–∏—Ç–∞–µ—Ç—Å—è**,
* –∏ **—Ä–µ–¥–∫–æ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è**,

üìà —Ç–æ `ReentrantReadWriteLock` –¥–∞—ë—Ç **–±–æ–ª—å—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**, —á–µ–º –æ–±—ã—á–Ω–∞—è `ReentrantLock`, –ø–æ—Ç–æ–º—É —á—Ç–æ:

* –Ω–µ—Å–∫–æ–ª—å–∫–æ **—á—Ç–µ–Ω–∏–π** –º–æ–≥—É—Ç –∏–¥—Ç–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ,
* –∞ **–∑–∞–ø–∏—Å—å** –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ—Ö ‚Äî —á–∏—Ç–∞—Ç–µ–ª–µ–π –∏ –¥—Ä—É–≥–∏—Ö –ø–∏—Å–∞—Ç–µ–ª–µ–π.


###### ‚úèÔ∏è –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```java
import java.util.concurrent.locks.*;

public class SharedData {
    private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();
    private final Lock readLock = lock.readLock();
    private final Lock writeLock = lock.writeLock();

    private int value = 0;

    public int read() {
        readLock.lock();
        try {
            return value;
        } finally {
            readLock.unlock();
        }
    }

    public void write(int newValue) {
        writeLock.lock();
        try {
            value = newValue;
        } finally {
            writeLock.unlock();
        }
    }
}
```


###### –†–µ–µ–Ω—Ç—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å

–û–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ:

* –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç **–ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å** `readLock` –∏–ª–∏ `writeLock` –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
* –ù–æ: **–Ω–µ–ª—å–∑—è –ø–æ–ª—É—á–∏—Ç—å** `readLock` **–ø–æ—Å–ª–µ** `writeLock` **–≤ —Ç–æ–º –∂–µ –ø–æ—Ç–æ–∫–µ**, –ø–æ–∫–∞ –Ω–µ –æ—Ç–ø—É—â–µ–Ω `writeLock`.


###### ‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `ReentrantLock`

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                 | `ReentrantLock` | `ReentrantReadWriteLock`  |
| --------------------------- | --------------- | ------------------------- |
| –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å | ‚ùå –ù–µ—Ç           | ‚úÖ –î–∞                      |
| –ù–µ—Å–∫–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç–µ–ª–µ–π         | ‚ùå –ù–µ—Ç           | ‚úÖ –î–∞                      |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏    | ‚ùå –ù–∏–∑–∫–∞—è        | ‚úÖ –í—ã—Å–æ–∫–∞—è                 |
| –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞...       | –ú–Ω–æ–≥–æ –∑–∞–ø–∏—Å–∏    | –ú–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è, –º–∞–ª–æ –∑–∞–ø–∏—Å–∏ |


***

# –ß—Ç–æ —Ç–∞–∫–æ–µ `Condition`?



`Condition` ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–∑ `java.util.concurrent.locks`, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–º–µ—Ö–∞–Ω–∏–∑–º –æ–∂–∏–¥–∞–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π `wait()` / `notify()`,  –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–≤–º–µ—Å—Ç–µ —Å** `Lock` **(–æ–±—ã—á–Ω–æ** `ReentrantLock`).


###### üì¶ –°–æ–∑–¥–∞–Ω–∏–µ `Condition`

```java
Lock lock = new ReentrantLock();
Condition condition = lock.newCondition();
```

* `Condition` —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ `Lock` —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `newCondition()`.
* –û–Ω —Å–≤—è–∑–∞–Ω –∏–º–µ–Ω–Ω–æ —Å **—ç—Ç–∏–º –∑–∞–º–∫–æ–º**.


###### üß† –ê–Ω–∞–ª–æ–≥–∏—è —Å `wait()` / `notify()`

| `Object` + `synchronized` | `Lock` + `Condition`       |
| ------------------------- | -------------------------- |
| `wait()`                  | `condition.await()`        |
| `notify()`                | `condition.signal()`       |
| `notifyAll()`             | `condition.signalAll()`    |
| –º–æ–Ω–∏—Ç–æ—Ä (`synchronized`)  | `Lock` (`lock()/unlock()`) |

###### ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã `Condition`

| –ú–µ—Ç–æ–¥              | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| ------------------ | ----------------------------------------------- |
| `await()`          | –ü–æ—Ç–æ–∫ –∂–¥—ë—Ç, –ø–æ–∫–∞ –µ–≥–æ –Ω–µ —Ä–∞–∑–±—É–¥—è—Ç (–∫–∞–∫ `wait()`) |
| `awaitNanos(n)`    | –ñ–¥—ë—Ç n –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥                               |
| `awaitUntil(Date)` | –ñ–¥—ë—Ç –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏                      |
| `signal()`         | –ë—É–¥–∏—Ç **–æ–¥–∏–Ω** –∂–¥—É—â–∏–π –ø–æ—Ç–æ–∫                     |
| `signalAll()`      | –ë—É–¥–∏—Ç **–≤—Å–µ** –∂–¥—É—â–∏–µ –ø–æ—Ç–æ–∫–∏                     |

‚ùó –í—Å–µ –º–µ—Ç–æ–¥—ã `await`, `signal`, `signalAll` –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å **—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω–æ–º** `lock`, –∏–Ω–∞—á–µ ‚Äî `IllegalMonitorStateException`.


###### üìå –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `Condition`

```java
import java.util.concurrent.locks.*;

public class Example {
    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private boolean ready = false;

    public void waitForSignal() throws InterruptedException {
        lock.lock();
        try {
            while (!ready) {
                condition.await(); // –ø–æ—Ç–æ–∫ –∂–¥—ë—Ç
            }
            // –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∏–≥–Ω–∞–ª–∞
        } finally {
            lock.unlock();
        }
    }

    public void sendSignal() {
        lock.lock();
        try {
            ready = true;
            condition.signal(); // –ø—Ä–æ–±—É–∂–¥–∞–µ–º –æ–¥–∏–Ω –ø–æ—Ç–æ–∫
        } finally {
            lock.unlock();
        }
    }
}
```


###### üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ `Condition` –ø–µ—Ä–µ–¥ `wait`/`notify`

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                           | `Object.wait()` / `notify()`    | `Lock` + `Condition`        |
| ------------------------------------- | ------------------------------- | --------------------------- |
| –ù–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª–æ–≤–∏–π –æ–∂–∏–¥–∞–Ω–∏—è            | ‚ùå –û–¥–Ω–æ –Ω–∞ –º–æ–Ω–∏—Ç–æ—Ä               | ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ   |
| –ü—Ä–µ—Ä—ã–≤–∞–µ–º–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ                  | ‚úÖ                               | ‚úÖ                           |
| –û–∂–∏–¥–∞–Ω–∏–µ —Å —Ç–∞–π–º-–∞—É—Ç–æ–º                 | ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ                   | ‚úÖ –ì–∏–±–∫–∏–µ –º–µ—Ç–æ–¥—ã             |
| –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–∏ (—Å–ø—É—Ä–∏–π–Ω–æ–µ) | ‚ùó –í–æ–∑–º–æ–∂–Ω—ã "–ª–æ–∂–Ω—ã–µ" –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è | ‚ùó –¢–æ–∂–µ –≤–æ–∑–º–æ–∂–Ω—ã             |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–∫–æ–º –≤—Ä—É—á–Ω—É—é             | ‚ùå –¢–æ–ª—å–∫–æ `synchronized`         | ‚úÖ –ß–µ—Ä–µ–∑ `lock()`/`unlock()` |


***

# Volatile


`volatile` ‚Äî —ç—Ç–æ **–º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π**, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

1. **–í—Å–µ–≥–¥–∞ —á—Ç–µ–Ω–∏–µ –∏–∑ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (main memory)**, –∞ –Ω–µ –∏–∑ –∫–µ—à–∞ –ø–æ—Ç–æ–∫–∞.
2. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –≤–∏–¥–Ω—ã –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–∞–º.**

```java
private volatile boolean running = true;
```


###### üí° –ó–∞—á–µ–º –Ω—É–∂–Ω–æ?

–ö–æ–≥–¥–∞ **–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤** —Ä–∞–±–æ—Ç–∞—é—Ç —Å **–æ–¥–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π**, `volatile` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* **–í–∏–¥–∏–º–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π** –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏.
* **–ó–∞–ø—Ä–µ—Ç reorder‚Äô–∞** –æ–ø–µ—Ä–∞—Ü–∏–π —Å —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (—á–∞—Å—Ç–∏—á–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç happens-before –æ—Ç–Ω–æ—à–µ–Ω–∏–µ).

‚ö†Ô∏è `volatile` **–Ω–µ –¥–∞—ë—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏**. –≠—Ç–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ **–≤–∏–¥–∏–º–æ—Å—Ç—å**, –Ω–µ –ø—Ä–æ –∑–∞—â–∏—Ç—É –æ—Ç –≥–æ–Ω–∫–∏.


###### üß† –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç `volatile`?

1. **–í–∏–¥–∏–º–æ—Å—Ç—å** ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ—Ç–æ–∫–∞–º.
2. **–ó–∞–ø—Ä–µ—Ç –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è**:
   * –û–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ –∑–∞–ø–∏—Å–∏ –≤ `volatile` **–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –ø–æ—Å–ª–µ** –Ω–µ—ë.
   * –û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —á—Ç–µ–Ω–∏—è –∏–∑ `volatile` **–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –¥–æ** –Ω–µ—ë.


###### üö´ –ß—Ç–æ `volatile` –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç?

–ù–µ –¥–µ–ª–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏:

```java
volatile int counter = 0;

// –ù–ï –∞—Ç–æ–º–∞—Ä–Ω–æ:
counter++; // = read + increment + write
```


###### üß© –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—Ç—å?

‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π `volatile`, –∫–æ–≥–¥–∞:

* –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –ø–∏—à–µ—Ç, –¥—Ä—É–≥–∏–µ —á–∏—Ç–∞—é—Ç.
* –ù—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø–æ—Ç–æ–∫–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è.
* –ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –¥–∞–Ω–Ω—ã–º–∏ (–Ω–µ –Ω—É–∂–Ω–æ –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—â–∏—â–∞—Ç—å).

‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π, –∫–æ–≥–¥–∞:

* –ù—É–∂–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã.
* –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (`if (x == ...) x = ...`).


***

# Deadlock (–≤–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞) –≤ Java


**Deadlock (–≤–∑–∞–∏–º–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)** ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –¥–≤–∞ –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ—Ç–æ–∫–∞ **–Ω–∞–≤—Å–µ–≥–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã**, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–∞–∂–¥—ã–π –∏–∑ –Ω–∏—Ö **–∂–¥—ë—Ç —Ä–µ—Å—É—Ä—Å, –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–π –¥—Ä—É–≥–∏–º**.


###### üéØ –£—Å–ª–æ–≤–∏—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è deadlock (–ø–æ –ö–æ—Ñ—Ñ–º–∞–Ω—É):

–ß—Ç–æ–±—ã —Å–ª—É—á–∏–ª—Å—è deadlock, **–¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –≤—Å–µ 4 —É—Å–ª–æ–≤–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**:

1. üîí **–í–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ** ‚Äî —Ä–µ—Å—É—Ä—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞—Ö–≤–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –ø–æ—Ç–æ–∫–æ–º.
2. üß∑ **–£–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ** ‚Äî –ø–æ—Ç–æ–∫ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å –∏ –∂–¥—ë—Ç –¥—Ä—É–≥–æ–π.
3. üö´ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è** ‚Äî —Ä–µ—Å—É—Ä—Å –º–æ–∂–µ—Ç –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –µ–≥–æ –¥–µ—Ä–∂–∏—Ç.
4. üîÅ **–¶–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ** ‚Äî —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ü–µ–ø–æ—á–∫–∞ –ø–æ—Ç–æ–∫–æ–≤, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –∂–¥—ë—Ç —Ä–µ—Å—É—Ä—Å —É —Å–ª–µ–¥—É—é—â–µ–≥–æ.


###### üîÅ –ü—Ä–∏–º–µ—Ä deadlock –Ω–∞ `synchronized`:

```java
public class DeadlockExample {
    private final Object lock1 = new Object();
    private final Object lock2 = new Object();

    public void method1() {
        synchronized (lock1) {
            System.out.println("Thread 1: –∑–∞—Ö–≤–∞—Ç–∏–ª lock1");
            try { Thread.sleep(100); } catch (InterruptedException ignored) {}
            synchronized (lock2) {
                System.out.println("Thread 1: –∑–∞—Ö–≤–∞—Ç–∏–ª lock2");
            }
        }
    }

    public void method2() {
        synchronized (lock2) {
            System.out.println("Thread 2: –∑–∞—Ö–≤–∞—Ç–∏–ª lock2");
            try { Thread.sleep(100); } catch (InterruptedException ignored) {}
            synchronized (lock1) {
                System.out.println("Thread 2: –∑–∞—Ö–≤–∞—Ç–∏–ª lock1");
            }
        }
    }

    public static void main(String[] args) {
        DeadlockExample example = new DeadlockExample();
        new Thread(example::method1).start();
        new Thread(example::method2).start();
    }
}
```

üß® –ü–æ—Ç–æ–∫–∏ –º–æ–≥—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ –ø–æ–≤–∏—Å–Ω—É—Ç—å:
Thread 1 –¥–µ—Ä–∂–∏—Ç `lock1`, –∂–¥—ë—Ç `lock2`,
Thread 2 –¥–µ—Ä–∂–∏—Ç `lock2`, –∂–¥—ë—Ç `lock1`.


###### üîç –ö–∞–∫ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å deadlock?

* **jconsole**, **VisualVM**, **jstack** ‚Äî –ø–æ–∫–∞–∂—É—Ç –∑–∞–≤–∏—Å—à–∏–µ –ø–æ—Ç–æ–∫–∏ –∏ –≤–∑–∞–∏–º–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
* `jstack <pid>` –≤—ã–≤–µ–¥–µ—Ç —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤ —Å –ø–æ–º–µ—Ç–∫–æ–π `deadlock detected`.


###### üõë –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å deadlock?


‚úÖ 1. **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ö–≤–∞—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤**

```java
// –≤—Å–µ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ lock1, –ø–æ—Ç–æ–º lock2
synchronized (lock1) {
    synchronized (lock2) {
        // —Ä–∞–±–æ—Ç–∞
    }
}
```

–í—Å–µ –ø–æ—Ç–æ–∫–∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç —Ä–µ—Å—É—Ä—Å—ã **–≤ –æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ** ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ.


‚úÖ 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `tryLock` –∏–∑ `ReentrantLock`

```java
if (lock1.tryLock(100, TimeUnit.MILLISECONDS)) {
    try {
        if (lock2.tryLock(100, TimeUnit.MILLISECONDS)) {
            try {
                // —Ä–∞–±–æ—Ç–∞
            } finally {
                lock2.unlock();
            }
        }
    } finally {
        lock1.unlock();
    }
}
```


‚úÖ 3. –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏ —Ç–∞–π–º–∞—É—Ç—ã

–í—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–π—Å—è **–≤—ã–π—Ç–∏ –∏–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∑–∞ N –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥.


‚úÖ 4. –ò–∑–±–µ–≥–∞–π –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

–°—Ç–∞—Ä–∞–π—Å—è **–Ω–µ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.


‚úÖ 5. –ò—Å–ø–æ–ª—å–∑—É–π –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞

* `java.util.concurrent`: `ExecutorService`, `Semaphore`, `BlockingQueue`
* `Lock` + `Condition`


***

# Livelock


**Livelock** ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –¥–≤–∞ –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ—Ç–æ–∫–∞ **–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è**, –Ω–æ **–ø–æ—Å—Ç–æ—è–Ω–Ω–æ "—É—Å—Ç—É–ø–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É"**, –Ω–µ –ø—Ä–æ–¥–≤–∏–≥–∞—è—Å—å –≤ —Ä–∞–±–æ—Ç–µ.

–ü–æ—Ç–æ–∫–∏ **–Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏**, –Ω–æ –Ω–µ –º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É, –ø–æ—Ç–æ–º—É —á—Ç–æ **—Ä–µ–∞–≥–∏—Ä—É—é—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞**, —Å–æ–∑–¥–∞–≤–∞—è –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –¥–µ–π—Å—Ç–≤–∏–π.


###### üìå –û—Ç–ª–∏—á–∏–µ –æ—Ç Deadlock

|                       | **Deadlock**                  | **Livelock**                     |
| --------------------- | ----------------------------- | -------------------------------- |
| üîí –ü–æ—Ç–æ–∫–∏             | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã, –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è | –ê–∫—Ç–∏–≤–Ω—ã, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —á—Ç–æ-—Ç–æ –¥–µ–ª–∞—é—Ç |
| üîÅ –ü—Ä–∏—á–∏–Ω–∞            | –í–∑–∞–∏–º–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤    | –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ |
| üß† –•–∞—Ä–∞–∫—Ç–µ—Ä –ø–æ–≤–µ–¥–µ–Ω–∏—è | –°—Ç–∞—Ç–∏—á–µ–Ω (–≤–∏—Å—è—Ç)              | –î–∏–Ω–∞–º–∏—á–µ–Ω (–≤–µ—Ä—Ç—è—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ)    |


###### üß™ –ü—Ä–∏–º–µ—Ä Livelock

```java
public class LivelockHallway {

    static class Person {
        private final String name;
        private boolean onLeft = true;

        public Person(String name) {
            this.name = name;
        }

        public boolean isOnLeft() {
            return onLeft;
        }

        public void switchSide() {
            onLeft = !onLeft;
            System.out.println(name + " –ø–µ—Ä–µ—à—ë–ª –Ω–∞ " + (onLeft ? "–ª–µ–≤—É—é" : "–ø—Ä–∞–≤—É—é") + " —Å—Ç–æ—Ä–æ–Ω—É.");
        }

        public String getName() {
            return name;
        }
    }

    public static void main(String[] args) {
        final Person alice = new Person("–ê–ª–∏—Å–∞");
        final Person bob = new Person("–ë–æ–±");

        Thread t1 = new Thread(() -> {
            while (alice.isOnLeft() == bob.isOnLeft()) {
                System.out.println(alice.getName() + ": –û–π, –ø—Ä–æ—Å—Ç–∏, —Ç—ã –∏–¥–∏ –ø–µ—Ä–≤–æ–π!");
                alice.switchSide();
                try {
                    Thread.sleep(100);
                } catch (InterruptedException ignored) {}
            }
            System.out.println(alice.getName() + ": –ü—Ä–æ—à–ª–∞!");
        });

        Thread t2 = new Thread(() -> {
            while (alice.isOnLeft() == bob.isOnLeft()) {
                System.out.println(bob.getName() + ": –û–π, –ø—Ä–æ—Å—Ç–∏, —Ç—ã –∏–¥–∏ –ø–µ—Ä–≤–æ–π!");
                bob.switchSide();
                try {
                    Thread.sleep(100);
                } catch (InterruptedException ignored) {}
            }
            System.out.println(bob.getName() + ": –ü—Ä–æ—à—ë–ª!");
        });

        t1.start();
        t2.start();
    }
}
```


***

# CAS (Compare-And-Swap)


**CAS (Compare-And-Swap)** ‚Äî —ç—Ç–æ –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –≤—ã–ø–æ–ª–Ω—è–µ–º–∞—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –û–Ω–∞:

1. **–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç** —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å –æ–∂–∏–¥–∞–µ–º—ã–º.
2. –ï—Å–ª–∏ –æ–Ω–∏ **—Ä–∞–≤–Ω—ã**, —Ç–æ **–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ** –Ω–∞ –Ω–æ–≤–æ–µ.
3. –ï—Å–ª–∏ **–Ω–µ —Ä–∞–≤–Ω—ã** ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.

> üìå CAS = —Å—Ä–∞–≤–Ω–∏ ‚Üí –∏ –µ—Å–ª–∏ —Å–æ–≤–ø–∞–ª–æ ‚Üí –∑–∞–º–µ–Ω–∏

‚ùó CAS —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ **CPU-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π**, –Ω–∞–ø—Ä–∏–º–µ—Ä `lock cmpxchg` ‚Äî —ç—Ç–æ –ø–æ—á—Ç–∏ –∫–∞–∫ –¥–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –Ω–æ —Å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å—é.


###### üîÅ –°–∏–≥–Ω–∞—Ç—É—Ä–∞ (–≤ –ø—Å–µ–≤–¥–æ–∫–æ–¥–µ)

```java
boolean compareAndSwap(expectedValue, newValue)
```

–ï—Å–ª–∏ `value == expectedValue` ‚Üí –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç `newValue` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`.

–ò–Ω–∞—á–µ ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`.


###### üß† –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CAS –≤ Java?

Java –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç CAS –≤ –ø–∞–∫–µ—Ç–∞—Ö **`java.util.concurrent.atomic`**, –Ω–∞–ø—Ä–∏–º–µ—Ä:

* `AtomicInteger`
* `AtomicLong`
* `AtomicReference`
* `AtomicBoolean`

```java
AtomicInteger counter = new AtomicInteger(0);

// –ü—ã—Ç–∞–µ–º—Å—è —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω —Ä–∞–≤–µ–Ω 0
boolean updated = counter.compareAndSet(0, 1);
System.out.println(updated); // true
```


###### üîí –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ CAS

‚úÖ **–ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** ‚Äî –Ω–µ—Ç `synchronized`, `Lock` –∏ –¥—Ä.
‚úÖ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º —á–∏—Å–ª–µ –ø–æ—Ç–æ–∫–æ–≤.
‚úÖ **–ú–∏–Ω–∏–º—É–º –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤**.


###### ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ CAS

‚ùå **ABA-–ø—Ä–æ–±–ª–µ–º–∞**

CAS —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ **–∑–Ω–∞—á–µ–Ω–∏—è**, –Ω–æ **–Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Ö –∏—Å—Ç–æ—Ä–∏—é**. –ü—Ä–∏–º–µ—Ä:

* –ó–Ω–∞—á–µ–Ω–∏–µ –±—ã–ª–æ `A ‚Üí B ‚Üí A`, –∏ CAS —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –≤—Å—ë –æ–∫, —Ö–æ—Ç—è –º–µ–∂–¥—É `A ‚Üí A` –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ.
* –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ **–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º**.

‚úÖ –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–≤–µ—Ä—Å–∏—é/–º–µ—Ç–∫—É** ‚Äî `AtomicStampedReference`.


‚ùå **–û–∂–∏–¥–∞–Ω–∏–µ –≤ —Ü–∏–∫–ª–µ (spin-loop)**

–ü—Ä–∏ —Å–∏–ª—å–Ω–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ CAS –º–æ–∂–µ—Ç **–¥–æ–ª–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å** (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –ø—ã—Ç–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–∞–ª–∏–≤–∞—é—Ç—Å—è).

```java
do {
    expected = atomic.get();
    newValue = expected + 1;
} while (!atomic.compareAndSet(expected, newValue));
```


‚ùå **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —à–∏–Ω—É –ø–∞–º—è—Ç–∏/–∫–µ—à–∏ CPU**
–û—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç–µ —Å –º–Ω–æ–≥–∏–º–∏ CAS-–æ–ø–µ—Ä–∞—Ü–∏—è–º–∏.


###### üì¶ –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ CAS-–æ–±—ä–µ–∫—Ç—ã

| –ö–ª–∞—Å—Å                    | –û–ø–∏—Å–∞–Ω–∏–µ                     |
| ------------------------ | ---------------------------- |
| `AtomicInteger`          | –¶–µ–ª–æ–µ —á–∏—Å–ª–æ                  |
| `AtomicLong`             | –î–ª–∏–Ω–Ω–æ–µ —Ü–µ–ª–æ–µ                |
| `AtomicReference<T>`     | –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ |
| `AtomicBoolean`          | –õ–æ–≥–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ          |
| `AtomicStampedReference` | –°—Å—ã–ª–∫–∞ —Å –º–µ—Ç–∫–æ–π (–¥–ª—è ABA)    |


###### üèó CAS –∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

CAS –ª–µ–∂–∏—Ç –≤ –æ—Å–Ω–æ–≤–µ:

* `ConcurrentLinkedQueue`
* `ConcurrentHashMap`
* `CopyOnWriteArrayList`
* `LongAdder`, `Accumulator`


###### üí° –ë–∞–∑–æ–≤—ã–π CAS-–ø—Å–µ–≤–¥–æ–∫–æ–¥:

```java
function compareAndSwap(memoryAddress, expectedValue, newValue):
    currentValue = readFromMemory(memoryAddress)
    
    if currentValue == expectedValue:
        writeToMemory(memoryAddress, newValue)
        return true
    else:
        return false
```


###### üîÅ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞:

```java
function atomicIncrement(atomicInt):
    do:
        oldValue = atomicInt.get()
        newValue = oldValue + 1
    while not compareAndSwap(atomicInt.address, oldValue, newValue)
    
    return newValue
```

> üîÑ –¶–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø–æ–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç—Å—è ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å **spin loop**.



###### üß† –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ CPU:

CAS –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **–Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞**, –Ω–∞–ø—Ä–∏–º–µ—Ä:

* `lock cmpxchg` –≤ x86
* `compare-and-swap` –≤ ARM
* JVM –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ `Unsafe` –∏–ª–∏ `VarHandle`


***

# –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ


**–ê—Ç–æ–º–∞—Ä–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** ‚Äî —ç—Ç–æ –æ–±—ë—Ä—Ç–∫–∏ –Ω–∞–¥ –ø—Ä–∏–º–∏—Ç–∏–≤–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å **–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ** –æ–ø–µ—Ä–∞—Ü–∏–∏ **–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** (–Ω–∞ –æ—Å–Ω–æ–≤–µ **CAS**).

–û–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–∫–µ—Ç–µ:

```java
java.util.concurrent.atomic
```

###### üì¶ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã

| –ö–ª–∞—Å—Å                           | –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö     | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ------------------------------- | -------------- | -------------------------------------- |
| `AtomicInteger`                 | `int`          | –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–π —Ç–∏–ø            |
| `AtomicLong`                    | `long`         | –ê—Ç–æ–º–∞—Ä–Ω—ã–π `long`                       |
| `AtomicBoolean`                 | `boolean`      | –ê—Ç–æ–º–∞—Ä–Ω—ã–π `boolean`                    |
| `AtomicReference<V>`            | `Object`       | –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç             |
| `AtomicIntegerArray`            | `int[]`        | –ê—Ç–æ–º–∞—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ `int`                 |
| `AtomicLongArray`               | `long[]`       | –ê—Ç–æ–º–∞—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ `long`                |
| `AtomicReferenceArray<V>`       | `Object[]`     | –ê—Ç–æ–º–∞—Ä–Ω—ã–π –º–∞—Å—Å–∏–≤ —Å—Å—ã–ª–æ–∫                |
| `AtomicStampedReference<V>`     | `Object + int` | –î–ª—è —Ä–µ—à–µ–Ω–∏—è ABA-–ø—Ä–æ–±–ª–µ–º—ã               |
| `AtomicMarkableReference<V>`    | `Object + bit` | –ö–∞–∫ Stamped, –Ω–æ —Å –±—É–ª–µ–≤—ã–º —Ñ–ª–∞–≥–æ–º       |
| `DoubleAccumulator` / `Adder`   | `double`       | –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Å—É–º–º—ã |
| `LongAdder` / `LongAccumulator` | `long`         | –î–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–µ–π   |


###### üîß –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã (–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ `AtomicInteger`):

```java
AtomicInteger ai = new AtomicInteger(0);

ai.get();             // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
ai.set(5);            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
ai.incrementAndGet(); // ++value
ai.decrementAndGet(); // --value
ai.getAndAdd(10);     // value += 10 (–≤–µ—Ä–Ω—ë—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
ai.compareAndSet(5, 42); // –µ—Å–ª–∏ value == 5 ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 42
```


###### üîÑ –ö–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏?

–í—Å–µ –∫–ª–∞—Å—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç **CAS (Compare-And-Swap)** —Å –ø–æ–º–æ—â—å—é `Unsafe` –∏–ª–∏ `VarHandle` (—Å Java 9+). CAS –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**: –ü–æ—Ç–æ–∫–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –∞ –ø–µ—Ä–µ–æ–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø–∞–º—è—Ç—å, –ø–æ–∫–∞ –Ω–µ –æ–±–Ω–æ–≤—è—Ç.


###### ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

‚úÖ –ü—Ä–∏–º–µ–Ω—è—Ç—å:

–ö–æ–≥–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è **–ø—Ä–æ—Å—Ç–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**.

–î–ª—è **—Å—á—ë—Ç—á–∏–∫–æ–≤**, **—Ñ–ª–∞–≥–æ–≤**, **–æ–¥–Ω–æ—ç–ª–µ–º–µ–Ω—Ç–Ω—ã—Ö –∫—ç—à–µ–π**, **lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä**.

–í —Å–∏—Å—Ç–µ–º–∞—Ö —Å **–≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–µ–π** –∏ –≤—ã—Å–æ–∫–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∫ –∑–∞–¥–µ—Ä–∂–∫–∞–º.

‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥—è—Ç:

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**.

–ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è **—Å–ª–æ–∂–Ω–∞—è** (–ª—É—á—à–µ `Lock` –∏–ª–∏ `synchronized`).


***

# –°–µ–º–∞—Ñ–æ—Ä—ã



**–°–µ–º–∞—Ñ–æ—Ä** ‚Äî —ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–æ–º –∫ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º—É —Ä–µ—Å—É—Ä—Å—É**.

–û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç **—Å—á—ë—Ç—á–∏–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π**:

* üîπ –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å ‚Üí –ø–æ—Ç–æ–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∏ —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫;
* üîí –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–µ—Ç ‚Üí –ø–æ—Ç–æ–∫ **–æ–∂–∏–¥–∞–µ—Ç**;
* ‚úÖ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã ‚Äî —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ **–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ**.


###### üì¶ –ö–ª–∞—Å—Å –≤ Java

```java
java.util.concurrent.Semaphore
```


###### üß± –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
| -------------------- | ----------------------------------------- |
| `acquire()`          | –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å)  |
| `release()`          | –û—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ                     |
| `tryAcquire()`       | –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±–µ–∑ –±–ª–æ–∫. |
| `availablePermits()` | –ö–æ–ª-–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π               |
| `drainPermits()`     | –ó–∞–±—Ä–∞—Ç—å –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è                    |


###### ‚úåÔ∏è –í–∞—Ä–∏–∞–Ω—Ç—ã —Å–µ–º–∞—Ñ–æ—Ä–∞:

| –í–∞—Ä–∏–∞–Ω—Ç                         | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                              |
| ------------------------------- | ---------------------------------------- |
| **fair = false** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | ‚ö° –ë—ã—Å—Ç—Ä–µ–µ, –Ω–æ **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫** |
| **fair = true**                 | ‚è± **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç FIFO-–ø–æ—Ä—è–¥–æ–∫** –æ–∂–∏–¥–∞–Ω–∏—è  |


###### üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–º–∞—Ñ–æ—Ä–∞

```java
Semaphore semaphore = new Semaphore(3); // 3 —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
Semaphore fairSemaphore = new Semaphore(3, true); // "—á–µ—Å—Ç–Ω—ã–π"
```


###### üíª –ü—Ä–∏–º–µ—Ä: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞

```java
Semaphore semaphore = new Semaphore(2); // –º–∞–∫—Å–∏–º—É–º 2 –ø–æ—Ç–æ–∫–∞

Runnable task = () -> {
    try {
        semaphore.acquire();
        System.out.println(Thread.currentThread().getName() + " –≤–æ—à—ë–ª");
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    } finally {
        System.out.println(Thread.currentThread().getName() + " –≤—ã—à–µ–ª");
        semaphore.release();
    }
};

for (int i = 0; i < 5; i++) {
    new Thread(task).start();
}
```

üß™ –í –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ "–≤–Ω—É—Ç—Ä–∏" –±—É–¥–µ—Ç –Ω–µ –±–æ–ª–µ–µ 2 –ø–æ—Ç–æ–∫–æ–≤.


***

# CountDownLatch


`CountDownLatch` ‚Äî —ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä –∏–∑ `java.util.concurrent`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç **–æ–¥–Ω–æ–º—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ—Ç–æ–∫–∞–º –∂–¥–∞—Ç—å**, –ø–æ–∫–∞ –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ **–Ω–µ –∑–∞–≤–µ—Ä—à–∞—Ç –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π**.


###### üí° –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

* `CountDownLatch` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–∏—Å–ª–æ–º `N` ‚Äî —Å—á—ë—Ç—á–∏–∫–æ–º.
* –ü–æ—Ç–æ–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç `await()` ‚Üí –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ —Å—á—ë—Ç—á–∏–∫ –Ω–µ —Å—Ç–∞–Ω–µ—Ç 0.
* –î—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç `countDown()` ‚Üí —É–º–µ–Ω—å—à–∞—é—Ç —Å—á—ë—Ç—á–∏–∫ –Ω–∞ 1.
* –ö–æ–≥–¥–∞ —Å—á—ë—Ç—á–∏–∫ = 0 ‚Üí –≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ –ø–æ—Ç–æ–∫–∏ **—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è**.


###### üì¶ –°–æ–∑–¥–∞–Ω–∏–µ

```java
CountDownLatch latch = new CountDownLatch(3); // –∂–¥—ë–º 3 —Å–æ–±—ã—Ç–∏—è
```


###### üß± –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                  | –û–ø–∏—Å–∞–Ω–∏–µ                                                     |
| ---------------------- | ------------------------------------------------------------ |
| `await()`              | –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ —Å—á—ë—Ç—á–∏–∫ –Ω–µ —Å—Ç–∞–Ω–µ—Ç 0 |
| `await(timeout, unit)` | –ñ–¥—ë—Ç –º–∞–∫—Å–∏–º—É–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –ø–æ—Ç–æ–º –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ   |
| `countDown()`          | –£–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –Ω–∞ 1                                       |
| `getCount()`           | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)     |


###### üíª –ü—Ä–∏–º–µ—Ä: –ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è 3 –ø–æ—Ç–æ–∫–æ–≤

```java
CountDownLatch latch = new CountDownLatch(3);

for (int i = 0; i < 3; i++) {
    new Thread(() -> {
        try {
            System.out.println(Thread.currentThread().getName() + " –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è");
            Thread.sleep(1000);
            System.out.println(Thread.currentThread().getName() + " –∑–∞–≤–µ—Ä—à—ë–Ω");
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            latch.countDown(); // –£–º–µ–Ω—å—à–∞–µ–º —Å—á—ë—Ç—á–∏–∫
        }
    }).start();
}

System.out.println("–ì–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∂–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...");
latch.await(); // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
System.out.println("–í—Å–µ –ø–æ—Ç–æ–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç.");
```

###### üß† –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

‚úÖ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:

* **–û–∂–∏–¥–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á.
* –ñ–¥–∞—Ç—å, –ø–æ–∫–∞ **–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤** –∑–∞–≤–µ—Ä—à–∞—Ç —Ä–∞–±–æ—Ç—É –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ.
* **–ó–∞–º–µ–Ω–∏—Ç—å** `join()` –ø—Ä–∏ –±–æ–ª—å—à–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–µ.

‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:

* –ï—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω **—Å–Ω–æ–≤–∞ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è** –∏–ª–∏ **—Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è**.
* –î–ª—è **–ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑**).


###### ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                                          | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ                                                          |
| ---------------------------------------------------- | ------------------------------------------------------------------- |
| `CountDownLatch` **–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π**                     | –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç                  |
| –ü–æ—Ç–æ–∫–∏, –≤—ã–∑—ã–≤–∞—é—â–∏–µ `countDown()`, **–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è** | –û–Ω–∏ –ø—Ä–æ—Å—Ç–æ —É–º–µ–Ω—å—à–∞—é—Ç —Å—á—ë—Ç—á–∏–∫                                        |
| –ü–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å `countDown()` –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑      | –≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –Ω–∞ —Å—Ç–æ–ª—å–∫–æ —Ä–∞–∑, —Å–∫–æ–ª—å–∫–æ –≤—ã–∑–æ–≤–æ–≤               |
| `await()` –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ—Ç–æ–∫–∞–º–∏      | –í—Å–µ –±—É–¥—É—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –∫–æ–≥–¥–∞ —Å—á—ë—Ç—á–∏–∫ –¥–æ–π–¥—ë—Ç –¥–æ –Ω—É–ª—è |


###### ‚è≥ `await(timeout, unit)` ‚Äî –ø—Ä–∏–º–µ—Ä:

```java
boolean completed = latch.await(5, TimeUnit.SECONDS);
if (completed) {
    System.out.println("–í—Å–µ –ø–æ—Ç–æ–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–∞–±–æ—Ç—É –≤–æ–≤—Ä–µ–º—è.");
} else {
    System.out.println("–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.");
}
```


***

# CyclicBarrier


`CyclicBarrier` ‚Äî —ç—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä –∏–∑ `java.util.concurrent`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç **–≥—Ä—É–ø–ø–µ –ø–æ—Ç–æ–∫–æ–≤ –¥–æ–∂–¥–∞—Ç—å—Å—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞**, –ø—Ä–µ–∂–¥–µ —á–µ–º **–≤—Å–µ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**.

–û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ **–±–∞—Ä—å–µ—Ä–Ω–∞—è —Ç–æ—á–∫–∞**:
üîÑ –ø–æ—Ç–æ–∫–∏ "—Å–æ–±–∏—Ä–∞—é—Ç—Å—è", –∏ –∫–∞–∫ —Ç–æ–ª—å–∫–æ –∏—Ö —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî **–≤—Å–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç**.


###### üí° –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–∏—Å–ª–æ `N` ‚Äî **—Ä–∞–∑–º–µ—Ä –±–∞—Ä—å–µ—Ä–∞**.
* –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç `barrier.await()`.
* –ö–∞–∫ —Ç–æ–ª—å–∫–æ —Å–æ–±–µ—Ä—É—Ç—Å—è –≤—Å–µ `N` –ø–æ—Ç–æ–∫–æ–≤ ‚Äî –æ–Ω–∏ **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç –¥–∞–ª—å—à–µ**.
* –ë–∞—Ä—å–µ—Ä **—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è** –∏ –≥–æ—Ç–æ–≤ –∫ **–ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é** (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `CountDownLatch`).


###### üß± –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                  | –û–ø–∏—Å–∞–Ω–∏–µ                                                            |
| ---------------------- | ------------------------------------------------------------------- |
| `await()`              | –ü–æ—Ç–æ–∫ –∂–¥—ë—Ç, –ø–æ–∫–∞ –≤—Å–µ –Ω–µ —Å–æ–±–µ—Ä—É—Ç—Å—è                                   |
| `await(timeout, unit)` | –¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ —Å —Ç–∞–π–º–∞—É—Ç–æ–º                                         |
| `getNumberWaiting()`   | –°–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ —É–∂–µ –∂–¥—É—Ç                                            |
| `getParties()`         | –û–±—â–µ–µ —á–∏—Å–ª–æ "–æ–∂–∏–¥–∞–µ–º—ã—Ö" –ø–æ—Ç–æ–∫–æ–≤                                     |
| `isBroken()`           | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`, –µ—Å–ª–∏ –±–∞—Ä—å–µ—Ä –±—ã–ª —Å–ª–æ–º–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—é) |
| `reset()`              | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –±–∞—Ä—å–µ—Ä–∞ (–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ —Å–±–æ—è)           |

###### ‚ú® –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä

```java
CyclicBarrier barrier = new CyclicBarrier(3);
```

–∏–ª–∏ —Å –¥–µ–π—Å—Ç–≤–∏–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π "–≤–æ–ª–Ω—ã":

```java
CyclicBarrier barrier = new CyclicBarrier(3, () -> {
    System.out.println("–í—Å–µ –ø–æ—Ç–æ–∫–∏ –¥–æ—à–ª–∏ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º!");
});
```


###### üíª –ü—Ä–∏–º–µ—Ä

```java
CyclicBarrier barrier = new CyclicBarrier(3);

Runnable task = () -> {
    System.out.println(Thread.currentThread().getName() + " –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É...");
    try {
        Thread.sleep((int)(Math.random() * 1000));
        System.out.println(Thread.currentThread().getName() + " –∂–¥—ë—Ç –Ω–∞ –±–∞—Ä—å–µ—Ä–µ...");
        barrier.await();
        System.out.println(Thread.currentThread().getName() + " –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.");
    } catch (Exception e) {
        e.printStackTrace();
    }
};

for (int i = 0; i < 3; i++) {
    new Thread(task).start();
}

```


###### üß† –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                                                             | –û–ø–∏—Å–∞–Ω–∏–µ                                           |
| ----------------------------------------------------------------------- | -------------------------------------------------- |
| `CyclicBarrier` –º–æ–∂–Ω–æ **–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ**                         | –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `CountDownLatch`                      |
| –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –ø–æ—Ç–æ–∫–æ–≤ –Ω–µ –ø—Ä–∏–¥—ë—Ç ‚Äî ‚ùå deadlock                             | –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `await(timeout)` –¥–ª—è –∑–∞—â–∏—Ç—ã     |
| –ï—Å–ª–∏ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–µ—Ä–≤—ë—Ç—Å—è ‚Äî ‚ùó –±–∞—Ä—å–µ—Ä "–ª–æ–º–∞–µ—Ç—Å—è" | –í—Å–µ –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –ø–æ–ª—É—á–∞—Ç `BrokenBarrierException` |
| `reset()` –≤—Ä—É—á–Ω—É—é —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ                                  | –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–ª–∏ –æ—Ç–º–µ–Ω–∞—Ö                    |


***

# Exchanger


`Exchanger` ‚Äî —ç—Ç–æ **–º–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π **–¥–≤—É–º –ø–æ—Ç–æ–∫–∞–º –æ–±–º–µ–Ω—è—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏** –º–µ–∂–¥—É —Å–æ–±–æ–π.

> –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –¥–≤–∞ —á–µ–ª–æ–≤–µ–∫–∞ –ø—Ä–æ—Ç—è–≥–∏–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É –∫–æ—Ä–æ–±–∫–∏ –∏ –æ–±–º–µ–Ω–∏–≤–∞—é—Ç—Å—è –∏–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –≠—Ç–æ –∏ –µ—Å—Ç—å `Exchanger`.


###### üì¶ –ö–ª–∞—Å—Å

```java
java.util.concurrent.Exchanger<V>
```

–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π **—Ç–∏–ø–æ–º –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö**.


###### üîß –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥

```java
V exchange(V x) throws InterruptedException
```

* –ü–æ—Ç–æ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç `exchange(x)`, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ `x`.
* –û–Ω **–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è**, –ø–æ–∫–∞ **–¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫** –Ω–µ –≤—ã–∑–æ–≤–µ—Ç `exchange(y)`.
* –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–±–∞ –ø–æ–ª—É—á–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞.

–¢–∞–∫–∂–µ –µ—Å—Ç—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Å —Ç–∞–π–º–∞—É—Ç–æ–º:

```java
V exchange(V x, long timeout, TimeUnit unit)
```


###### üìå –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

* –ü—Ä–∏ **–ø–∞—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö** (–ø—Ä–∏–º–µ—Ä: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, —Å–≤–µ—Ä–∫–∞).
* –ü—Ä–∏ **—Ä–∞–±–æ—Ç–µ "–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å-–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å"** —Å –æ–±–º–µ–Ω–æ–º –±—É—Ñ–µ—Ä–∞–º–∏.
* –ü—Ä–∏ **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–µ –æ–±—ä–µ–∫—Ç–æ–≤ –º–µ–∂–¥—É –¥–≤—É–º—è –ø–æ—Ç–æ–∫–∞–º–∏**.


###### üíª –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
import java.util.concurrent.Exchanger;

public class ExchangerExample {
    public static void main(String[] args) {
        Exchanger<String> exchanger = new Exchanger<>();

        Thread thread1 = new Thread(() -> {
            try {
                String msg = "–û—Ç –ø–æ—Ç–æ–∫–∞ 1";
                System.out.println("–ü–æ—Ç–æ–∫ 1 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: " + msg);
                String received = exchanger.exchange(msg);
                System.out.println("–ü–æ—Ç–æ–∫ 1 –ø–æ–ª—É—á–∏–ª: " + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });

        Thread thread2 = new Thread(() -> {
            try {
                String msg = "–û—Ç –ø–æ—Ç–æ–∫–∞ 2";
                System.out.println("–ü–æ—Ç–æ–∫ 2 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: " + msg);
                String received = exchanger.exchange(msg);
                System.out.println("–ü–æ—Ç–æ–∫ 2 –ø–æ–ª—É—á–∏–ª: " + received);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });

        thread1.start();
        thread2.start();
    }
}
```


###### üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                    | –û–ø–∏—Å–∞–Ω–∏–µ                                                          |
| ------------------------------ | ----------------------------------------------------------------- |
| üîÅ –¢–æ–ª—å–∫–æ –¥–ª—è **–¥–≤—É—Ö** –ø–æ—Ç–æ–∫–æ–≤ | –ï—Å–ª–∏ —Ç—Ä–µ—Ç–∏–π –ø–æ—Ç–æ–∫ –≤—ã–∑–æ–≤–µ—Ç `exchange()`, –æ–Ω –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ |
| ‚è±Ô∏è –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å **—Ç–∞–π–º–∞—É—Ç**    | –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏                                         |
| üîÉ **–û–¥–∏–Ω –æ–±–º–µ–Ω = –æ–¥–Ω–∞ –ø–∞—Ä–∞**  | –ü–æ—Ç–æ–∫–∏ "–≤—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å", –æ–±–º–µ–Ω—è–ª–∏—Å—å, –≤—Å—ë ‚Äî –Ω—É–∂–Ω–æ –Ω–æ–≤–æ–µ –≤—ã–∑–æ–≤         |
| üöß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ      | –ù–µ –¥–ª—è –æ–±—â–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π –∏–ª–∏ —à–∏—Ä–æ–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è                 |


###### üì¶ –†–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –¥–≤–æ–π–Ω–æ–π –±—É—Ñ–µ—Ä

```java
// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –Ω–∞–ø–æ–ª–Ω—è–µ—Ç –±—É—Ñ–µ—Ä, –ø–æ—Ç–æ–º –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç—Å—è —Å –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–º
Exchanger<List<String>> exchanger = new Exchanger<>();
List<String> producerBuffer = new ArrayList<>();
List<String> consumerBuffer = new ArrayList<>();

// –ü–æ—Ç–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è
new Thread(() -> {
    while (true) {
        producerBuffer.add("–¥–∞–Ω–Ω—ã–µ");
        if (producerBuffer.size() == 10) {
            try {
                producerBuffer = exchanger.exchange(producerBuffer);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
}).start();

// –ü–æ—Ç–æ–∫ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
new Thread(() -> {
    while (true) {
        try {
            consumerBuffer = exchanger.exchange(consumerBuffer);
            consumerBuffer.clear(); // –ø–æ—Ç—Ä–µ–±–∏–ª –¥–∞–Ω–Ω—ã–µ
        } catch (InterruptedException e) {
            break;
        }
    }
}).start();
```


***

# Phaser



**`Phaser`** –≤ Java ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –∏ –≥–∏–±–∫–∏—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –≤ `java.util.concurrent`.


###### üîÑ –ß—Ç–æ —Ç–∞–∫–æ–µ `Phaser`?

**`Phaser`** ‚Äî —ç—Ç–æ —É–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–æ–≥ `CyclicBarrier` –∏ `CountDownLatch`, –∫–æ—Ç–æ—Ä—ã–π:

* üîÅ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ —Ñ–∞–∑—ã** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—ç—Ç–∞–ø—ã)
* üîß –ø–æ–∑–≤–æ–ª—è–µ—Ç **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å** —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
* üß† –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏


###### üß† –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

* üîπ **–§–∞–∑–∞ (Phase)** ‚Äî —ç—Ç–æ —à–∞–≥/—ç—Ç–∞–ø –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É ‚Äî –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è.
* üîπ **–£—á–∞—Å—Ç–Ω–∏–∫–∏ (parties)** ‚Äî –ø–æ—Ç–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
* üîπ **–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫** ‚Äî –ø–æ—Ç–æ–∫, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ Phaser.


###### ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç —É CountDownLatch –∏ CyclicBarrier:

| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å                      | CountDownLatch | CyclicBarrier | Phaser |
| -------------------------------- | -------------- | ------------- | ------ |
| –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ          | ‚ùå              | ‚úÖ             | ‚úÖ      |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ | ‚ùå              | ‚ùå             | ‚úÖ      |
| –ú–Ω–æ–≥–æ—Ñ–∞–∑–Ω–æ—Å—Ç—å                    | ‚ùå              | ‚ùå             | ‚úÖ      |
| –û—Ç–º–µ–Ω–∞ —É—á–∞—Å—Ç–∏—è                   | ‚ùå              | ‚ùå             | ‚úÖ      |


###### üß± –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                       | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| --------------------------- | ------------------------------------------ |
| `register()`                | –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞                 |
| `bulkRegister(int parties)` | –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ                        |
| `arrive()`                  | –û—Ç–º–µ—á–∞–µ—Ç –ø—Ä–∏–±—ã—Ç–∏–µ (–Ω–µ –∂–¥—ë—Ç –¥—Ä—É–≥–∏—Ö)         |
| `arriveAndDeregister()`     | –ü—Ä–∏–±—ã—Ç–∏–µ + –≤—ã—Ö–æ–¥ –∏–∑ —É—á–∞—Å—Ç–∏—è                |
| `arriveAndAwaitAdvance()`   | –ü—Ä–∏–±—ã—Ç–∏–µ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö (–∫–∞–∫ `await()`) |
| `getPhase()`                | –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ñ–∞–∑—É                      |
| `getRegisteredParties()`    | –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤                   |
| `getArrivedParties()`       | –°–∫–æ–ª—å–∫–æ —É–∂–µ –ø—Ä–∏–±—ã–ª–∏                        |
| `getUnarrivedParties()`     | –°–∫–æ–ª—å–∫–æ –µ—â—ë –Ω–µ –ø—Ä–∏–±—ã–ª–∏                     |
| `isTerminated()`            | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç–∏                     |
| `forceTermination()`        | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å Phaser             |

###### üíª –ü—Ä–∏–º–µ—Ä –±–∞–∑–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
Phaser phaser = new Phaser(3); // 3 —É—á–∞—Å—Ç–Ω–∏–∫–∞

for (int i = 0; i < 3; i++) {
    int id = i;
    new Thread(() -> {
        System.out.println("–ü–æ—Ç–æ–∫ " + id + " —Ñ–∞–∑–∞ 0");
        phaser.arriveAndAwaitAdvance(); // –û–∂–∏–¥–∞–µ–º –≤—Å–µ—Ö

        System.out.println("–ü–æ—Ç–æ–∫ " + id + " —Ñ–∞–∑–∞ 1");
        phaser.arriveAndAwaitAdvance();

        System.out.println("–ü–æ—Ç–æ–∫ " + id + " –∑–∞–≤–µ—Ä—à—ë–Ω");
        phaser.arriveAndDeregister(); // –£—Ö–æ–¥–∏–º
    }).start();
}
```

üåÄ –í—ã–≤–æ–¥: –ü–æ—Ç–æ–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–π —Ñ–∞–∑–µ ‚Äî –ø–æ–∫–∞ –≤—Å–µ –Ω–µ –ø—Ä–∏–±—É–¥—É—Ç, –Ω–∏–∫—Ç–æ –Ω–µ –∏–¥—ë—Ç –¥–∞–ª—å—à–µ.


###### üöß –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ `Phaser`

`Phaser` –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –ø–æ —Ñ–∞–∑–∞–º, –ø–æ–∫–∞:

* –ù–µ –≤—ã–∑–≤–∞–Ω `forceTermination()`
* –ò–ª–∏ –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∏ –æ–¥–Ω–æ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞


###### üßØ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Å–±—Ä–æ—Å

* –ü–æ—Ç–æ–∫–∏ –º–æ–∂–Ω–æ **–¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–¥–∞–ª—è—Ç—å** –Ω–∞ –ª–µ—Ç—É
* –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∏–ª–∏ –∞–≤–∞—Ä–∏–π–Ω–æ –≤—ã—à–µ–ª ‚Äî –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å `arriveAndDeregister()`
* –ï—Å–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è ‚Äî –≤—ã–∑–≤–∞—Ç—å `forceTermination()`


***

# ConcurrentHashMap


`ConcurrentHashMap` ‚Äî —ç—Ç–æ **–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `Map`, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–ª—è **–≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ** –¥–æ—Å—Ç—É–ø–∞ –∏–∑ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –±–µ–∑ —è–≤–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**.

üì¶ –ö–ª–∞—Å—Å:

```java
java.util.concurrent.ConcurrentHashMap<K, V>
```


###### üß† –û—Å–Ω–æ–≤–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                                                  | –û–ø–∏—Å–∞–Ω–∏–µ                  |
| ------------------------------------------------------------ | ------------------------- |
| ‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è                                           | –ë–µ–∑ –≤–Ω–µ—à–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |
| üö´ –ù–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç `null` –∫–ª—é—á–µ–π/–∑–Ω–∞—á–µ–Ω–∏–π                       | –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `HashMap`    |
| üîÅ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ             | –ë–µ–∑ –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏     |
| üì∂ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ª—É—á—à–µ, —á–µ–º `Collections.synchronizedMap()` |                           |


###### üìä –û—Ç–ª–∏—á–∏–µ –æ—Ç `Collections.synchronizedMap()`

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | `ConcurrentHashMap`               | `synchronizedMap` (–æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ `HashMap`) |
| ----------------------------- | --------------------------------- | ----------------------------------------- |
| –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å            | ‚úÖ –î–∞                              | ‚úÖ –î–∞                                      |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å            | üîù –í—ã—Å–æ–∫–∞—è (fine-grained locking) | üê¢ –ù–∏–∑–∫–∞—è (–≤–µ—Å—å map –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)          |
| –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞                    | üö´ –ß–∞—Å—Ç–∏—á–Ω–∞—è (–ø–æ —Å–µ–≥–º–µ–Ω—Ç—É/—è—á–µ–π–∫–µ) | üîí –ü–æ–ª–Ω–∞—è (–≤–µ—Å—å map)                      |
| –î–æ–ø—É—Å—Ç–∏–º `null` –∫–ª—é—á/–∑–Ω–∞—á–µ–Ω–∏–µ | ‚ùå –ù–µ—Ç                             | ‚úÖ –î–∞                                      |


###### ‚öôÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å?

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **CAS (compare-and-swap)** + **—É–∑–∫–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**:

| –û–ø–µ—Ä–∞—Ü–∏—è          | –ú–µ—Ö–∞–Ω–∏–∑–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏                                                   |
| ----------------- | --------------------------------------------------------------------- |
| `get(key)`        | üîì –ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (volatile —á—Ç–µ–Ω–∏–µ)                                   |
| `put(key, value)` | üîí –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–∞—è —è—á–µ–π–∫–∞                                   |
| `compute*`        | üîí –õ–æ–∫–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è                                            |
| `forEach()`       | ‚ùó –°–ª–∞–±–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è) |


###### üìå –ú–µ—Ç–æ–¥—ã —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º

| –ú–µ—Ç–æ–¥                    | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
| ------------------------ | --------------------------------------------- |
| `putIfAbsent(key, val)`  | –í—Å—Ç–∞–≤–ª—è–µ—Ç, –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç                     |
| `remove(key, val)`       | –£–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç |
| `replace(key, old, new)` | –ó–∞–º–µ–Ω—è–µ—Ç, –µ—Å–ª–∏ —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç      |
| `compute(key, fn)`       | –ê—Ç–æ–º–∞—Ä–Ω–æ –≤—ã—á–∏—Å–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ                   |
| `merge(key, val, fn)`    | –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π                |


###### üîÅ –ü—Ä–∏–º–µ—Ä

```java
ConcurrentHashMap<String, Integer> map = new ConcurrentHashMap<>();

map.put("apple", 1);
map.putIfAbsent("apple", 2); // –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç
map.compute("apple", (k, v) -> v + 10); // —Å—Ç–∞–Ω–µ—Ç 11
```


###### üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

–í–Ω—É—Ç—Ä–∏:

* `Node<K,V>[] table` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ö—ç—à-—Ç–∞–±–ª–∏—Ü–∞
* –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –ª–∏–±–æ `Node`, –ª–∏–±–æ `TreeNode`
* `synchronized` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∞–∫–µ—Ç–∞**, –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `put()`)

–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ:

* –¢–∞–±–ª–∏—Ü–∞ **—Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ** (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `HashMap`, –≥–¥–µ resize ‚Äî –ø–∞—É–∑–∞)
* Resize –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ –∏ –ª–µ–Ω–∏–≤–æ**, –∫–æ–≥–¥–∞ –ø–æ—Ç–æ–∫–∏ —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è —Å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ–º


###### üìä Consistency model

`ConcurrentHashMap` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

* **"happens-before"** –ø—Ä–∏ `put()` ‚Üí `get()` (volatile –ø–æ–ª—è)
* –ß—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç `ConcurrentModificationException`

–ù–æ! –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `Collections.synchronizedMap`, –æ–Ω–∞ **–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å map** ‚Üí –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å **—á–∞—Å—Ç–∏—á–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**.


***

# –ì–ª—É–±–æ–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ `Collections.synchronizedMap()` –∏ `ConcurrentHashMap`


###### üß≠ –û–±—â–µ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ

| –°–≤–æ–π—Å—Ç–≤–æ                | `Collections.synchronizedMap`        | `ConcurrentHashMap`                           |
| ----------------------- | ------------------------------------ | --------------------------------------------- |
| –ú–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏  | –ì—Ä—É–±–∞—è (coarse-grained)              | –¢–æ–Ω–∫–∞—è (fine-grained), —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è / CAS |
| –¢–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏          | `synchronized` –Ω–∞ –≤—Å—ë–º –æ–±—ä–µ–∫—Ç–µ –∫–∞—Ä—Ç—ã | –ß–∞—Å—Ç–∏—á–Ω—ã–µ `synchronized` –±–ª–æ–∫–∏ –∏–ª–∏ CAS        |
| –ß—Ç–µ–Ω–∏—è                  | –ë–ª–æ–∫–∏—Ä—É—é—Ç                            | –ù–µ –±–ª–æ–∫–∏—Ä—É—é—Ç                                  |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã               | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è                                |
| –ò—Ç–µ—Ä–∞—Ü–∏—è                | –¢—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏        | –ë–µ–∑–æ–ø–∞—Å–Ω–∞, –Ω–æ –Ω–µ strongly consistent          |
| Null-–∫–ª—é—á–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è   | –†–∞–∑—Ä–µ—à–µ–Ω—ã                            | –ó–∞–ø—Ä–µ—â–µ–Ω—ã                                     |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å      | –ù–∏–∑–∫–∞—è –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏       | –í—ã—Å–æ–∫–∞—è –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏                   |


###### üîí **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤** `Collections.synchronizedMap`


üîß –ú–µ—Ö–∞–Ω–∏–∑–º:

–≠—Ç–æ **–æ–±—ë—Ä—Ç–∫–∞**, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–±–∞–≤–ª—è–µ—Ç `synchronized` –∫–æ –≤—Å–µ–º –º–µ—Ç–æ–¥–∞–º –¥–æ—Å—Ç—É–ø–∞.

```java
Map<K, V> map = Collections.synchronizedMap(new HashMap<>());
```

–ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (–∏ `get()`, –∏ `put()`, –∏ `containsKey()`) **–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å –æ–±—ä–µ–∫—Ç –∫–∞—Ä—Ç—ã**.

```java
synchronized (map) {
    for (Map.Entry<K, V> entry : map.entrySet()) {
        // –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ synchronized
    }
}
```

‚ùó –ú–∏–Ω—É—Å—ã:

* **–í—Å–µ –ø–æ—Ç–æ–∫–∏ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—Ç –∑–∞ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –º–æ–Ω–∏—Ç–æ—Ä** (–Ω–∞ –≤—Å–µ–π –∫–∞—Ä—Ç–µ).
* –î–∞–∂–µ **—á—Ç–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä—É—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞**.
* –ò—Ç–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ `synchronized`.
* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ = **–≥—Ä—É–±–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**.


###### ‚öôÔ∏è **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤** `ConcurrentHashMap`

üí° –ú–µ—Ö–∞–Ω–∏–∑–º—ã:

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ç–æ–Ω–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é** –Ω–∞ **—è—á–µ–π–∫–∞—Ö**, –∞ –Ω–µ –Ω–∞ –≤—Å–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **CAS (Compare-And-Swap)** –¥–ª—è –±–µ–∑–±–ª–æ–∫–∏—Ä–æ–≤–æ—á–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
* –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π `synchronized` **–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∫–µ—Ç-–≥—Ä—É–ø–ø–µ** (Node\[]).

üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

* –¢–∞–±–ª–∏—Ü–∞ `Node<K,V>[] table`
* –ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ (–±–∞–∫–µ—Ç) —Å–æ–¥–µ—Ä–∂–∏—Ç:
  * –ª–∏–±–æ `null`
  * –ª–∏–±–æ `Node`
  * –ª–∏–±–æ `TreeBin` (–ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ ‚Äî –∫—Ä–∞—Å–Ω–æ-—á–µ—Ä–Ω–æ–µ –¥–µ—Ä–µ–≤–æ)

| –û–ø–µ—Ä–∞—Ü–∏—è        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è                                     |
| --------------- | ---------------------------------------------- |
| `get(key)`      | –ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (volatile + hash)               |
| `put(key, val)` | `CAS` –∏–ª–∏ `synchronized` –Ω–∞ –±–∞–∫–µ—Ç–µ (Node lock) |
| `compute()`     | –õ–æ–∫–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–ª—é—á–∞          |
| `resize()`      | –õ–µ–Ω–∏–≤–æ–µ –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ                        |


###### üß™ CAS –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

–í–Ω—É—Ç—Ä–∏ `ConcurrentHashMap` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CAS (`compareAndSet`) –¥–ª—è:

* –≤—Å—Ç–∞–≤–∫–∏, –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –ø—É—Å—Ç–∞—è
* –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –∫–ª—é—á—É
* –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –µ—Å–ª–∏ CAS –Ω–µ —É–¥–∞–ª—Å—è ‚Äî —Ç–æ–≥–¥–∞ fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π `synchronized`

```java
if (tabAt(table, i) == null) {
    if (casTabAt(table, i, null, new Node(...))) {
        // –≤—Å—Ç–∞–≤–∏–ª–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    } else {
        // –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ synchronized
    }
}
```


***

# CopyOnWriteArrayList



`CopyOnWriteArrayList`‚Äì —ç—Ç–æ **–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è** —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `List` –∏–∑ `java.util.concurrent`. –ï–≥–æ —Ñ–∏—à–∫–∞ ‚Äì **"–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏"**, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —á—Ç–µ–Ω–∏–µ **–±—ã—Å—Ç—Ä—ã–º** –∏ **–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**!


###### –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ üßê

**–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** ‚Äì –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤.
**–ß—Ç–µ–Ω–∏–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫** ‚Äì `get()`, `iterator()` —Ä–∞–±–æ—Ç–∞—é—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ.
**–ó–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äì `add()`, `remove()` —Å–æ–∑–¥–∞—é—Ç –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤.
**–ò—Ç–µ—Ä–∞—Ç–æ—Ä—ã ‚Äì "—Å–Ω–∏–º–∫–∏** ‚Äì –Ω–µ –ª–æ–º–∞—é—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞.
**–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è "read-heavy"** ‚Äì –∫–æ–≥–¥–∞ —á–∏—Ç–∞—é—Ç —á–∞—Å—Ç–æ, –∞ –ø–∏—à—É—Ç —Ä–µ–¥–∫–æ.


###### –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚öôÔ∏è

–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```java
public class CopyOnWriteArrayList<E> {  
    private volatile Object[] array; // üîÑ –í–∏–¥–µ–Ω –≤—Å–µ–º –ø–æ—Ç–æ–∫–∞–º  
    final ReentrantLock lock = new ReentrantLock(); // üîí –ó–∞—â–∏—â–∞–µ—Ç –∑–∞–ø–∏—Å—å  
}
```

–ß—Ç–µ–Ω–∏–µ (`get()`, `iterator`)

```java
public E get(int index) {  
    return (E) array[index]; // ‚ö° –ë—ã—Å—Ç—Ä–æ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫!  
}
```

–ó–∞–ø–∏—Å—å (`add`, `remove`, `set`)

1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (`lock.lock()`).
2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ (`Arrays.copyOf`).
3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–∏.
4. –ü–æ–¥–º–µ–Ω–∞ –º–∞—Å—Å–∏–≤–∞ (`setArray(newArray)`).
5. –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (`lock.unlock()`).

```java
public boolean add(E e) {  
    lock.lock();  
    try {  
        Object[] newArray = Arrays.copyOf(array, array.length + 1);  
        newArray[newArray.length - 1] = e;  
        setArray(newArray);  
        return true;  
    } finally {  
        lock.unlock();  
    }  
}
```


###### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞ üîÑ

* –†–∞–±–æ—Ç–∞–µ—Ç —Å **"—Å–Ω–∏–º–∫–æ–º"** (–º–∞—Å—Å–∏–≤–æ–º –Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è).
* **–ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** `remove()` (–∫–∏–¥–∞–µ—Ç`UnsupportedOperationException`).
* **–ù–µ –≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è**.


###### –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã ‚öñÔ∏è

‚úÖ –ü–ª—é—Å—ã

‚úî–ß—Ç–µ–Ω–∏–µ ‚Äì –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫).
‚úî–ò—Ç–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ—É–±–∏–≤–∞–µ–º—ã–µ (–Ω–µ—Ç `ConcurrentModificationException`).
‚úî–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è listener‚Äô–æ–≤ (—Ä–µ–¥–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —á–∞—Å—Ç–æ–µ —á—Ç–µ–Ω–∏–µ).

‚ùå –ú–∏–Ω—É—Å—ã

‚úñ–ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞).
‚úñ–ú–æ–∂–µ—Ç –∂—Ä–∞—Ç—å –ø–∞–º—è—Ç—å (–µ—Å–ª–∏ —á–∞—Å—Ç–æ –∏–∑–º–µ–Ω—è—Ç—å).
‚úñ–ù–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö bulk-–æ–ø–µ—Ä–∞—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä,`addAll` –Ω–µ –∞—Ç–æ–º–∞—Ä–µ–Ω).


***

# ArrayBlockingQueue


`ArrayBlockingQueue` ‚Äî —ç—Ç–æ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è (bounded) –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—á–µ—Ä–µ–¥—å**, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ **–º–∞—Å—Å–∏–≤–µ**. –û–Ω–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `BlockingQueue` –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è **–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏** –≤ —Å—Ç–∏–ª–µ **"–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å‚Äì–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å"**.


###### üì¶ –ö–ª–∞—Å—Å –∏ –∏–µ—Ä–∞—Ä—Ö–∏—è

```java
java.util.concurrent.ArrayBlockingQueue<E>
```

üîó –ù–∞—Å–ª–µ–¥—É–µ—Ç:

```java
AbstractQueue<E> ‚Üí Queue<E> ‚Üí Collection<E>
           ‚Ü≥ implements BlockingQueue<E>
```


###### üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞        | –ó–Ω–∞—á–µ–Ω–∏–µ                                    |
| --------------------- | ------------------------------------------- |
| üìê –†–∞–∑–º–µ—Ä             | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π (—É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ)   |
| ‚öôÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è         | –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ **–º–∞—Å—Å–∏–≤–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã** |
| üîê –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | ‚úÖ –î–∞ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ReentrantLock`) |
| üßµ –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è        | ‚úÖ –î–∞ (–ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏)             |
| üßº FIFO               | ‚úÖ –î–∞ (–ø–µ—Ä–≤—ã–π –ø—Ä–∏—à—ë–ª ‚Äî –ø–µ—Ä–≤—ã–π —É—à—ë–ª)          |
| üö´ `null` —ç–ª–µ–º–µ–Ω—Ç—ã    | ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ                                 |


###### üß± –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

```java
final Object[] items;             // —Å–∞–º –º–∞—Å—Å–∏–≤
int takeIndex, putIndex, count;   // –∏–Ω–¥–µ–∫—Å—ã –≥–æ–ª–æ–≤—ã/—Ö–≤–æ—Å—Ç–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
ReentrantLock lock;               // –µ–¥–∏–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
Condition notEmpty, notFull;      // —É—Å–ª–æ–≤–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è
```

üîÅ –ö–æ–ª—å—Ü–µ–≤–∞—è –æ—á–µ—Ä–µ–¥—å: –∏–Ω–¥–µ–∫—Å—ã —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –ø–æ –∫—Ä—É–≥—É ‚Äî –∫–æ–≥–¥–∞ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –∫–æ–Ω—Ü–∞ –º–∞—Å—Å–∏–≤–∞, –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ.


###### üß∞ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã

```java
ArrayBlockingQueue(int capacity)
ArrayBlockingQueue(int capacity, boolean fair)
ArrayBlockingQueue(int capacity, boolean fair, Collection<? extends E> c)
```

* `capacity` ‚Äî —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
* `fair` ‚Äî —Ä–µ–∂–∏–º —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç–∏ (`true` = FIFO –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ—Ç–æ–∫–æ–≤, –º–æ–∂–µ—Ç —Å–Ω–∏–∂–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)


###### ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è  | –ú–µ—Ç–æ–¥                           | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                                             |
| ---------- | ------------------------------- | ----------------------------------------------------- |
| ‚úÖ –í—Å—Ç–∞–≤–∫–∞  | `add(e)`                        | –¥–æ–±–∞–≤–ª—è–µ—Ç, `IllegalStateException` –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø–æ–ª–Ω–∞ |
|            | `offer(e)`                      | –¥–æ–±–∞–≤–ª—è–µ—Ç, `false` –µ—Å–ª–∏ –ø–æ–ª–Ω–∞                         |
|            | `put(e)`                        | –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –º–µ—Å—Ç–æ                   |
|            | `offer(e, timeout, unit)`       | –∂–¥—ë—Ç –¥–æ —Ç–∞–π–º–∞—É—Ç–∞, –ª–∏–±–æ –≤—Å—Ç–∞–≤–ª—è–µ—Ç                      |
| ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ | `remove()`                      | —É–¥–∞–ª—è–µ—Ç, `NoSuchElementException` –µ—Å–ª–∏ –ø—É—Å—Ç–∞          |
|            | `poll()`                        | —É–¥–∞–ª—è–µ—Ç, `null` –µ—Å–ª–∏ –ø—É—Å—Ç–∞                            |
|            | `take()`                        | –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è —ç–ª–µ–º–µ–Ω—Ç                 |
|            | `poll(timeout, unit)`           | –∂–¥—ë—Ç –¥–æ —Ç–∞–π–º–∞—É—Ç–∞, –ª–∏–±–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç                      |
| ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä | `peek()`                        | –ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç –≤ –≥–æ–ª–æ–≤—É (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)                |
| ‚úÖ –†–∞–∑–º–µ—Ä   | `size()`, `remainingCapacity()` | —É–∑–Ω–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∏–ª–∏ –æ—Å—Ç–∞—Ç–æ–∫                             |


###### üßµ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏

* –ü–æ—Ç–æ–∫–∏ **–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π** –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å **–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞**
* –ü–æ—Ç–æ–∫–∏ **–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π** –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å **–ø—É—Å—Ç–∞**
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **Condition-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ**`notEmpty` –∏ `notFull` –¥–ª—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤


###### üíª –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
ArrayBlockingQueue<String> queue = new ArrayBlockingQueue<>(3);

// –ü–æ—Ç–æ–∫-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å
new Thread(() -> {
    try {
        queue.put("A");
        queue.put("B");
        queue.put("C");
        System.out.println("–í—Å—ë –¥–æ–±–∞–≤–ª–µ–Ω–æ");
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();

// –ü–æ—Ç–æ–∫-–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å
new Thread(() -> {
    try {
        Thread.sleep(1000);
        System.out.println(queue.take()); // A
        System.out.println(queue.take()); // B
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();
```


###### üß† –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ArrayBlockingQueue`?

‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ, –µ—Å–ª–∏:

* –Ω—É–∂–µ–Ω **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä**
* –≤–∞–∂–Ω–∞ **–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö**
* —Ö–æ—Ç–∏—Ç–µ **—É–ø—Ä–∞–≤–ª—è—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å—é** –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è–º–∏ –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏
* –Ω—É–∂–Ω–∞ **FIFO**-–æ—á–µ—Ä–µ–¥—å —Å –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ **–Ω–∏–∑–∫–∏–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏**


###### ‚ùó –í–∞–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å

* `null` –∑–∞–ø—Ä–µ—â—ë–Ω ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç `NullPointerException`
* –ü—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ `put()` –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫, –ø–æ–∫–∞ –Ω–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è –º–µ—Å—Ç–æ
* **–û–¥–∏–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π** `lock` ‚Äî —É–∑–∫–æ–µ –º–µ—Å—Ç–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
* –ü—Ä–∏ `fair=true` –ø–æ—Ä—è–¥–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Ç–æ–∫–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è **—Å—Ç—Ä–æ–≥–æ FIFO** ‚Üí –Ω–∏–∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å


***

# LinkedBlockingQueue


**`LinkedBlockingQueue`** ‚Äî —ç—Ç–æ **–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—á–µ—Ä–µ–¥—å FIFO**, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ **–¥–≤—É—Å–≤—è–∑–Ω–æ–º —Å–ø–∏—Å–∫–µ** –∏ –ø–æ–¥—Ö–æ–¥—è—â–∞—è –¥–ª—è **–º–æ–¥–µ–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å‚Äì–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å**. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π**, —Ç–∞–∫ –∏ **–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π** —Ä–∞–∑–º–µ—Ä.


###### üì¶ –ö–ª–∞—Å—Å –∏ –∏–µ—Ä–∞—Ä—Ö–∏—è

```java
java.util.concurrent.LinkedBlockingQueue<E>
```

üß¨ –ù–∞—Å–ª–µ–¥—É–µ—Ç:

```java
AbstractQueue<E> ‚Üí Queue<E> ‚Üí Collection<E>
‚Ü≥ implements BlockingQueue<E>
```


###### üß† –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞           | –ó–Ω–∞—á–µ–Ω–∏–µ                                                                       |
| ------------------------ | ------------------------------------------------------------------------------ |
| üìê –†–∞–∑–º–µ—Ä                | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é **–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω** (Integer.MAX\_VALUE), –Ω–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ |
| üîó –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö      | **–î–≤—É—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫**                                                          |
| ‚è±Ô∏è –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è           | ‚úÖ –î–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ `take()`, `put()`)                                             |
| üîê –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è      | ‚úÖ –î–∞                                                                           |
| üîÑ FIFO                  | ‚úÖ –î–∞                                                                           |
| üö´ `null` –∑–Ω–∞—á–µ–Ω–∏—è       | ‚ùå –ù–µ–ª—å–∑—è –≤—Å—Ç–∞–≤–ª—è—Ç—å `null`                                                      |
| üßµ –†–∞–∑–¥–µ–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–µ `ReentrantLock` –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏                                |


###### üîß –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã

```java
LinkedBlockingQueue()
LinkedBlockingQueue(int capacity)
LinkedBlockingQueue(Collection<? extends E> c)
```

* –ï—Å–ª–∏ `capacity` –Ω–µ —É–∫–∞–∑–∞–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Integer.MAX_VALUE`
* ‚ö†Ô∏è –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å **OutOfMemoryError**, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–µ–µ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π


###### üìö –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

```java
static class Node<E> {
    E item;
    Node<E> next;
}
```

–í–Ω—É—Ç—Ä–∏:

* üîó `head`, `tail` ‚Äî —É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞
* üîí `putLock` –∏ `takeLock` ‚Äî **–¥–≤–∞ —Ä–∞–∑–¥–µ–ª—å–Ω—ã—Ö –∑–∞–º–∫–∞** (–ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
* üõéÔ∏è `notEmpty`, `notFull` ‚Äî `Condition` –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è

üìç –≠—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `ArrayBlockingQueue`, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–æ–¥–∏–Ω –æ–±—â–∏–π** `lock`.


###### ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è   | –ú–µ—Ç–æ–¥                     | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                              |
| ----------- | ------------------------- | -------------------------------------- |
| ‚úÖ –í—Å—Ç–∞–≤–∫–∞   | `add(e)`                  | –¥–æ–±–∞–≤–ª—è–µ—Ç, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ |
|             | `offer(e)`                | –¥–æ–±–∞–≤–ª—è–µ—Ç, `false` –µ—Å–ª–∏ –ø–æ–ª–Ω–∞          |
|             | `put(e)`                  | –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –ø–æ–ª–Ω–∞                |
|             | `offer(e, timeout, unit)` | –∂–¥—ë—Ç –¥–æ —Ç–∞–π–º–∞—É—Ç–∞                       |
| üßº –£–¥–∞–ª–µ–Ω–∏–µ | `remove()`                | —É–¥–∞–ª—è–µ—Ç –≥–æ–ª–æ–≤—É, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –ø—É—Å—Ç–∞  |
|             | `poll()`                  | –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`, –µ—Å–ª–∏ –ø—É—Å—Ç–∞          |
|             | `take()`                  | –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –ø—É—Å—Ç–∞                |
|             | `poll(timeout, unit)`     | –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ —Ç–∞–π–º–∞—É—Ç–∞                |
| üîé –ü—Ä–æ—Å–º–æ—Ç—Ä | `peek()`                  | —Å–º–æ—Ç—Ä–∏—Ç –≤ –≥–æ–ª–æ–≤—É –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è          |


###### üßµ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏


* –ü–æ—Ç–æ–∫–∏ **–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π** –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏ (–µ—Å–ª–∏ –æ–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞)
* –ü–æ—Ç–æ–∫–∏ **–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π** –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø—É—Å—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–∞ `ReentrantLock`:
  * –æ–¥–∏–Ω –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
  * –æ–¥–∏–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    ‚Üí üîÅ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏ –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ **–º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**.


###### üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
LinkedBlockingQueue<String> queue = new LinkedBlockingQueue<>(3);

new Thread(() -> {
    try {
        queue.put("A");
        queue.put("B");
        queue.put("C");
        System.out.println("–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: –≤—Å—ë –¥–æ–±–∞–≤–ª–µ–Ω–æ");
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();

new Thread(() -> {
    try {
        Thread.sleep(1000);
        System.out.println("–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å: " + queue.take());
        System.out.println("–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å: " + queue.take());
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();
```


***

# –û—á–µ—Ä–µ–¥—å –ú–∞–π–∫–ª–∞-–°–∫–æ—Ç—Ç–∞


**–û—á–µ—Ä–µ–¥—å –ú–∞–π–∫–ª–∞-–°–∫–æ—Ç—Ç–∞ (MSQueue)** ‚Äî —ç—Ç–æ **–±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è, –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è (lock-free) FIFO-–æ—á–µ—Ä–µ–¥—å**, —Ä–∞–±–æ—Ç–∞—é—â–∞—è –≤ **–º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏**, –∏—Å–ø–æ–ª—å–∑—É—é—â–∞—è **–∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ CAS (Compare-And-Swap)** –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏.

üìå –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –ú–∞–π–∫–ª–æ–º –°–∫–æ—Ç—Ç–æ–º (Michael Scott) –∏ –µ–≥–æ –∫–æ–ª–ª–µ–≥–æ–π Trevor L. Harris –≤ 1996 –≥–æ–¥—É.


###### üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –°–≤–æ–π—Å—Ç–≤–æ               | –ó–Ω–∞—á–µ–Ω–∏–µ                 |
| ---------------------- | ------------------------ |
| üßµ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  | ‚úÖ –î–∞ (lock-free)         |
| üîê –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏          | ‚ùå –ù–µ—Ç                    |
| üîÅ FIFO –ø–æ—Ä—è–¥–æ–∫        | ‚úÖ –î–∞                     |
| üö´ –†–∞–∑–º–µ—Ä              | –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω              |
| ‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º            | CAS (Compare-And-Swap)   |
| üîÅ –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞         | –û–¥–Ω–æ—Å–≤—è–∑–Ω–æ–º —Å–ø–∏—Å–∫–µ       |
| üìç –ü–æ–¥–¥–µ—Ä–∂–∫–∞ wait-free | ‚ùå –ù–µ—Ç (—Ç–æ–ª—å–∫–æ lock-free) |


###### ‚öôÔ∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—á–µ—Ä–µ–¥–∏

–û—á–µ—Ä–µ–¥—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –Ω–∞ **–æ–¥–Ω–æ—Å–≤—è–∑–Ω–æ–º —Å–ø–∏—Å–∫–µ**, —Å **–¥–≤—É–º—è —É–∫–∞–∑–∞—Ç–µ–ª—è–º–∏**:

* `head` ‚Äî –≥–æ–ª–æ–≤–∞ (—Å–Ω–∏–º–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã)
* `tail` ‚Äî —Ö–≤–æ—Å—Ç (–¥–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã)

–ö–∞–∂–¥—ã–π —É–∑–µ–ª —Å–æ–¥–µ—Ä–∂–∏—Ç:

```java
class Node<T> {
    volatile T value;
    AtomicReference<Node<T>> next;
}
```

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:

```java
Node dummy = new Node(null); // —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π —É–∑–µ–ª
AtomicReference<Node> head = new AtomicReference<>(dummy);
AtomicReference<Node> tail = new AtomicReference<>(dummy);
```

üìå –§–∏–∫—Ç–∏–≤–Ω—ã–π —É–∑–µ–ª –Ω—É–∂–µ–Ω –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏: –æ—á–µ—Ä–µ–¥—å **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É—Å—Ç–∞**, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.


###### üîÅ –û–ø–µ—Ä–∞—Ü–∏–∏

‚ûï `enqueue(T value)`

1. –°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π —É–∑–µ–ª `node(value)`
2. CAS-—Å—Å—ã–ª–∫–æ–π `tail.next.compareAndSet(null, node)` —É–∑–µ–ª –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü
3. CAS-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `tail` –Ω–∞ –Ω–æ–≤—ã–π —É–∑–µ–ª (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–æ –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º)

> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ‚Äî —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π **–ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞** (lock-free).

‚ûñ `dequeue()`

1. –°–º–æ—Ç—Ä–∏–º `head.next`:
   * –µ—Å–ª–∏ `null` ‚Üí –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞
   * –∏–Ω–∞—á–µ `CAS(head, head.next)` ‚Äî —Å–¥–≤–∏–≥–∞–µ–º –≥–æ–ª–æ–≤—É
2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –Ω–æ–≤–æ–≥–æ `head`


###### ‚ò¢Ô∏è –ü–æ—á–µ–º—É **lock-free**?

–û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (`synchronized`, `ReentrantLock` –∏ —Ç.–ø.), –∞ —Ç–æ–ª—å–∫–æ:

* –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
* —Ü–∏–∫–ª—ã —Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π (spin-loop)
* CAS (Compare-And-Set)

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ **–µ—Å–ª–∏ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –∑–∞–≤–∏—Å, –¥—Ä—É–≥–∏–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è** ‚Üí —Ö–æ—Ä–æ—à–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å.


###### üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ Java (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)

```java
public class MSQueue<T> {
    static class Node<T> {
        final T value;
        final AtomicReference<Node<T>> next = new AtomicReference<>(null);

        Node(T value) {
            this.value = value;
        }
    }

    private final AtomicReference<Node<T>> head;
    private final AtomicReference<Node<T>> tail;

    public MSQueue() {
        Node<T> dummy = new Node<>(null);
        head = new AtomicReference<>(dummy);
        tail = new AtomicReference<>(dummy);
    }

    public void enqueue(T value) {
        Node<T> node = new Node<>(value);
        while (true) {
            Node<T> last = tail.get();
            Node<T> next = last.next.get();
            if (next == null) {
                if (last.next.compareAndSet(null, node)) {
                    tail.compareAndSet(last, node);
                    return;
                }
            } else {
                tail.compareAndSet(last, next);
            }
        }
    }

    public T dequeue() {
        while (true) {
            Node<T> first = head.get();
            Node<T> next = first.next.get();
            if (next == null) return null;
            if (head.compareAndSet(first, next)) {
                return next.value;
            }
        }
    }
}
```


###### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

* üöÄ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ –º–Ω–æ–≥–æ—è–¥–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
* üí• –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ ‚Üí –Ω–µ—Ç deadlock‚Äô–æ–≤
* ‚öôÔ∏è –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ (–≤—Å–µ–≥–æ –¥–≤–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è)


###### ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

* ‚ùó –ù—É–∂–Ω—ã –∑–Ω–∞–Ω–∏—è –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
* ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ ABA-–ø—Ä–æ–±–ª–µ–º–µ (—Ä–µ—à–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `AtomicStampedReference` –∏–ª–∏ GC)
* ‚ùå –ù–µ wait-free: –º–æ–∂–µ—Ç –∑–∞—Å—Ç—Ä—è—Ç—å –≤ CAS-–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è—Ö


***

# SynchronousQueue


**`SynchronousQueue`** ‚Äî —ç—Ç–æ **–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—á–µ—Ä–µ–¥—å**, –≤ –∫–æ—Ç–æ—Ä–æ–π **–∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–Ω–∞ –∂–¥–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è**, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.

üìå –≠—Ç–æ **–æ—á–µ—Ä–µ–¥—å –±–µ–∑ –±—É—Ñ–µ—Ä–∞** ‚Äî –æ–Ω–∞ **–Ω–µ —Ö—Ä–∞–Ω–∏—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤–æ–æ–±—â–µ**.


###### üì¶ –ö–ª–∞—Å—Å –∏ –∏–µ—Ä–∞—Ä—Ö–∏—è

```java
java.util.concurrent.SynchronousQueue<E>
```

üß¨ –ù–∞—Å–ª–µ–¥—É–µ—Ç:

```java
AbstractQueue<E> ‚Üí Queue<E> ‚Üí Collection<E>
‚Ü≥ implements BlockingQueue<E>
```


###### üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –°–≤–æ–π—Å—Ç–≤–æ            | –ó–Ω–∞—á–µ–Ω–∏–µ                                         |
| ------------------- | ------------------------------------------------ |
| üì• –ë—É—Ñ–µ—Ä            | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (0 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)                      |
| ‚è±Ô∏è –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è      | ‚úÖ –î–∞ (–æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –∂–¥—É—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞)               |
| üîê –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è | ‚úÖ –î–∞                                             |
| üîÑ FIFO             | ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é LIFO)         |
| üßµ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤   | `ThreadPoolExecutor`, `hand-off` —Å–∏—Å—Ç–µ–º–∞—Ö        |
| ‚öôÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è       | CAS + —Å–ø–∏–Ω–ª–æ–∫–∏ (TransferQueue –∏–ª–∏ TransferStack) |
| üìç `null` —ç–ª–µ–º–µ–Ω—Ç—ã  | ‚ùå –ù–µ–ª—å–∑—è                                         |


###### üîÅ –ü–æ–≤–µ–¥–µ–Ω–∏–µ

* **Producer** (–≤—Å—Ç–∞–≤–∫–∞) –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ **Consumer** –Ω–µ –∑–∞–±–µ—Ä—ë—Ç —ç–ª–µ–º–µ–Ω—Ç.
* **Consumer** (—á—Ç–µ–Ω–∏–µ) –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ **Producer** –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç —ç–ª–µ–º–µ–Ω—Ç.

> üí° –≠—Ç–æ **‚Äú—Ä—É–∫–æ–ø–æ–∂–∞—Ç–Ω–∞—è‚Äù –ø–µ—Ä–µ–¥–∞—á–∞** ‚Äî **–æ–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É**.


###### ‚öôÔ∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã

```java
SynchronousQueue()
SynchronousQueue(boolean fair)
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä     | –ó–Ω–∞—á–µ–Ω–∏–µ                                            |
| ------------ | --------------------------------------------------- |
| `fair=false` | üöÄ –ë—ã—Å—Ç—Ä—ã–π, LIFO (stack-based) —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `fair=true`  | ‚úÖ FIFO —Ä–µ–∂–∏–º (–æ—á–µ—Ä–µ–¥—å `TransferQueue`)              |


###### üß™ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```java
SynchronousQueue<String> queue = new SynchronousQueue<>();

new Thread(() -> {
    try {
        System.out.println("–ü—Ä–æ–±—É—é –≤—Å—Ç–∞–≤–∏—Ç—å...");
        queue.put("–ü—Ä–∏–≤–µ—Ç");
        System.out.println("–í—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();

new Thread(() -> {
    try {
        Thread.sleep(1000);
        System.out.println("–ü–æ–ª—É—á–µ–Ω–æ: " + queue.take());
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}).start();
```

üìå –ü–æ—Ç–æ–∫ —Å `put()` –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –ø–æ–∫–∞ `take()` –Ω–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –≤–æ –≤—Ç–æ—Ä–æ–º –ø–æ—Ç–æ–∫–µ.


###### üìö –ú–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                       | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                                             |
| --------------------------- | ----------------------------------------------------- |
| `put(E e)`                  | –ë–ª–æ–∫–∏—Ä—É–µ—Ç, –ø–æ–∫–∞ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –Ω–µ –≤—ã–∑–æ–≤–µ—Ç `take()`      |
| `take()`                    | –ë–ª–æ–∫–∏—Ä—É–µ—Ç, –ø–æ–∫–∞ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –Ω–µ –≤—ã–∑–æ–≤–µ—Ç `put()`       |
| `offer(E e)`                | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`, –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è              |
| `poll()`                    | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null`, –µ—Å–ª–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞                  |
| `offer(E e, timeout, unit)` | –ñ–¥—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å   |
| `poll(timeout, unit)`       | –ñ–¥—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å |


###### üì¶ –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `fair`:


`fair=false` ‚Üí `TransferStack`

–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É LIFO (stack)

–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –∫–ª–∞–¥—É—Ç/–∑–∞–±–∏—Ä–∞—é—Ç —Å –≤–µ—Ä—à–∏–Ω—ã —Å—Ç–µ–∫–∞

–ë—ã—Å—Ç—Ä–µ–µ, –Ω–æ –Ω–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π


`fair=true` ‚Üí `TransferQueue`

–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ FIFO

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤—É—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ—Ç–æ–∫–æ–≤

–ë–æ–ª–µ–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ


–û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç:

`Unsafe.compareAndSwapObject` (CAS)

spin-loops

volatile –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ


###### üìå –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SynchronousQueue`?

–í **`ThreadPoolExecutor`** —Å –Ω—É–ª–µ–≤—ã–º **queueCapacity`**

```java
new ThreadPoolExecutor(0, Integer.MAX_VALUE,
        60L, TimeUnit.SECONDS,
        new SynchronousQueue<>());
```

‚Üí –ö–∞–∂–¥—ã–π —Ç–∞—Å–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Ç–æ–∫ (–±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏)

* –î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ **‚Äú—Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏‚Äù** –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ (–±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)


###### ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ª–æ–≤—É—à–∫–∏

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                         | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è                                 |
| ----------------------------------- | ------------------------------------------- |
| ‚ùå –ù–µ—Ç –±—É—Ñ–µ—Ä–∞                        | `put()` –∑–∞–≤–∏—Å–Ω–µ—Ç, –µ—Å–ª–∏ –Ω–µ—Ç `take()`         |
| ‚ùå `peek()` –∏–ª–∏ `iterator()`         | –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è                           |
| ‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ—Ç –æ–±–∞ –ø–æ—Ç–æ–∫–∞             | –ë—É–¥—å—Ç–µ –∞–∫–∫—É—Ä–∞—Ç–Ω—ã —Å `deadlock`               |
| üîÑ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∂–∏–º–∞      | `fair=true` ‚Üí FIFO, –∏–Ω–∞—á–µ ‚Üí LIFO            |
| üî• –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `Executors` | –ù–∞–ø—Ä–∏–º–µ—Ä, `Executors.newCachedThreadPool()` |


***

# –û—Ç–ª–∏—á–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π –≤ `java.util.concurrent`


###### üß≠ –û–±–∑–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π:

| –û—á–µ—Ä–µ–¥—å                 | –¢–∏–ø        | –ë—É—Ñ–µ—Ä | –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å   | –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è | –û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞          |
| ----------------------- | ---------- | ----- | -------------------- | ----------- | -------------------- |
| `ArrayBlockingQueue`    | FIFO       | ‚úÖ –î–∞  | ‚úÖ –î–∞ (ReentrantLock) | ‚úÖ –î–∞        | –ö–æ–ª—å—Ü–µ–≤–æ–π –º–∞—Å—Å–∏–≤     |
| `LinkedBlockingQueue`   | FIFO       | ‚úÖ –î–∞  | ‚úÖ –î–∞ (–¥–≤–∞ Lock'–∞)    | ‚úÖ –î–∞        | –°–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫       |
| `SynchronousQueue`      | Handoff    | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (CAS)           | ‚úÖ –î–∞        | Stack/Queue (fair)   |
| `PriorityBlockingQueue` | –° –ø—Ä–∏–æ—Ä.   | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞                 | ‚úÖ –î–∞        | –ú–∞—Å—Å–∏–≤ + heap        |
| `DelayQueue`            | –ü–æ —Ç–∞–π–º–µ—Ä—É | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞                 | ‚úÖ –î–∞        | PriorityQueue        |
| `ConcurrentLinkedQueue` | FIFO       | ‚úÖ –î–∞  | ‚úÖ –î–∞ (CAS)           | ‚ùå –ù–µ—Ç       | –û–¥–Ω–æ—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫   |
| `LinkedTransferQueue`   | FIFO       | ‚úÖ –î–∞  | ‚úÖ –î–∞ (CAS)           | ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ  | –°–ø–∏—Å–æ–∫               |
| `BlockingDeque`         | –î–≤—É—Å—Ç–æ—Ä–æ–Ω. | ‚úÖ –î–∞  | ‚úÖ –î–∞                 | ‚úÖ –î–∞        | –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –æ—á–µ—Ä–µ–¥—å |


###### ArrayBlockingQueue

| –°–≤–æ–π—Å—Ç–≤–æ           | –ó–Ω–∞—á–µ–Ω–∏–µ                                                       |
| ------------------ | -------------------------------------------------------------- |
| üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞       | –ú–∞—Å—Å–∏–≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞                                  |
| üßµ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞ | ‚úÖ –î–∞, `ReentrantLock` (–æ–¥–∏–Ω)                                   |
| ‚è≥ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞       | –î–∞ ‚Äî –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏/–æ–ø—É—Å—Ç–æ—à–µ–Ω–∏–∏                                |
| üí¨ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ      | –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á, –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã          | –û–±—â–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚Äî –º–µ–Ω—å—à–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞                         |


###### LinkedBlockingQueue

| –°–≤–æ–π—Å—Ç–≤–æ        | –ó–Ω–∞—á–µ–Ω–∏–µ                                         |
| --------------- | ------------------------------------------------ |
| üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞    | –û–¥–Ω–æ—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫ (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| üîê –î–≤–∞ Lock'–∞   | `putLock` –∏ `takeLock` ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞     |
| ‚öñÔ∏è –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ | –í—ã—à–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –ø–æ—Ç–æ–∫–æ–≤    |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã       | –ú–æ–∂–µ—Ç —Å—ä–µ—Å—Ç—å –≤—Å—é –ø–∞–º—è—Ç—å, –µ—Å–ª–∏ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω       |


###### SynchronousQueue

| –°–≤–æ–π—Å—Ç–≤–æ      | –ó–Ω–∞—á–µ–Ω–∏–µ                                          |
| ------------- | ------------------------------------------------- |
| üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞  | –ë–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 1 `put()` ‚Üî 1 `take()`              |
| üîÑ –ü–æ–≤–µ–¥–µ–Ω–∏–µ  | –ü–æ—Ç–æ–∫–∏ "—Ä—É–∫–æ–ø–æ–∂–∏–º–∞—é—Ç" –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é             |
| ‚öôÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | CAS, TransferStack/TransferQueue                  |
| üí¨ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ | `Executors.newCachedThreadPool()`, handoff        |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã     | –ù–µ—Ç `peek()`, `iterator()`, –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è |


###### PriorityBlockingQueue

| –°–≤–æ–π—Å—Ç–≤–æ       | –ó–Ω–∞—á–µ–Ω–∏–µ                                                 |
| -------------- | -------------------------------------------------------- |
| üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞   | –ú–∞—Å—Å–∏–≤ (heap-–¥–µ—Ä–µ–≤–æ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É)                       |
| ü•á –ü–æ—Ä—è–¥–æ–∫     | –ù–µ FIFO, –∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π (`Comparable` –∏–ª–∏ `Comparator`)  |
| ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å | –≠–ª–µ–º–µ–Ω—Ç—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –ø–æ—Ä—è–¥–æ–∫ |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã      | –ù–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è `remove(Object)`                  |


###### DelayQueue

| –°–≤–æ–π—Å—Ç–≤–æ         | –ó–Ω–∞—á–µ–Ω–∏–µ                                                |
| ---------------- | ------------------------------------------------------- |
| ‚è±Ô∏è –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏** |
| üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞     | PriorityQueue –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏                         |
| üí¨ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ    | –¢–∞–π–º–µ—Ä—ã, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ –∑–∞–¥–∞—á                             |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã        | –≠–ª–µ–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å `Delayed`                 |


###### ConcurrentLinkedQueue

| –°–≤–æ–π—Å—Ç–≤–æ       | –ó–Ω–∞—á–µ–Ω–∏–µ                                              |
| -------------- | ----------------------------------------------------- |
| üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞   | –û–¥–Ω–æ—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫                                    |
| üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è  | Lock-free —á–µ—Ä–µ–∑ CAS                                   |
| ‚úÖ Non-blocking | –ù–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è: `offer`, `poll`, `peek`                 |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã      | –í –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö –≤–æ–∑–º–æ–∂–µ–Ω —Ä–æ—Å—Ç –ø–∞–º—è—Ç–∏ –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è |
| üí¨ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ  | –í—ã—Å–æ–∫–æ–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é       |


###### LinkedTransferQueue

| –°–≤–æ–π—Å—Ç–≤–æ       | –ó–Ω–∞—á–µ–Ω–∏–µ                                                       |
| -------------- | -------------------------------------------------------------- |
| üì¶ –ö–æ–º–±–∏–Ω–∞—Ü–∏—è  | `LinkedBlockingQueue` + `SynchronousQueue`                     |
| üßµ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `tryTransfer`, `transfer`, `hasWaitingConsumer()` |
| üí¨ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ  | –ö–æ–≥–¥–∞ –≤–∞–∂–Ω–æ, –±—ã–ª –ª–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å –≥–æ—Ç–æ–≤ –∫ –ø–µ—Ä–µ–¥–∞—á–µ               |
| ‚ö†Ô∏è –ú–∏–Ω—É—Å—ã      | –°–ª–æ–∂–Ω–µ–µ –≤ –æ—Ç–ª–∞–¥–∫–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏                            |


###### BlockingDeque

| –°–≤–æ–π—Å—Ç–≤–æ         | –ó–Ω–∞—á–µ–Ω–∏–µ                                                    |
| ---------------- | ----------------------------------------------------------- |
| üîÅ –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è  | –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å –∏ –∑–∞–±–∏—Ä–∞—Ç—å —Å –æ–±–æ–∏—Ö –∫–æ–Ω—Ü–æ–≤                   |
| üì¶ –ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏–∏ | `LinkedBlockingDeque`, `ArrayDeque` (–Ω–µ –±–ª–æ–∫–∏—Ä.)            |
| üí¨ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ    | –°—Ç–µ–∫/–æ—á–µ—Ä–µ–¥—å –≤ –æ–¥–Ω–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞, backtracking) |


###### üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–∫–∏/—É–¥–∞–ª–µ–Ω–∏—è/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

| –û—á–µ—Ä–µ–¥—å               | `put()` / `take()` | `offer()` / `poll()` | `peek()` | FIFO | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞        |
| --------------------- | ------------------ | -------------------- | -------- | ---- | ----------------- |
| ArrayBlockingQueue    | ‚úÖ                  | ‚úÖ                    | ‚úÖ        | ‚úÖ    | ‚úÖ                 |
| LinkedBlockingQueue   | ‚úÖ                  | ‚úÖ                    | ‚úÖ        | ‚úÖ    | ‚úÖ                 |
| SynchronousQueue      | ‚úÖ                  | ‚úÖ                    | ‚ùå        | ‚ö†Ô∏è   | ‚úÖ                 |
| PriorityBlockingQueue | ‚úÖ                  | ‚úÖ                    | ‚úÖ        | ‚ùå    | ‚úÖ                 |
| DelayQueue            | ‚úÖ                  | ‚úÖ                    | ‚úÖ        | ‚ùå    | ‚úÖ                 |
| ConcurrentLinkedQueue | ‚ùå                  | ‚úÖ                    | ‚úÖ        | ‚úÖ    | ‚ùå                 |
| LinkedTransferQueue   | ‚úÖ                  | ‚úÖ                    | ‚úÖ        | ‚úÖ    | ‚úÖ/‚ùå (–ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏) |


###### üß† –ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –æ—á–µ—Ä–µ–¥—å?

| –ù—É–∂–¥–∞ / –£—Å–ª–æ–≤–∏–µ                               | –ü–æ–¥—Ö–æ–¥—è—â–∞—è –æ—á–µ—Ä–µ–¥—å                                       |
| --------------------------------------------- | -------------------------------------------------------- |
| ‚úÖ –ù—É–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏             | `ArrayBlockingQueue` –∏–ª–∏ `LinkedBlockingQueue(capacity)` |
| üîÅ –í—ã—Å–æ–∫–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å + –ø–æ—Ç–æ–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã | `LinkedBlockingQueue` (2 lock‚Äô–∞)                         |
| üîÑ –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –∫–ª–∞–¥—ë—Ç ‚Äî –¥—Ä—É–≥–æ–π —Å—Ä–∞–∑—É –∑–∞–±–∏—Ä–∞–µ—Ç  | `SynchronousQueue`                                       |
| üß© –í–∞–∂–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤                  | `PriorityBlockingQueue`                                  |
| üïì –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤             | `DelayQueue`                                             |
| üöÄ –ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –≤—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | `ConcurrentLinkedQueue`                                  |
| üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π –¥–æ –≤—Å—Ç–∞–≤–∫–∏        | `LinkedTransferQueue`                                    |
| ‚ÜîÔ∏è –ù—É–∂–Ω–∞ –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –æ—á–µ—Ä–µ–¥—å                | `BlockingDeque` (`LinkedBlockingDeque`)                  |


***

# –°—Ç–µ–∫ –¢—Ä–∞–π–±–µ—Ä–∞ (Treiber Stack)


**Treiber Stack** ‚Äî —ç—Ç–æ **lock-free** (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π) —Å—Ç–µ–∫ (LIFO), —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **–∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π CAS (Compare-And-Swap)**.
–ü—Ä–µ–¥–ª–æ–∂–µ–Ω –†–æ–±–µ—Ä—Ç–æ–º –¢—Ä–∞–π–±–µ—Ä–æ–º (Robert Treiber) –≤ 1986 –≥–æ–¥—É.

üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è: –≤—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ **–∞—Ç–æ–º–∞—Ä–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥–æ–ª–æ–≤—ã —Å—Ç–µ–∫–∞**.


###### ‚öôÔ∏è –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ

```java
class Node<T> {
    T value;
    Node<T> next;
}
```

–°–∞–º —Å—Ç–µ–∫:

```java
AtomicReference<Node<T>> head = new AtomicReference<>(null);
```

–¢–æ –µ—Å—Ç—å —Å—Ç–µ–∫ ‚Äî —ç—Ç–æ **–æ–¥–Ω–æ—Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫**, –≥–¥–µ `head` ‚Äî –≤–µ—Ä—à–∏–Ω–∞, –∏ –≤—Å—è —Ä–∞–±–æ—Ç–∞ –≤–µ–¥—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å –Ω–∏–º.


###### üîÅ –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:

‚ûï `push(T value)`

–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —É–∑–µ–ª `newNode(value)`

–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π `head` –∫–∞–∫ `oldHead`

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `newNode.next = oldHead`

CAS: –ø—ã—Ç–∞–µ–º—Å—è `head.compareAndSet(oldHead, newNode)`

–µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Äî –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

–∏–Ω–∞—á–µ ‚Äî –ø–æ–≤—Ç–æ—Ä—è–µ–º (retry loop)

üîÅ –í–µ—Å—å push —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ü–∏–∫–ª–µ: CAS –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ `head` —É–∂–µ –æ–±–Ω–æ–≤–∏–ª—Å—è –¥—Ä—É–≥–∏–º –ø–æ—Ç–æ–∫–æ–º.



‚ûñ `T pop()`

–ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π `head` –∫–∞–∫ `oldHead`

–ï—Å–ª–∏ `oldHead == null` ‚Üí —Å—Ç–µ–∫ –ø—É—Å—Ç

–°–æ—Ö—Ä–∞–Ω—è–µ–º `next = oldHead.next`

CAS: `head.compareAndSet(oldHead, next)`

 –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `oldHead.value`

–∏–Ω–∞—á–µ ‚Äî –ø–æ–≤—Ç–æ—Ä—è–µ–º


###### ‚úÖ –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ (–Ω–∞ Java)


```java
public class TreiberStack<T> {
    private static class Node<T> {
        final T value;
        final Node<T> next;
        Node(T value, Node<T> next) {
            this.value = value;
            this.next = next;
        }
    }

    private final AtomicReference<Node<T>> head = new AtomicReference<>(null);

    public void push(T value) {
        Node<T> newNode;
        Node<T> oldHead;
        do {
            oldHead = head.get();
            newNode = new Node<>(value, oldHead);
        } while (!head.compareAndSet(oldHead, newNode));
    }

    public T pop() {
        Node<T> oldHead;
        Node<T> newHead;
        do {
            oldHead = head.get();
            if (oldHead == null) return null;
            newHead = oldHead.next;
        } while (!head.compareAndSet(oldHead, newHead));
        return oldHead.value;
    }
}
```

###### ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

| –°–≤–æ–π—Å—Ç–≤–æ        | –û–ø–∏—Å–∞–Ω–∏–µ                                                                                        |
| --------------- | ----------------------------------------------------------------------------------------------- |
| üîê Lock-free    | ‚úÖ –ù–µ—Ç –Ω–∏ `synchronized`, –Ω–∏ `Lock`                                                              |
| ‚ùå Wait-free     | ‚ùå –û–¥–∏–Ω –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å—Å—è, –µ—Å–ª–∏ CAS –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç                              |
| üí• –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤                                                            |
| ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ ABA | –í–æ–∑–º–æ–∂–Ω–∞ ‚Äî –∫–æ–≥–¥–∞ —É–∑–µ–ª –±—ã–ª —É–¥–∞–ª—ë–Ω –∏ –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–Ω–æ–≤–æ (CAS –¥—É–º–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å) |


###### üß† –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

‚úÖ –ü–ª—é—Å—ã:

üöÄ –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ –º–Ω–æ–≥–æ—è–¥–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

üîì –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ ‚Üí –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `deadlock`

üîÅ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è


‚ùå –ú–∏–Ω—É—Å—ã:

‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞ **ABA-–ø—Ä–æ–±–ª–µ–º–∞**

‚ùå –ù–µ wait-free

‚öôÔ∏è –¢—Ä–µ–±—É–µ—Ç —Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (GC, contention)


***

# ThreadPoolExecutor


**`ThreadPoolExecutor`** ‚Äî —ç—Ç–æ –≥–∏–±–∫–∏–π, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø—É–ª –ø–æ—Ç–æ–∫–æ–≤ –∏–∑ –ø–∞–∫–µ—Ç–∞ `java.util.concurrent`, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ **–º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤** –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–¥–∞—á.

üìå –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:

```java
Executor ‚Üí ExecutorService ‚Üí ThreadPoolExecutor
```


###### üß¨ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã

```java
ThreadPoolExecutor(
    int corePoolSize,
    int maximumPoolSize,
    long keepAliveTime,
    TimeUnit unit,
    BlockingQueue<Runnable> workQueue,
    ThreadFactory threadFactory,
    RejectedExecutionHandler handler
)
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                              |
| ----------------- | ----------------------------------------------------------------------- |
| `corePoolSize`    | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤ (–Ω–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è, –ø–æ–∫–∞ –Ω–µ –∑–∞–∫—Ä—ã—Ç –ø—É–ª)          |
| `maximumPoolSize` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤                                              |
| `keepAliveTime`   | –°–∫–æ–ª—å–∫–æ **–≤—Ä–µ–º–µ–Ω–∏** –ª–∏—à–Ω–∏–µ –ø–æ—Ç–æ–∫–∏ (**—Å–≤–µ—Ä—Ö core**) –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã |
| `unit`            | –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è `keepAliveTime`                                       |
| `workQueue`       | –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (`BlockingQueue<Runnable>`)                               |
| `threadFactory`   | –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ (–∏–º–µ–Ω–∞, –¥–µ–º–æ–Ω—ã –∏ —Ç.–¥.)                                 |
| `handler`         | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ (–æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞, –≤—Å–µ –ø–æ—Ç–æ–∫–∏ –∑–∞–Ω—è—Ç—ã)     |


###### üîÅ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–¥–∞—á–∏

1. –ó–∞–¥–∞—á–∞ –ø–æ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `submit()` –∏–ª–∏ `execute()`.
2. –ï—Å–ª–∏ –º–µ–Ω—å—à–µ `corePoolSize` –ø–æ—Ç–æ–∫–æ–≤ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫.
3. –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç `corePoolSize`, –Ω–æ –µ—Å—Ç—å –º–µ—Å—Ç–æ –≤ `workQueue` ‚Äî –∑–∞–¥–∞—á–∞ —Å—Ç–∞–≤–∏—Ç—Å—è —Ç—É–¥–∞.
4. –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∞, –Ω–æ –µ—â—ë –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Ç–æ–∫ (–¥–æ `maximumPoolSize`) ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫.
5. –ï—Å–ª–∏ –∏ –ø–æ—Ç–æ–∫–æ–≤ –º–∞–∫—Å–∏–º—É–º, –∏ –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞ ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `RejectedExecutionHandler`.


###### üìä –¢–∏–ø—ã –æ—á–µ—Ä–µ–¥–µ–π (workQueue)

| –¢–∏–ø –æ—á–µ—Ä–µ–¥–∏             | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                               |
| ----------------------- | --------------------------------------- |
| `LinkedBlockingQueue`   | –ë–µ–∑—Ä–∞–∑–º–µ—Ä–Ω–∞—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)             |
| `ArrayBlockingQueue`    | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è                            |
| `SynchronousQueue`      | –ë–µ–∑ –±—É—Ñ–µ—Ä–∞: –∫–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Ç–æ–∫ |
| `PriorityBlockingQueue` | –ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º                          |


###### ü§ñ `ThreadFactory`

–ü–æ–∑–≤–æ–ª—è–µ—Ç –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ (–∏–º–µ–Ω–∞, –¥–µ–º–æ–Ω—ã –∏ —Ç.–¥.).

```java
Executors.defaultThreadFactory()
```

–ü—Ä–∏–º–µ—Ä:

```java
new ThreadFactory() {
    public Thread newThread(Runnable r) {
        Thread t = new Thread(r);
        t.setName("MyThread-" + t.getId());
        return t;
    }
}
```


###### ‚ùå –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–∫–∞–∑–æ–≤ (`RejectedExecutionHandler`)

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–Ω—è—Ç–∞ (–Ω–µ—Ç –ø–æ—Ç–æ–∫–æ–≤, –æ—á–µ—Ä–µ–¥—å –ø–æ–ª–Ω–∞):

| –û–±—Ä–∞–±–æ—Ç—á–∏–∫                   | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                            |
| ---------------------------- | ------------------------------------ |
| `AbortPolicy` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | –ë—Ä–æ—Å–∞–µ—Ç `RejectedExecutionException` |
| `CallerRunsPolicy`           | –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É –≤ –≤—ã–∑—ã–≤–∞—é—â–µ–º –ø–æ—Ç–æ–∫–µ |
| `DiscardPolicy`              | –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É             |
| `DiscardOldestPolicy`        | –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É –∏ —Å—Ç–∞–≤–∏—Ç –Ω–æ–≤—É—é |


###### üß™ –ü—Ä–∏–º–µ—Ä

```java
ExecutorService executor = new ThreadPoolExecutor(
    2,              // corePoolSize
    4,              // maximumPoolSize
    60,             // keepAliveTime
    TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(10),   // –æ—á–µ—Ä–µ–¥—å
    Executors.defaultThreadFactory(),
    new ThreadPoolExecutor.AbortPolicy()
);

executor.execute(() -> System.out.println("Hello from thread!"));
```


###### üõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—É–ª–∞

| –ú–µ—Ç–æ–¥                | –û–ø–∏—Å–∞–Ω–∏–µ                                                      |
| -------------------- | ------------------------------------------------------------- |
| `shutdown()`         | –ó–∞–ø—Ä–µ—â–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –∂–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö               |
| `shutdownNow()`      | –ü—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–µ—Ä–≤–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö |
| `awaitTermination()` | –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—É–ª–∞                    |


###### üß† –ü–æ–ª–µ–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                         |
| ------------------------------ | ---------------------------------- |
| `getPoolSize()`                | –¢–µ–∫—É—â–µ–µ —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤              |
| `getActiveCount()`             | –°–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –∑–∞–Ω—è—Ç—ã             |
| `getTaskCount()`               | –°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –±—ã–ª–æ –ø–æ–¥–∞–Ω–æ          |
| `getCompletedTaskCount()`      | –°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ            |
| `prestartAllCoreThreads()`     | –°—Ç–∞—Ä—Ç—É–µ—Ç –≤—Å–µ core-–ø–æ—Ç–æ–∫–∏ –∑–∞—Ä–∞–Ω–µ–µ   |
| `allowCoreThreadTimeOut(true)` | –ü–æ–∑–≤–æ–ª—è–µ—Ç core-–ø–æ—Ç–æ–∫–∞–º –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è |


###### üßæ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—É–ª–∞               | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è                                                                |
| ----------------------------- | --------------------------------------------------------------------------- |
| ‚úÖ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ—Ç–æ–∫–æ–≤ | `Executors.newFixedThreadPool(n)` = core=max, –æ—á–µ—Ä–µ–¥—å –±–µ–∑—Ä–∞–∑–º–µ—Ä–Ω–∞—è          |
| üîÑ –ö—ç—à–∏—Ä—É–µ–º—ã–π (–¥–∏–Ω–∞–º–∏—á–Ω—ã–π)    | `Executors.newCachedThreadPool()` = core=0, max=‚àû, –æ—á–µ—Ä–µ–¥—å=SynchronousQueue |
| ‚è±Ô∏è –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏          | `Executors.newScheduledThreadPool(n)`                                       |
| üß™ –¢–µ—Å—Ç—ã/–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∑–∞–¥–∞—á–∏   | `Executors.newSingleThreadExecutor()`                                       |


###### üìâ –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –û—à–∏–±–∫–∞                                             | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ                            |
| -------------------------------------------------- | -------------------------------------- |
| –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π `maxPoolSize` + `SynchronousQueue` | –†–æ—Å—Ç —á–∏—Å–ª–∞ –ø–æ—Ç–æ–∫–æ–≤ –¥–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è     |
| –ë–µ–∑—Ä–∞–∑–º–µ—Ä–Ω–∞—è –æ—á–µ—Ä–µ–¥—å + –º–∞–ª–µ–Ω—å–∫–∏–π `corePoolSize`    | –ü–æ—Ç–æ–∫–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è, –≤—Å—ë –≤ –æ—á–µ—Ä–µ–¥–∏     |
| `shutdown()` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è                         | –£—Ç–µ—á–∫–∞ –ø–æ—Ç–æ–∫–æ–≤, –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è |


***

# FutureTask


`FutureTask<V>` ‚Äî —ç—Ç–æ **–∫–ª–∞—Å—Å**, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**:

* `Runnable` ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω –≤ `Thread` –∏–ª–∏ `Executor`
* `Future<V>` ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

```java
public class FutureTask<V> implements RunnableFuture<V>
```

–ê `RunnableFuture<V>` = `Runnable + Future<V>`


###### üß™ –ó–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

* –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏**
* –ø–æ–ª—É—á–µ–Ω–∏—è **—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º**
* **–æ—Ç–º–µ–Ω—ã** –∑–∞–¥–∞—á–∏
* **–æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è


###### üì¶ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```java
Callable<Integer> task = () -> {
    Thread.sleep(1000);
    return 42;
};

FutureTask<Integer> futureTask = new FutureTask<>(task);
Thread thread = new Thread(futureTask);
thread.start();

Integer result = futureTask.get(); // –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
System.out.println(result); // 42
```


###### üìö –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã `FutureTask`

| –ú–µ—Ç–æ–¥                  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                             |
| ---------------------- | -------------------------------------- |
| `get()`                | –ñ–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
| `get(timeout, unit)`   | –ñ–¥—ë—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è                |
| `cancel(mayInterrupt)` | –ü—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É               |
| `isCancelled()`        | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª–∞ –ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞            |
| `isDone()`             | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –ª–∏ –∑–∞–¥–∞—á–∞       |


###### üõ† –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã

```java
FutureTask(Callable<V> callable)
FutureTask(Runnable runnable, V result)
```


###### üîí –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –í–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **volatile –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** –∏ **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é**
* **–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**
* –°–æ—Å—Ç–æ—è–Ω–∏—è: `NEW`, `COMPLETING`, `NORMAL`, `EXCEPTIONAL`, `CANCELLED`, `INTERRUPTING`, `INTERRUPTED`


###### üîÑ –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã

```shellscript
        NEW
         |
         v
    [–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è]
         |
   +-----+-----+
   |           |
  v             v
NORMAL     EXCEPTIONAL
```

```shellscript
NEW --> CANCELLED
(–∏–ª–∏) --> INTERRUPTING -> INTERRUPTED
```

###### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

* –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
* –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∑–∞–¥–∞—á–∏** –∏ –∑–∞–ø—É—Å–∫–∞ –ø–æ–∑–∂–µ
* –ú–æ–∂–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å –≤ `ExecutorService.submit()`


###### üîÅ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å ExecutorService

```java
ExecutorService executor = Executors.newFixedThreadPool(1);
FutureTask<String> future = new FutureTask<>(() -> "Hello");
executor.submit(future);
System.out.println(future.get()); // Hello
```


###### ‚ö†Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

| –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å                          | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                         |
| ------------------------------------ | ----------------------------------- |
| `get()` –±–ª–æ–∫–∏—Ä—É–µ—Ç                    | –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏                |
| `cancel(true)` –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –ø–æ—Ç–æ–∫  | –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ |
| `FutureTask` –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å    | —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ       |
| –ò—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∏–∑ `get()` | –∑–∞–≤–µ—Ä–Ω—É—Ç—ã –≤ `ExecutionException`    |

