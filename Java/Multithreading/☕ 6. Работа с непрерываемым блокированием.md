
###### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ?

–ù–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ (Uninterruptible Blocking) ‚Äî —ç—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ **–≤—ã–Ω—É–∂–¥–µ–Ω –∂–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å** –∏–ª–∏ —É—Å–ª–æ–≤–∏–µ, **–Ω–µ —Ä–µ–∞–≥–∏—Ä—É—è –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è**.

–¢–∞–∫–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –º–æ–≥—É—Ç –ø–æ–≤–ª–µ—á—å **–∑–∞–≤–∏—Å–∞–Ω–∏—è, —Å–Ω–∏–∂–µ–Ω–∏–µ –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏** –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å **–º—è–≥–∫–æ–π –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á**.


###### üìï –ü—Ä–∏–º–µ—Ä—ã –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–≥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è

| –°–∏—Ç—É–∞—Ü–∏—è             | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                       |
| -------------------- | ----------------------------------------------------------------- |
| `InputStream.read()` | –ë–ª–æ–∫–∏—Ä—É–µ—Ç, –ø–æ–∫–∞ –Ω–µ –ø–æ—Å—Ç—É–ø—è—Ç –¥–∞–Ω–Ω—ã–µ. –ù–µ–ª—å–∑—è –ø—Ä–µ—Ä–≤–∞—Ç—å.              |
| `Socket.accept()`    | –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî —Ç–æ–∂–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ.                  |
| `Thread.sleep()`     | –ë–ª–æ–∫–∏—Ä—É–µ—Ç, –Ω–æ *–º–æ–∂–µ—Ç –±—ã—Ç—å* –ø—Ä–µ—Ä–≤–∞–Ω ‚Äî **–ø—Ä–µ—Ä—ã–≤–∞–µ–º–∞—è** –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.  |
| `synchronized`       | –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –∂–¥–µ—Ç –≤—Ö–æ–¥–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä ‚Äî —ç—Ç–æ **–Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ**.           |
| –í—ã–∑–æ–≤ `Lock.lock()`  | –ú–æ–∂–µ—Ç –±—ã—Ç—å **–Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–º**, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `lockInterruptibly()`. |


###### ‚ö†Ô∏è –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞?

* –ü–æ—Ç–æ–∫–∏ –º–æ–≥—É—Ç ¬´–∑–∞–≤–∏—Å–Ω—É—Ç—å¬ª –Ω–∞–≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–µ—Å—É—Ä—Å–∞.
* –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–π—Ç–∏ –∏–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–æ—Ç–æ–∫–æ–≤ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–ª–æ–∂–Ω–µ–µ.
* –£–≥—Ä–æ–∑–∞ —É—Ç–µ—á–µ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤, –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.


###### ‚úÖ –ö–∞–∫ –∏–∑–±–µ–≥–∞—Ç—å?


**1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ –∞–Ω–∞–ª–æ–≥–∏**

–ú–µ—Ç–æ–¥—ã –≤—Ä–æ–¥–µ:

* `Lock.lockInterruptibly()`
* `BlockingQueue.take()` / `poll(timeout)`
* `Semaphore.acquire()` ‚Üí –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `acquireInterruptibly()`


**2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª—ã NIO (Non-blocking I/O)**

–í–º–µ—Å—Ç–æ `InputStream`/`Socket`, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

* `Selector` + `SelectableChannel` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `SocketChannel`)
* –†–∞–±–æ—Ç–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è, —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π.

> üìç **Selector** ‚Äî –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–∞–Ω–∞–ª–∞–º–∏.


**3. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è**

–ó–∞–º–µ–Ω—è–π—Ç–µ:

```java
lock.lock(); // –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ!
```

–Ω–∞:

```java
if (lock.tryLock(1, TimeUnit.SECONDS)) {
   try {
       // critical section
   } finally {
       lock.unlock();
   }
} else {
   // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–∞–∑–∞
}
```


###### üîÑ –ü–æ–¥—Ö–æ–¥—ã –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–≥–æ –∫–æ–¥–∞

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏**

* –û–±–µ—Ä–Ω—É—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–π –∫–æ–¥ –≤ –º–∞–ª–µ–Ω—å–∫—É—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É.
* –í—ã–ø–æ–ª–Ω—è—Ç—å –µ—ë –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.

**–¢–∞–π–º–∞—É—Ç—ã**

* –õ—É—á—à–µ –∂–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è**, —á–µ–º –Ω–∞–≤—Å–µ–≥–¥–∞.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Future**

* –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –≤ `ExecutorService`.
* –û–∂–∏–¥–∞–Ω–∏–µ —Å `future.get(timeout)` ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∏ –æ—Ç–º–µ–Ω—É.

**–ü—Ä–æ–≤–µ—Ä–∫–∞ Thread.interrupted()**

* –ü–æ—Å–ª–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ ‚Äî –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏ –≤—ã—Ö–æ–¥–∏—Ç—å:

```java
if (Thread.currentThread().isInterrupted()) {
    return;
}
```


###### üìã –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å Future

```java
ExecutorService executor = Executors.newCachedThreadPool();
Future<?> future = executor.submit(() -> {
    socket.accept(); // –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ
});

try {
    future.get(2, TimeUnit.SECONDS);
} catch (TimeoutException e) {
    future.cancel(true); // –ø–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
}
```


***

# üß† Selector –∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏


###### –ß—Ç–æ —Ç–∞–∫–æ–µ Selector?

* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç **NIO**, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é **–µ–¥–∏–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞**.
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ **–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö**, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `Netty`.


###### –ü–æ—á–µ–º—É Selector –ø–æ–º–æ–≥–∞–µ—Ç?

* –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `select()` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω **—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è** (—á–µ—Ä–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ wakeup).
* –≠—Ç–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ `accept()`.


***

# –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –æ—Ç–º–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é `newTaskFor`


###### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞?

–ò–Ω–æ–≥–¥–∞ **–ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø–æ—Ç–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ** –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ:

* –∑–∞–¥–∞—á–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤ **–Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º–æ–º –≤—ã–∑–æ–≤–µ** (`Socket`, `I/O`, `native –º–µ—Ç–æ–¥`);
* —É –∑–∞–¥–∞—á–∏ –µ—Å—Ç—å **—Å–æ—Å—Ç–æ—è–Ω–∏–µ**, –∫–æ—Ç–æ—Ä–æ–µ —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–∫—Ä—ã—Ç—å —Å–æ–∫–µ—Ç);
* –æ—Ç–º–µ–Ω–∞ —Ç—Ä–µ–±—É–µ—Ç **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏**, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å `Thread.interrupt()`.


###### üß† –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ `Future.cancel(true)`

* –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `cancel(true)` ‚Äî –ø–æ—Ç–æ–∫, –∏—Å–ø–æ–ª–Ω—è—é—â–∏–π –∑–∞–¥–∞—á—É, **–ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è**.
* –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è**.
* –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å —Å–≤–æ—é –ª–æ–≥–∏–∫—É –æ—Ç–º–µ–Ω—ã –±–µ–∑ –æ–±–µ—Ä—Ç–∫–∏.


###### ‚úÖ –†–µ—à–µ–Ω–∏–µ: `ExecutorService.newTaskFor(...)`

–ú–µ—Ç–æ–¥ `newTaskFor(...)` –ø–æ–∑–≤–æ–ª—è–µ—Ç **–∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –æ—Ç–º–µ–Ω—É**, —Å–æ–∑–¥–∞–≤–∞—è **–∫–∞—Å—Ç–æ–º–Ω—ã–π** `RunnableFuture`.


###### üì¶ –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```java
class CancellableTask implements Callable<Socket> {
    private Socket socket;

    public synchronized void cancel() {
        try {
            if (socket != null)
                socket.close();  // –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–º–µ–Ω–∞
        } catch (IOException ignored) {}
    }

    @Override
    public synchronized Socket call() throws IOException {
        socket = new Socket("host", 80);
        return socket;
    }


    public RunnableFuture<Socket> newTask() {
        return new FutureTask<>(this) {
            @Override
            public boolean cancel(boolean mayInterruptIfRunning) {
                CancellableTask.this.cancel();   // –≤—ã–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –ª–æ–≥–∏–∫—É
                return super.cancel(mayInterruptIfRunning);
            }
        };
    }
}
```

–¢–µ–ø–µ—Ä—å —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É, –º—ã –¥–æ–ª–∂–Ω—ã –≤—ã–∑–≤–∞—Ç—å `cancel()` —É —Å–∞–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞. –ù–æ –≤ –æ–±—ã—á–Ω–æ–º `ExecutorService` —ç—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Äî –æ–Ω –∑–Ω–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ `Future`.


###### üìê –†–∞—Å—à–∏—Ä—è–µ–º `ThreadPoolExecutor` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –æ—Ç–º–µ–Ω—ã

–°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—É–ª:

```java
class CancellingExecutor extends ThreadPoolExecutor {
    public <T> Future<T> submit(CancellableTask task) {
        return super.submit(task.newTask());
    }
}
```

–í–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```java
public <T> Future<T> submit(Callable<T> task) {
    if (task == null) throw new NullPointerException();
    RunnableFuture<T> ftask = newTaskFor(task);
      execute(ftask);
    return ftask;
}
```

