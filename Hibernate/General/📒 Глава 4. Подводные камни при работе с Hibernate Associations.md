
## –î–≤–µ —Å—Ç–æ—Ä–æ–Ω—ã –±–µ–∑ `mappedBy`

**–°–∏—Ç—É–∞—Ü–∏—è**

```sql
@Entity
class Person {
    @OneToOne
    @JoinColumn(name = "passport_id")
    private Passport passport;
}

@Entity
class Passport {
    @OneToOne
    @JoinColumn(name = "person_id")
    private Person person;
}
```

**–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç?**

Hibernate —Å–æ–∑–¥–∞—Å—Ç **–¥–≤–µ FK-–∫–æ–ª–æ–Ω–∫–∏** (`person.passport_id` –∏ `passport.person_id`) ‚Üí –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã.

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**

* –≤—ã–±–∏—Ä–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ (`@JoinColumn`),
* —É –≤—Ç–æ—Ä–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –ø–∏—à–µ–º `mappedBy`.


***

## N+1 –ø—Ä–æ–±–ª–µ–º–∞

**–ß—Ç–æ —ç—Ç–æ?**

* –î–æ–ø—É—Å—Ç–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤.
* –ú—ã —Ö–æ—Ç–∏–º –≤—ã–≤–µ—Å—Ç–∏ –∏—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.

```java
List<Department> deps = session.createQuery("from Department", Department.class).list();
for (Department d : deps) {
    System.out.println(d.getEmployees().size()); // —Ç—É—Ç Hibernate –¥–µ–ª–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π SELECT –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
}
```

üëâ –≠—Ç–æ –∏ –µ—Å—Ç—å N+1:

* 1 –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã
* N –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å?**

1. **JOIN FETCH**

```java
List<Department> deps = session.createQuery(
    "select d from Department d join fetch d.employees", Department.class
).list();
```

1. **@EntityGraph (JPA 2.1+)**

```java
@EntityGraph(attributePaths = "employees")
List<Department> findAll();
```


[[üìí @EntityGraph]]


***

## LazyInitializationException

**–°–∏—Ç—É–∞—Ü–∏—è:**

```java
Department d = session.find(Department.class, 1L);
session.close();
System.out.println(d.getEmployees().size()); // LazyInitializationException
```

**–ü–æ—á–µ–º—É?**

* –ö–æ–ª–ª–µ–∫—Ü–∏—è `employees` ‚Äî LAZY.
* –°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ ‚Üí Hibernate –Ω–µ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å SELECT.

**–†–µ—à–µ–Ω–∏—è:**

1. –î–µ–ª–∞—Ç—å `fetch join` –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ.
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `OpenSessionInView` (–Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ ‚Äî –º–æ–∂–µ—Ç –¥–∞—Ç—å –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã).
3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é:

```java
Hibernate.initialize(d.getEmployees());
```


[[üìí OpenSessionInView (OSIV)]]


***

## equals() –∏ hashCode()

Hibernate **–æ—á–µ–Ω—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω** –∫ —Ç–æ–º—É, –∫–∞–∫ —Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—à—å `equals/hashCode` –≤ —Å—É—â–Ω–æ—Å—Ç—è—Ö.

**–û—à–∏–±–∫–∞ ‚Ññ1:**

```java
@Override
public boolean equals(Object o) {
    return Objects.equals(this.id, ((User) o).id);
}
```

üëâ –ü—Ä–æ–±–ª–µ–º–∞: —É transient-–æ–±—ä–µ–∫—Ç–æ–≤ `id = null`, –∑–Ω–∞—á–∏—Ç –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞ –±—É–¥—É—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è —Ä–∞–≤–Ω—ã–º–∏.

**–ü—Ä–∞–≤–∏–ª—å–Ω–µ–µ:**

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–±–∏–∑–Ω–µ—Å-–∫–ª—é—á** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `email`) –¥–ª—è equals/hashCode.
* –õ–∏–±–æ –≤ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `id`, –Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å `null`.


***

## –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ —Å–≤—è–∑—è—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** 

Hibernate –ø–ª–æ—Ö–æ –¥—Ä—É–∂–∏—Ç —Å `Set`/`List` –ø—Ä–∏ `equals/hashCode`.

–ü—Ä–∏–º–µ—Ä:

```java
department.getEmployees().remove(emp);
```

–ï—Å–ª–∏ `emp` –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ `equals/hashCode`, Hibernate –Ω–µ —É–¥–∞–ª–∏—Ç —Å—Ç—Ä–æ–∫—É –≤ join-—Ç–∞–±–ª–∏—Ü–µ.

üëâ –°–æ–≤–µ—Ç:

* –í—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–π `equals/hashCode` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
* –ß–∞—â–µ –∏—Å–ø–æ–ª—å–∑—É–π `List`, –∞ –Ω–µ `Set`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ.


***

## orphanRemoval vs Cascade.REMOVE

* `cascade = CascadeType.REMOVE` ‚Üí –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è —É–¥–∞–ª—è—é—Ç—Å—è –¥–µ—Ç–∏.
* `orphanRemoval = true` ‚Üí –µ—Å–ª–∏ —É–±—Ä–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –æ–Ω —É–¥–∞–ª–∏—Ç—Å—è –∏ –≤ –ë–î.

–ü—Ä–∏–º–µ—Ä:

```java
@OneToMany(mappedBy = "department", cascade = CascadeType.ALL, orphanRemoval = true)
private List<Employee> employees = new ArrayList<>();

// –µ—Å–ª–∏ –≤—ã–∑–≤–∞—Ç—å:
dep.getEmployees().remove(emp);
// Hibernate —É–¥–∞–ª–∏—Ç emp –∏–∑ —Ç–∞–±–ª–∏—Ü—ã employee
```


***

## –î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ ManyToMany

–ï—Å–ª–∏ —É —Ç–µ–±—è `List<Course> courses` –∏ —Ç—ã –¥–≤–∞–∂–¥—ã –¥–æ–±–∞–≤–∏—à—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç ‚Üí Hibernate –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç –≤ join-—Ç–∞–±–ª–∏—Ü—É.

üëâ –ü–æ—ç—Ç–æ–º—É –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Set`, –Ω–æ —Ç–æ–≥–¥–∞ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `equals/hashCode`.


***

## –ò—Ç–æ–≥

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏:

1. **mappedBy** ‚Üí –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã Hibernate –Ω–µ —Å–æ–∑–¥–∞–ª –ª–∏—à–Ω–∏–µ FK.
2. **N+1** ‚Üí –ª–µ—á–∏—Ç—Å—è `join fetch` –∏–ª–∏ `EntityGraph`.
3. **LazyInitializationException** ‚Üí –ª–µ—á–∏—Ç—Å—è `fetch join`, `initialize()` –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏.
4. **equals/hashCode** ‚Üí –∫—Ä–∞–π–Ω–µ –≤–∞–∂–Ω—ã –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π –∏ —Ä–∞–±–æ—Ç—ã Hibernate.
5. **orphanRemoval** ‚â† `Cascade.REMOVE`.
6. **ManyToMany** ‚Üí –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏.

