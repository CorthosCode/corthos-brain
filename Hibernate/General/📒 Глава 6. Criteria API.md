# üìí –ì–ª–∞–≤–∞ 6. Criteria API

**JPQL/HQL** ‚Üí —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

```java
em.createQuery("select e from Employee e where e.salary > 1000", Employee.class)
```

‚ö†Ô∏è –ú–∏–Ω—É—Å—ã: –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —ç—Ç–∞–ø–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏, –ª–µ–≥–∫–æ –æ—à–∏–±–∏—Ç—å—Å—è –≤ —Å—Ç—Ä–æ–∫–µ.

**Criteria API** ‚Üí –æ–±—ä–µ–∫—Ç–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤:

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery<Employee> cq = cb.createQuery(Employee.class);
Root<Employee> root = cq.from(Employee.class);
cq.select(root).where(cb.gt(root.get("salary"), 1000));

List<Employee> result = em.createQuery(cq).getResultList();
```

‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º (–∏–º–µ–Ω–∞ –ø–æ–ª–µ–π ‚Üí —Å—Ç—Ä–æ–∫–∏, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ ‚Üí –∫–ª–∞—Å—Å—ã).

‚úÖ –£–¥–æ–±–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (—Ñ–∏–ª—å—Ç—Ä—ã, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø–∞–≥–∏–Ω–∞—Ü–∏—è).





***

## –û—Å–Ω–æ–≤–Ω—ã–µ —à–∞–≥–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

1. –ü–æ–ª—É—á–∞–µ–º `CriteriaBuilder`

```java
CriteriaBuilder cb = em.getCriteriaBuilder();
```

1. –°–æ–∑–¥–∞—ë–º `CriteriaQuery` –¥–ª—è —Ç–∏–ø–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

```java
CriteriaQuery<Employee> cq = cb.createQuery(Employee.class);
```

1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º "–∫–æ—Ä–µ–Ω—å" –∑–∞–ø—Ä–æ—Å–∞ (`Root`)

```java
Root<Employee> root = cq.from(Employee.class);
```

1. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç –∏ —É—Å–ª–æ–≤–∏—è

```java
cq.select(root).where(cb.equal(root.get("department").get("name"), "IT"));
```

1. –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å

```java
List<Employee> employees = em.createQuery(cq).getResultList();
```





***

## –£—Å–ª–æ–≤–∏—è (`Predicate`)

```java
Predicate p1 = cb.gt(root.get("salary"), 1000); // salary > 1000
Predicate p2 = cb.equal(root.get("department").get("name"), "IT"); // department.name = 'IT'

cq.where(cb.and(p1, p2)); // salary > 1000 AND department.name = 'IT'
```





***

## –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞

```java
cq.orderBy(cb.asc(root.get("fullName")));  // ORDER BY fullName ASC
```





***

## –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞

```java
CriteriaQuery<Object[]> cq = cb.createQuery(Object[].class);
Root<Employee> root = cq.from(Employee.class);

cq.multiselect(root.get("department").get("name"), cb.count(root))
  .groupBy(root.get("department").get("name"))
  .having(cb.gt(cb.count(root), 5));

List<Object[]> result = em.createQuery(cq).getResultList();
```

SQL-–∞–Ω–∞–ª–æ–≥:

```sql
SELECT d.name, COUNT(*)
FROM employee e
JOIN department d ON e.department_id = d.id
GROUP BY d.name
HAVING COUNT(*) > 5;
```





***

## Join-–æ–ø–µ—Ä–∞—Ü–∏–∏

```java
Root<Employee> root = cq.from(Employee.class);
Join<Employee, Department> dep = root.join("department");

cq.select(root).where(cb.equal(dep.get("name"), "IT"));
```

SQL-–∞–Ω–∞–ª–æ–≥:

```sql
SELECT e.*
FROM employee e
JOIN department d ON e.department_id = d.id
WHERE d.name = 'IT';
```





***

## Subquery (–ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã)

```java
Subquery<Double> sub = cq.subquery(Double.class);
Root<Employee> subRoot = sub.from(Employee.class);
sub.select(cb.avg(subRoot.get("salary")));

cq.select(root).where(cb.gt(root.get("salary"), sub));
```

SQL-–∞–Ω–∞–ª–æ–≥:

```java
SELECT *
FROM employee e
WHERE e.salary > (SELECT AVG(salary) FROM employee);
```





***

## DTO Projection —á–µ—Ä–µ–∑ Criteria

```java
CriteriaQuery<EmployeeDto> cq = cb.createQuery(EmployeeDto.class);
Root<Employee> root = cq.from(Employee.class);

cq.select(cb.construct(EmployeeDto.class, root.get("id"), root.get("fullName")));

List<EmployeeDto> list = em.createQuery(cq).getResultList();
```

‚ö° DTO —Å–æ–∑–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (`new` –≤ Criteria API).





***

## –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã

–ì–ª–∞–≤–Ω–∞—è —Å–∏–ª–∞ Criteria API ‚Äî –º–æ–∂–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫ `Predicate` –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å:

```java
List<Predicate> predicates = new ArrayList<>();

if (minSalary != null) {
    predicates.add(cb.gt(root.get("salary"), minSalary));
}
if (departmentName != null) {
    predicates.add(cb.equal(root.get("department").get("name"), departmentName));
}

cq.where(predicates.toArray(new Predicate[0]));
```





***

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Criteria API

‚úÖ –ù—É–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã** (–ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, –ø–æ–∏—Å–∫ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏–∑ —Ñ–æ—Ä–º—ã).

‚úÖ –ö–æ–≥–¥–∞ —Ö–æ—á–µ—Ç—Å—è **type-safety** (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–º).

‚úÖ –ö–æ–≥–¥–∞ –ø—Ä–æ–µ–∫—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ JPA-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é.

‚ö†Ô∏è –ö–æ–≥–¥–∞ **–ª—É—á—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**:

* –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ—Å—Ç—ã–µ ‚Üí –ø—Ä–æ—â–µ JPQL/HQL.
* –ö–æ–¥ Criteria API –≥—Ä–æ–º–æ–∑–¥–∫–∏–π –∏ –ø–ª–æ—Ö–æ —á–∏—Ç–∞–µ—Ç—Å—è.





***

## –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

* **Spring Data JPA&#x20;****`Specifications`** ‚Üí —Ç–æ–Ω–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ Criteria API.
* **QueryDSL** ‚Üí –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π DSL.
* **JOOQ** ‚Üí –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π SQL DSL, –Ω–æ –Ω–µ JPA.



