# üìí –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –ì–ª–∞–≤–µ 4-5

## Hibernate.initialize()

–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–Ω–∏–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏/–ø—Ä–æ–∫—Å–∏.

```java
Department d = session.get(Department.class, 1L);
Hibernate.initialize(d.getEmployees()); // –ø–æ–¥–≥—Ä—É–∑–∏—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é
```

–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º: –µ—Å–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è –±—ã–ª–∞ `LAZY` –∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ ‚Üí Hibernate —Å–¥–µ–ª–∞–µ—Ç SQL –∏ –∑–∞–≥—Ä—É–∑–∏—Ç –µ—ë.

–ò—Å–ø–æ–ª—å–∑—É—é—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.





***

## –î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ

–ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å `JOIN FETCH` –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é, Hibernate –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π**.

```java
List<Department> deps = session.createQuery(
    "select d from Department d join fetch d.employees", Department.class
).list();
```

SQL –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞:

```
IT | Petrov
IT | Ivanov
HR | Sidorov
```

‚û° Hibernate —Å–æ–±–µ—Ä—ë—Ç `Department`, –Ω–æ —Ç.–∫. –≤ `List` –ø–æ–ø–∞–¥–∞—é—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –º—ã —É–≤–∏–¥–∏–º –¥—É–±–ª–∏–∫–∞—Ç—ã.

‚úÖ –†–µ—à–µ–Ω–∏–µ: `distinct` –≤ HQL.

```sql
select distinct d from Department d join fetch d.employees
```





***

## –ü—Ä–æ–µ–∫—Ü–∏—è –≤ DTO

–°—Ç–∞–Ω–¥–∞—Ä—Ç:

```sql
List<EmployeeDTO> list = session.createQuery(
    "select new com.example.EmployeeDTO(e.id, e.fullName) from Employee e",
    EmployeeDTO.class
).list();
```

‚ö†Ô∏è –ú–∏–Ω—É—Å ‚Äî –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞–∫–µ—Ç.

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:



### Spring Data Projection

Spring Data JPA –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–∏—Å–∞—Ç—å DTO **—á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏–ª–∏ –∫–ª–∞—Å—Å—ã** –±–µ–∑ —è–≤–Ω–æ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞.

```java
public interface EmployeeView {
    Long getId();
    String getFullName();
    String getDepartmentName(); // –º–æ–∂–Ω–æ alias
}
```

```java
public interface EmployeeRepository extends JpaRepository<Employee, Long> {

    @Query("select e.id as id, e.fullName as fullName, e.department.name as departmentName " +
           "from Employee e")
    List<EmployeeView> findAllEmployeeViews();
}
```

‚ö° Hibernate –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `EmployeeView` –∏ –≤–µ—Ä–Ω—ë—Ç —Å–ø–∏—Å–æ–∫.



**Nested Projection**

```java
public interface DepartmentView {
    Long getId();
    String getName();
    List<EmployeeView> getEmployees();

    interface EmployeeView {
        Long getId();
        String getFullName();
    }
}
```

```java
@Query("select d from Department d")
List<DepartmentView> findAllDepartments();
```

‚ö° –ó–¥–µ—Å—å Spring Data –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º —Å–∞–º –≤—ã–ø–æ–ª–Ω–∏—Ç `JOIN` –∏ –ø–æ–¥—Ç—è–Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.





### @SqlResultSetMapping

* –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø–∏—Å–∞—Ç—å, **–∫–∞–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç SQL-–∑–∞–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω** –≤ –æ–±—ä–µ–∫—Ç.



‚úÖ –°–ª–æ–∂–Ω—ã–µ SQL (CTE, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ç—ã)

‚úÖ –ö–æ–≥–¥–∞ JPQL –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

‚úÖ –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ **—á–∏—Å—Ç–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** (–ø–∏—Å–∞—Ç—å —Ä—É–∫–∞–º–∏ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–¥ –ë–î)



* –º–æ–∂–Ω–æ –º–∞–ø–ø–∏—Ç—å:
  1. **–ù–∞ —Å—É—â–Ω–æ—Å—Ç–∏** (`entities`)
  2. **–ù–∞ DTO** (`columns` ‚Üí –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)
  3. **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—É—â–Ω–æ—Å—Ç–µ–π + DTO)



#### –ü—Ä–∏–º–µ—Ä 1. Mapping –Ω–∞ DTO (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)

```java
public record EmployeeDepartmentDto(Long employeeId, String employeeName, String departmentName) {}
```

```java
@SqlResultSetMapping(
    name = "EmployeeDepartmentMapping",
    classes = {
        @ConstructorResult(
            targetClass = com.example.dto.EmployeeDepartmentDto.class,
            columns = {
                @ColumnResult(name = "employee_id", type = Long.class),
                @ColumnResult(name = "employee_name", type = String.class),
                @ColumnResult(name = "department_name", type = String.class)
            }
        )
    }
)
@Entity
@Table(name = "employee")
public class Employee {
    @Id
    private Long id;
    private String fullName;

    @ManyToOne
    private Department department;
}
```

```java
List<EmployeeDepartmentDto> result = em
    .createNativeQuery(
        "select e.id as employee_id, e.full_name as employee_name, d.name as department_name " +
        "from employee e join department d on e.department_id = d.id",
        "EmployeeDepartmentMapping"
    )
    .getResultList();
```



#### –ü—Ä–∏–º–µ—Ä 2. Mapping –Ω–∞ —Å—É—â–Ω–æ—Å—Ç–∏

```java
@SqlResultSetMapping(
    name = "EmployeeWithDepartmentEntityMapping",
    entities = {
        @EntityResult(entityClass = Employee.class),
        @EntityResult(entityClass = Department.class)
    }
)
```

```java
List<Object[]> result = em.createNativeQuery(
        "select e.*, d.* " +
        "from employee e join department d on e.department_id = d.id",
        "EmployeeWithDepartmentEntityMapping"
    )
    .getResultList();

for (Object[] row : result) {
    Employee emp = (Employee) row[0];
    Department dep = (Department) row[1];
}
```



#### –ü—Ä–∏–º–µ—Ä 3. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (Entity + DTO)

```java
@SqlResultSetMapping(
    name = "EmployeeMixedMapping",
    entities = {
        @EntityResult(entityClass = Employee.class)
    },
    classes = {
        @ConstructorResult(
            targetClass = com.example.dto.DepartmentDto.class,
            columns = {
                @ColumnResult(name = "department_id", type = Long.class),
                @ColumnResult(name = "department_name", type = String.class)
            }
        )
    }
)
```

```java
List<Object[]> result = em.createNativeQuery(
        "select e.*, d.id as department_id, d.name as department_name " +
        "from employee e join department d on e.department_id = d.id",
        "EmployeeMixedMapping"
    ).getResultList();

for (Object[] row : result) {
    Employee emp = (Employee) row[0];
    DepartmentDto depDto = (DepartmentDto) row[1];
}
```





### record

```java
public record DepartmentDto(Long id, String name) {}
public record EmployeeDto(Long id, String fullName) {}
```

```java
List<DepartmentDto> departments = em.createQuery(
    "select new com.example.dto.DepartmentDto(d.id, d.name) from Department d",
    DepartmentDto.class
).getResultList();
```

‚ö° Hibernate —É–º–µ–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å `record` —Ç–∞–∫ –∂–µ, –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ DTO-–∫–ª–∞—Å—Å—ã —Å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º.











***

## `join d.employees e` ‚Äî –ø–æ—á–µ–º—É —Ç–∞–∫?

JPQL —Ä–∞–±–æ—Ç–∞–µ—Ç —Å **–æ–±—ä–µ–∫—Ç–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏**, –∞ –Ω–µ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏.

```sql
select d.name, count(e) 
from Department d join d.employees e 
group by d.name
```

* `d.employees` ‚Äî —ç—Ç–æ –ø–æ–ª–µ –∏–∑ —Å—É—â–Ω–æ—Å—Ç–∏ `Department` (`List<Employee>`).
* JPQL –Ω–µ –∑–Ω–∞–µ—Ç —Ç–∞–±–ª–∏—Ü –Ω–∞–ø—Ä—è–º—É—é, —Ç–æ–ª—å–∫–æ **–∞—Ç—Ä–∏–±—É—Ç—ã —Å—É—â–Ω–æ—Å—Ç–µ–π**.

‚ùå –ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å `join Employee e` –±–µ–∑ —Å–≤—è–∑–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ Hibernate –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –∫–∞–∫ —Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏ (–∫–∞–∫–æ–π FK).





***

## Bulk operations

Bulk = –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–∞–º—è—Ç—å.

```java
// update
int updated = session.createQuery(
    "update Employee e set e.salary = e.salary * 1.1 where e.department.name = :depName")
    .setParameter("depName", "IT")
    .executeUpdate();

// delete
int deleted = session.createQuery(
    "delete from Employee e where e.department.name = :depName")
    .setParameter("depName", "HR")
    .executeUpdate();
```

Hibernate –∑–¥–µ—Å—å **–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã**, –∞ –Ω–∞–ø—Ä—è–º—É—é –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL.





***

## `session.clear()` –ø–æ—Å–ª–µ bulk

–ü—Ä–æ–±–ª–µ–º–∞: bulk-–∑–∞–ø—Ä–æ—Å—ã **–æ–±—Ö–æ–¥—è—Ç Persistence Context**.

```java
Employee e = session.get(Employee.class, 1L);
System.out.println(e.getSalary()); // 1000

session.createQuery("update Employee set salary = 2000").executeUpdate();

System.out.println(e.getSalary()); // ‚ùå 1000 (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫—ç—à–µ!)
```

‚û° –í –ø–∞–º—è—Ç–∏ (`Persistence Context`) —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ–Ω–∏ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è —Å –ë–î.

‚úÖ –†–µ—à–µ–Ω–∏–µ: `session.clear()` –∏–ª–∏ `session.refresh(entity)`.

```java
session.clear(); // –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è detached
```



