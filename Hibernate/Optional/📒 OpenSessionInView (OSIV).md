# üìí OpenSessionInView (OSIV)

–≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω: **—Å–µ—Å—Å–∏—è Hibernate –æ—Ç–∫—Ä—ã—Ç–∞ –¥–æ –∫–æ–Ω—Ü–∞ –∑–∞–ø—Ä–æ—Å–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, HTTP-–∑–∞–ø—Ä–æ—Å–∞).

‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞, –∞ —É —Ç–µ–±—è –ª–µ–Ω–∏–≤—ã–µ —Å–≤—è–∑–∏ ‚Äî `LazyInitializationException`.

```java
@Controller
public class DepController {
    @Autowired SessionFactory sf;

    @GetMapping("/deps")
    public List<Department> getAll() {
        try (Session session = sf.openSession()) {
            return session.createQuery("from Department", Department.class).list();
        }
    }
}
```

‚û° –ï—Å–ª–∏ –ø–æ—Ç–æ–º –≤ JSP/Thymeleaf —Ç—ã –Ω–∞–ø–∏—à–µ—à—å `dep.employees`, —Å–µ—Å—Å–∏—è —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞ ‚Üí –æ—à–∏–±–∫–∞.

**OpenSessionInView** —Ä–µ—à–∞–µ—Ç —ç—Ç–æ: —Å–µ—Å—Å–∏—è –¥–µ—Ä–∂–∏—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–æ –∫–æ–Ω—Ü–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞, –∏ –ª–µ–Ω–∏–≤—ã–µ –ø–æ–ª—è –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –¥–∞–∂–µ –≤–æ view.

–ù–æ ‚ö†Ô∏è **–º–∏–Ω—É—Å—ã**: –≤–æ–∑–º–æ–∂–Ω—ã –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –ø—Ä—è–º–æ –∏–∑ —Å–ª–æ—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DTO.





***

## –ß—Ç–æ —Ç–∞–∫–æ–µ Open Session In View (OSIV)

**–ü—Ä–æ–±–ª–µ–º–∞:**

Hibernate –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `LAZY` –∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è —Å–≤—è–∑–µ–π (`@OneToMany`, `@ManyToOne` –∏ —Ç. –¥.).

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏/—Å–µ—Å—Å–∏–∏ —Ç—ã –ø–æ–ø—ã—Ç–∞–µ—à—å—Å—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ª–µ–Ω–∏–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ‚Äî –ø–æ–ª—É—á–∏—à—å:

```java
org.hibernate.LazyInitializationException: could not initialize proxy
```

**–ü—Ä–∏—á–∏–Ω–∞:**

* –°–µ—Å—Å–∏—è (`Session`/`EntityManager`) —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞.
* Hibernate –Ω–µ –º–æ–∂–µ—Ç —Å—Ö–æ–¥–∏—Ç—å –≤ –±–∞–∑—É –∑–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π.

**–†–µ—à–µ–Ω–∏–µ (OSIV):**

* –î–µ—Ä–∂–∞—Ç—å `Session` –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–æ–ª—å—à–µ, —á–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è, –≤–ø–ª–æ—Ç—å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–∞.
* –¢–æ–≥–¥–∞ –ª–µ–Ω–∏–≤—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –∏–ª–∏ –¥–∞–∂–µ –≤ —Å–ª–æ–µ View (—à–∞–±–ª–æ–Ω—ã JSP/Thymeleaf/Freemarker).





***

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è OSIV –±–µ–∑ Spring

–ü—Ä–æ—Å—Ç–µ–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —á–µ—Ä–µ–∑ **—Ñ–∏–ª—å—Ç—Ä** –≤ Servlet-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

```java
public class OpenSessionInViewFilter implements Filter {

    private SessionFactory sessionFactory;

    @Override
    public void init(FilterConfig filterConfig) {
        sessionFactory = HibernateUtil.getSessionFactory();
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        Session session = null;
        Transaction tx = null;
        try {
            session = sessionFactory.openSession();
            HibernateUtil.bindSession(session);

            tx = session.beginTransaction();

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ (controller ‚Üí service ‚Üí dao)
            chain.doFilter(request, response);

            tx.commit();
        } catch (Exception e) {
            if (tx != null) tx.rollback();
            throw new ServletException(e);
        } finally {
            HibernateUtil.unbindSession();
            if (session != null && session.isOpen()) {
                session.close();
            }
        }
    }

    @Override
    public void destroy() {}
}
```

‚ö° –ó–¥–µ—Å—å `HibernateUtil.bindSession(session)` ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ ThreadLocal-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —á—Ç–æ–±—ã DAO –º–æ–≥–ª–∏ –¥–æ—Å—Ç–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é.





***

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è OSIV –≤ Spring Boot

Spring Data JPA —É–∂–µ –∏–º–µ–µ—Ç –≥–æ—Ç–æ–≤—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é ‚Äî `OpenEntityManagerInViewFilter`.

–ï—ë –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π:

```java
spring.jpa.open-in-view=true   # –≤–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

–ö–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ:

* Spring –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `EntityManager` –≤ –Ω–∞—á–∞–ª–µ –∑–∞–ø—Ä–æ—Å–∞.
* –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ View.





***

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å OSIV

* –ó–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è `Session`/`EntityManager`.
* –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∫–æ–º–º–∏—Ç–∏—Ç—Å—è.
* –ù–æ `Session` –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è!
* –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏–ª–∏ View –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å `entity.getLazyCollection()`. Hibernate —Å–¥–µ–ª–∞–µ—Ç SELECT –ø—Ä—è–º–æ –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ.
* –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã `Session` –Ω–∞–∫–æ–Ω–µ—Ü –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è.





***

## –ú–∏–Ω—É—Å—ã OSIV

üî¥ **N+1 –ø—Ä–æ–±–ª–µ–º–∞**: –µ—Å–ª–∏ –≤ —à–∞–±–ª–æ–Ω–µ —Ç—ã –ø–µ—Ä–µ–±–∏—Ä–∞–µ—à—å —Å–ø–∏—Å–æ–∫ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤ –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ `department.getEmployees()`, Hibernate –±—É–¥–µ—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑ –¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å.

üî¥ **–ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–ª–æ—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: —Å–ª–æ–π View –≤–Ω–µ–∑–∞–ø–Ω–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –ª–µ–∑—Ç—å –≤ –±–∞–∑—É.

üî¥ **–¢—è–∂—ë–ª—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∫ –ë–î —Å–ª—É—á–∞–µ—Ç—Å—è –≤ —à–∞–±–ª–æ–Ω–µ, —ç—Ç–æ —Ç—Ä—É–¥–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å.





***

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã OSIV



* **JOIN FETCH / EntityGraph** ‚Äî –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω—É–∂–Ω—ã–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏.
* **DTO-–ø—Ä–æ–µ–∫—Ü–∏–∏** ‚Äî –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ View.
* **Hibernate.initialize()** ‚Äî –≤—Ä—É—á–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.



