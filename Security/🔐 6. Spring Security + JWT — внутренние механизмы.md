
## 1Ô∏è‚É£ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä `AuthController` ‚Äî –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–æ–≥–∏–Ω

```java
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody Map<String, String> body) {
    var auth = new UsernamePasswordAuthenticationToken(
        body.get("username"),
        body.get("password")
    );
    Authentication authentication = authenticationManager.authenticate(auth);
    String token = jwtUtil.generateToken(authentication.getName());
    return ResponseEntity.ok(Map.of("token", token));
}
```


### –¢—ã –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—ë—à—å `UsernamePasswordAuthenticationToken`

* –≠—Ç–æ **–æ–±—ä–µ–∫—Ç-–∑–∞–ø—Ä–æ—Å**, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è.
* –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç:
  * `principal` ‚Üí –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–æ–≥–∏–Ω)
  * `credentials` ‚Üí –ø–∞—Ä–æ–ª—å
  * `authorities` ‚Üí –ø–æ–∫–∞ `null`, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω.

–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ —ç—Ç–æ –ø–æ–º–µ—á–µ–Ω–æ —Ñ–ª–∞–≥–æ–º:

```java
this.authenticated = false;
```


### –í—ã–∑–æ–≤ `authenticationManager.authenticate(auth)`

* –ó–¥–µ—Å—å –≤–∫–ª—é—á–∞–µ—Ç—Å—è **—è–¥—Ä–æ Spring Security**.
* `AuthenticationManager` ‚Äî —ç—Ç–æ **–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**, –æ–±—ã—á–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ–º—ã–π —á–µ—Ä–µ–∑ `ProviderManager`.–í —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ –±–∏–Ω —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–∞–∫:

```java
@Bean
public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
    return config.getAuthenticationManager();
}
```

‚Üí `AuthenticationConfiguration` –≤–Ω—É—Ç—Ä–∏ Spring —Å–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ `AuthenticationProvider`.


### `ProviderManager` –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π `AuthenticationProvider`

Spring –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–¥–∏–Ω ‚Äî `DaoAuthenticationProvider`).

–£—Å–ª–æ–≤–∏–µ –≤—ã–±–æ—Ä–∞:

```java
provider.supports(auth.getClass())
```

`DaoAuthenticationProvider` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true` –¥–ª—è `UsernamePasswordAuthenticationToken`.


### `DaoAuthenticationProvider.authenticate(...)`

–í–æ—Ç —á—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä:

1. –ë–µ—Ä—ë—Ç `principal` (–ª–æ–≥–∏–Ω).
2. –í—ã–∑—ã–≤–∞–µ—Ç —Ç–≤–æ–π `UserDetailsService.loadUserByUsername(username)` (–≤ —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ —ç—Ç–æ `InMemoryUserDetailsManager`).
3. `InMemoryUserDetailsManager` –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞–º—è—Ç–∏:

```java
new User("admin", encodedPassword, List.of());
```

1. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:
   * —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏ —Ö—ç—à –∏–∑ `UserDetails`;
   * —á–µ—Ä–µ–∑ `PasswordEncoder.matches(raw, encoded)`.

–ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç `UsernamePasswordAuthenticationToken`, –Ω–æ —É–∂–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º:

```java
this.authenticated = true;
```

–∏ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ `authorities`.


### `AuthenticationManager` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

‚Üí –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç `Authentication`, –≤ –∫–æ—Ç–æ—Ä–æ–º `getName()` ‚Äî —ç—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∫—É.


### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT

–¢–µ–ø–µ—Ä—å `authentication.getName()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ **payload** —Ç–æ–∫–µ–Ω–∞:


***

## 2Ô∏è‚É£ –û–±—ä–µ–∫—Ç `Authentication` –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è `Authentication`

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤ –æ–±—ã—á–Ω–æ–π —Ñ–æ—Ä–º–µ –ª–æ–≥–∏–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä —á–µ—Ä–µ–∑ `formLogin()`),

Spring –∫–ª–∞–¥—ë—Ç —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –≤ **SecurityContext**:

```java
SecurityContextHolder.getContext().setAuthentication(auth);
```

–í —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî —Ç—ã –¥–µ–ª–∞–µ—à—å —Ä—É—á–Ω–æ–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –ø–æ—ç—Ç–æ–º—É —Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—É, –∞ –µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–∑–∂–µ, –≤ JWT-—Ñ–∏–ª—å—Ç—Ä–µ.


***

## 3Ô∏è‚É£ –ü–æ—á–µ–º—É –Ω—É–∂–µ–Ω –±–∏–Ω `AuthenticationManager`

* –í —Å—Ç–∞—Ä–æ–º Spring Security (–¥–æ 5.7) –æ–Ω —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –≤–Ω—É—Ç—Ä–∏ `WebSecurityConfigurerAdapter`.
* –í –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`SecurityFilterChain` API) –æ–Ω **–Ω–µ —è–≤–ª—è–µ—Ç—Å—è –±–∏–Ω–æ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**.
* –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—Ç –∂–µ –º–µ–Ω–µ–¥–∂–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Security, —Ç—ã —Å–æ–∑–¥–∞—ë—à—å –±–∏–Ω –≤—Ä—É—á–Ω—É—é:

```java
@Bean
public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
    return config.getAuthenticationManager();
}
```

* –≠—Ç–æ—Ç –±–∏–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç `ProviderManager`, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–Ω–∞–µ—Ç –æ —Ç–≤–æ—ë–º `UserDetailsService` –∏ `PasswordEncoder`.

–ë–µ–∑ –Ω–µ–≥–æ `@Autowired AuthenticationManager` –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥—ë—Ç—Å—è.


***

## 4Ô∏è‚É£ JWT-—Ñ–∏–ª—å—Ç—Ä `JwtAuthFilter`


### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ `OncePerRequestFilter`

* **Security Filters** —Ä–∞–±–æ—Ç–∞—é—Ç –¥–æ Spring MVC, –Ω–∞ —É—Ä–æ–≤–Ω–µ **Servlet Filter Chain**.
* `HandlerInterceptor` —Ä–∞–±–æ—Ç–∞–µ—Ç —É–∂–µ **–ø–æ—Å–ª–µ**, –∫–æ–≥–¥–∞ `DispatcherServlet` –≤—ã–∑–≤–∞–Ω, —Ç–æ –µ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ.
* JWT –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–¥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä**.
* `OncePerRequestFilter` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è **—Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –∑–∞–ø—Ä–æ—Å**, –¥–∞–∂–µ –ø—Ä–∏ `forward`/`include`.


### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞

1. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `SecurityFilterChain`.
2. –¢—ã –≤—Ä—É—á–Ω—É—é –≤—Å—Ç–∞–≤–ª—è–µ—à—å —Å–≤–æ–π —Ñ–∏–ª—å—Ç—Ä:

```java
.addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class)
```

‚Üí –∑–Ω–∞—á–∏—Ç, –æ–Ω –æ—Ç—Ä–∞–±–æ—Ç–∞–µ—Ç **–¥–æ** —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ –ø–æ —Ñ–æ—Ä–º–µ.

1. –í `doFilterInternal()` —Ç—ã:
   * –ø—Ä–æ–≤–µ—Ä—è–µ—à—å –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization`;
   * –¥–æ—Å—Ç–∞—ë—à—å —Ç–æ–∫–µ–Ω (`Bearer <jwt>` ‚Üí `jwt`);
   * –≤—ã–∑—ã–≤–∞–µ—à—å `jwtUtil.extractUsername(token)`.


### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏:

```java
String username = jwtUtil.extractUsername(token);
```

* `Jwts.parser().verifyWith(key)...` –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å.
* –ü–∞—Ä—Å–µ—Ä –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HMAC –∏–ª–∏ RSA –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–ª—é—á–∞.
* –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω –∏–ª–∏ –ø–æ–¥–ø–∏—Å—å –Ω–µ–≤–µ—Ä–Ω–∞ ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è `JwtException`.


### –í—Ç–æ—Ä–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```java
jwtUtil.isValid(token)
```

* –ï—â—ë —Ä–∞–∑ –≤—ã–∑—ã–≤–∞–µ—Ç `Jwts.parser()` ‚Äî –Ω–æ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –±–ª–æ–∫–µ try/catch.
* –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å/–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É.

> üí° –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –ª—É—á—à–µ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —ç—Ç–∏ —à–∞–≥–∏ (–¥–æ—Å—Ç–∞—Ç—å username —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏).


### –°–æ–∑–¥–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–∑ —Ç–æ–∫–µ–Ω–∞:

```java
User userDetails = new User(username, "", Collections.emptyList());
UsernamePasswordAuthenticationToken auth =
        new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
SecurityContextHolder.getContext().setAuthentication(auth);
```

* –°–æ–∑–¥–∞—ë—Ç—Å—è –æ–±—ä–µ–∫—Ç `User` (–≤—Ä–µ–º–µ–Ω–Ω—ã–π) ‚Äî –ø–∞—Ä–æ–ª—å –Ω–µ –Ω—É–∂–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ–∫–µ–Ω —É–∂–µ –¥–æ–∫–∞–∑–∞–ª –ª–∏—á–Ω–æ—Å—Ç—å.
* –ù–æ–≤—ã–π `UsernamePasswordAuthenticationToken` –ø–æ–ª—É—á–∞–µ—Ç `authenticated = true`.
* –ü–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç `SecurityContextHolder`, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.


***

## 5Ô∏è‚É£ –ö–æ–Ω—Ç–µ–∫—Å—Ç `SecurityContextHolder`

* –≠—Ç–æ **ThreadLocal-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ**, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–µ –∫ —Ç–µ–∫—É—â–µ–º—É –ø–æ—Ç–æ–∫—É –∑–∞–ø—Ä–æ—Å–∞.
* –ö–æ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `SecurityContextHolder.getContext().setAuthentication(auth)`:
  * –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã –≤ —ç—Ç–æ–º –ø–æ—Ç–æ–∫–µ (`@GetMapping("/auth")`) –≤–∏–¥—è—Ç `Authentication`.
* –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ Spring –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.


***

## 6Ô∏è‚É£ –ü–æ—á–µ–º—É –ø–∞—Ä–æ–ª—å ‚Äî –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

```java
new User(username, "", Collections.emptyList());
```

* –ù–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –º—ã —É–∂–µ **–¥–æ–≤–µ—Ä—è–µ–º** –¥–∞–Ω–Ω—ã–º –≤ JWT (–æ–Ω –ø–æ–¥–ø–∏—Å–∞–Ω —Å–µ—Ä–≤–µ—Ä–æ–º).
* –ü–∞—Ä–æ–ª—å –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ, –Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.
* –ó–¥–µ—Å—å —Å–æ–∑–¥–∞—ë—Ç—Å—è "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å `SecurityContext` –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.


***

## 7Ô∏è‚É£ –ß—Ç–æ –∑–∞ `Collections.emptyList()`

```java
new User(username, "", Collections.emptyList());
```

–¢—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ User:

```java
Collection<? extends GrantedAuthority> authorities
```

–≠—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ —Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ —Ä–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```java
[ROLE_USER, ROLE_ADMIN, PERMISSION_VIEW_DASHBOARD]
```

Spring –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –≤—Ä–æ–¥–µ:

```java
@PreAuthorize("hasRole('ADMIN')")
```


