# ü™≤ –ì–ª–∞–≤–∞ 11. Testcontainers ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

## –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Testcontainers** ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è Java (–∏ –Ω–µ —Ç–æ–ª—å–∫–æ),
&#x20;–∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å **–Ω–∞—Å—Ç–æ—è—â–∏–µ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤,
&#x20;–Ω–∞–ø—Ä–∏–º–µ—Ä:

* –Ω–∞—Å—Ç–æ—è—â—É—é PostgreSQL/MySQL/MongoDB
* –±—Ä–æ–∫–µ—Ä—ã Kafka / RabbitMQ
* Redis / Elasticsearch
* –∏–ª–∏ –¥–∞–∂–µ –≤–µ—Å—å —Å–≤–æ–π backend –≤ Docker Compose

–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

* —Å—Ç–∞—Ä—Ç—É—é—Ç –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º,
* –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –Ω–µ–≥–æ,
* —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ (–Ω–∏–∫–∞–∫–∏—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ—Ä—Ç–æ–≤ –∏–ª–∏ –º—É—Å–æ—Ä–∞).





***

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

Maven:

```java
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>1.20.1</version>
    <scope>test</scope>
</dependency>

<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>postgresql</artifactId>
    <version>1.20.1</version>
    <scope>test</scope>
</dependency>
```

Gradle:

```groovy
testImplementation 'org.testcontainers:junit-jupiter:1.20.1'
testImplementation 'org.testcontainers:postgresql:1.20.1'
```

‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π **Docker** (Testcontainers –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ –Ω–µ–≥–æ).





***

## –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –ø—Ä–∏–º–µ—Ä ‚Äî PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```java
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.test.context.junit.jupiter.SpringExtension;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import static org.junit.jupiter.api.Assertions.*;

@Testcontainers // –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç Testcontainers lifecycle
@ExtendWith(SpringExtension.class)
class SimplePostgresTest {

    @Container // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è
    static PostgreSQLContainer<?> postgres =
        new PostgreSQLContainer<>("postgres:16-alpine")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");

    @Test
    void testContainerRunning() {
        assertTrue(postgres.isRunning());
        System.out.println("JDBC URL: " + postgres.getJdbcUrl());
    }
}
```

üì¶ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

* –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–∞ Docker —Å–∫–∞—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞–∑ `postgres:16-alpine`,
* —Å–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö,
* –ø–æ–¥–Ω–∏–º–∞–µ—Ç –µ–≥–æ,
* –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç.





***

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Spring Boot (`@DynamicPropertySource`)

Spring Boot –º–æ–∂–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ **–ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `@DynamicPropertySource`.

```java
@SpringBootTest
@Testcontainers
class UserRepositoryIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:16-alpine")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }

    @Autowired
    private UserRepository repo;

    @Test
    void shouldSaveAndFindUser() {
        User user = new User("Alice");
        repo.save(user);

        assertTrue(repo.findByName("Alice").isPresent());
    }
}
```

‚úÖ –í —ç—Ç–æ–º —Ç–µ—Å—Ç–µ:

* –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π PostgreSQL –≤ Docker,
* Spring Boot –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –Ω–µ–º—É –∫–∞–∫ –∫ –Ω–∞—Å—Ç–æ—è—â–µ–π –ë–î,
* `UserRepository` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤ –ø—Ä–æ–¥–µ,
* –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å—á–µ–∑–∞—é—Ç.





***

## –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

| –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞          | –ü–æ–≤–µ–¥–µ–Ω–∏–µ                                        |
| ------------------------------ | ------------------------------------------------ |
| `@Container` (–Ω–µ static)       | –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º**    |
| `@Container static`            | –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Å** |
| –≤—Ä—É—á–Ω—É—é `.start()` / `.stop()` | –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ `@BeforeAll`)       |





***

## –ü—Ä–∏–º–µ—Ä: —Ç–µ—Å—Ç —Å Flyway –∏ Liquibase

Testcontainers —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏.

–ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `src/main/resources/db/migration`, –∏ Spring Boot –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Ç–µ—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç –∏—Ö –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–π –ë–î.

```java
@SpringBootTest
@Testcontainers
class MigrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:16-alpine");

    @DynamicPropertySource
    static void props(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }

    @Autowired
    JdbcTemplate jdbc;

    @Test
    void migrationWorks() {
        Integer count = jdbc.queryForObject("SELECT COUNT(*) FROM users", Integer.class);
        assertNotNull(count);
    }
}
```





***

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker Compose

Testcontainers —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Å `docker-compose.yml`:

```java
import org.testcontainers.containers.DockerComposeContainer;
import java.io.File;

class ComposeTest {

    static DockerComposeContainer<?> environment =
        new DockerComposeContainer<>(new File("src/test/resources/docker-compose.yml"))
            .withExposedService("db", 5432)
            .withExposedService("redis", 6379);
}
```

‚Üí —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –º–æ–∂–Ω–æ –ø–æ–¥–Ω–∏–º–∞—Ç—å —Ü–µ–ª—É—é —Å—Ä–µ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, PostgreSQL + Redis + Kafka) –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞.





***

## –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* **Reuse containers:** –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å `testcontainers.reuse.enable=true`, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏ (—É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É).
* **Log consumers:** –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Ç–µ—Å—Ç–µ.
* **Wait strategies:** –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫–∞ –ø–æ—Ä—Ç –Ω–µ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω).

```java
.withExposedPorts(5432)
.waitingFor(Wait.forListeningPort())
```





***

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Testcontainers

‚úÖ –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä, –µ—Å–ª–∏:

* —Ç—ã —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å **—Ä–µ–∞–ª—å–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π** (–ë–î, Kafka, Redis, API);
* —Ö–æ—á–µ—à—å **–∑–∞–º–µ–Ω–∏—Ç—å –º–æ–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã**;
* –ø—Ä–æ–µ–∫—Ç —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Docker (–∞ —ç—Ç–æ –ø–æ—á—Ç–∏ –≤—Å–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ Spring-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è).

‚ùå –ò–∑–±—ã—Ç–æ—á–Ω–æ, –µ—Å–ª–∏:

* —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–ª—É—á—à–µ –º–æ–∫–∞—Ç—å);
* —Ç—ã –¥–µ–ª–∞–µ—à—å unit-—Ç–µ—Å—Ç—ã, –≥–¥–µ –≤–∞–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Å—ë –∂–µ —Å—Ç–∞—Ä—Ç—É—é—Ç –¥–æ–ª—å—à–µ).



