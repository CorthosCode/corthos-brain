# ü™≤ –ì–ª–∞–≤–∞ 12. End-to-End (E2E) —Ç–µ—Å—Ç Spring Boot –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Testcontainers

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```java
src/
 ‚îú‚îÄ‚îÄ main/java/com/example/demo/
 ‚îÇ     ‚îú‚îÄ‚îÄ controller/UserController.java
 ‚îÇ     ‚îú‚îÄ‚îÄ service/UserService.java
 ‚îÇ     ‚îú‚îÄ‚îÄ repository/UserRepository.java
 ‚îÇ     ‚îî‚îÄ‚îÄ model/User.java
 ‚îî‚îÄ‚îÄ test/java/com/example/demo/
       ‚îî‚îÄ‚îÄ UserE2ETest.java
```





***

## –ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

üíæ `User.java`

```java
package com.example.demo.model;

import jakarta.persistence.*;

@Entity
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private String city;

    public User() {}
    public User(String name, String city) {
        this.name = name;
        this.city = city;
    }

    // getters/setters
    public Long getId() { return id; }
    public String getName() { return name; }
    public String getCity() { return city; }
    public void setName(String name) { this.name = name; }
    public void setCity(String city) { this.city = city; }
}
```



üß† `UserRepository.java`

```java
package com.example.demo.repository;

import com.example.demo.model.User;
import org.springframework.data.jpa.repository.JpaRepository;

public interface UserRepository extends JpaRepository<User, Long> {}
```



üåê `UserService.java`

```java
package com.example.demo.service;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Service
public class UserService {

    private final UserRepository repo;
    private final RestTemplate rest;

    public UserService(UserRepository repo, RestTemplate rest) {
        this.repo = repo;
        this.rest = rest;
    }

    public User register(String name) {
        // –≤–Ω–µ—à–Ω–∏–π API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ä–æ–¥ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        String city = rest.getForObject("https://api.example.com/city?name=" + name, String.class);
        User user = new User(name, city);
        return repo.save(user);
    }
}
```



üö™ `UserController.java`

```java
package com.example.demo.controller;

import com.example.demo.model.User;
import com.example.demo.service.UserService;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/users")
public class UserController {

    private final UserService service;
    public UserController(UserService service) {
        this.service = service;
    }

    @PostMapping("/{name}")
    public User create(@PathVariable String name) {
        return service.register(name);
    }
}
```



üß™ `UserE2ETest.java`

```java
package com.example.demo;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@Testcontainers
@AutoConfigureMockMvc
class UserE2ETest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:16-alpine")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");

    @DynamicPropertySource
    static void configure(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }

    @Autowired
    MockMvc mockMvc;

    @Autowired
    UserRepository repo;

    @MockBean
    RestTemplate restTemplate;

    @Test
    void fullEndToEndTest() throws Exception {
        // 1Ô∏è‚É£ –ú–æ–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–π API
        when(restTemplate.getForObject("https://api.example.com/city?name=Alice", String.class))
                .thenReturn("London");

        // 2Ô∏è‚É£ –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
        mockMvc.perform(post("/users/Alice"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.name").value("Alice"))
                .andExpect(jsonPath("$.city").value("London"));

        // 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –≤ –±–∞–∑—É (—á–µ—Ä–µ–∑ Testcontainers PostgreSQL)
        assertThat(repo.findAll())
                .extracting(User::getCity)
                .containsExactly("London");
    }
}
```





***

## –ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

| –≠—Ç–∞–ø | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                                                          |
| ---- | ----------------------------------------------------------------------------------- |
| 1Ô∏è‚É£  | –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **—Ä–µ–∞–ª—å–Ω—ã–π PostgreSQL** —á–µ—Ä–µ–∑ Testcontainers                            |
| 2Ô∏è‚É£  | Spring Boot —Å—Ç–∞—Ä—Ç—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —Å–µ—Ä–≤–∏—Å—ã, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã)                   |
| 3Ô∏è‚É£  | –í–Ω–µ—à–Ω–∏–π API **–∑–∞–º–µ–Ω—è–µ—Ç—Å—è –º–æ–∫-–±–∏–Ω–æ–º** (`@MockBean RestTemplate`)                     |
| 4Ô∏è‚É£  | –ß–µ—Ä–µ–∑ **MockMvc** —Ç–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É                         |
| 5Ô∏è‚É£  | –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–≤–∏—Å, —Å–µ—Ä–≤–∏—Å —Ö–æ–¥–∏—Ç –≤ –º–æ–∫–Ω—É—Ç—ã–π RestTemplate –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ |
| 6Ô∏è‚É£  | –ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ **–∑–∞–ø–∏—Å—å —Ä–µ–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–ª–∞—Å—å –≤ –±–∞–∑–µ**                 |



