
## Spy (—à–ø–∏–æ–Ω—ã)

**–ú–æ–∫** –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–º–µ–Ω—è–µ—Ç –æ–±—ä–µ–∫—Ç.

**Spy** ‚Äî —ç—Ç–æ –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ **—Ä–µ–∞–ª—å–Ω—ã–º –æ–±—ä–µ–∫—Ç–æ–º**, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:

* –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–µ –º–µ—Ç–æ–¥—ã,
* –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–º–µ–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–∑ –Ω–∏—Ö,
* –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–∑–æ–≤—ã.

```java
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import static org.junit.jupiter.api.Assertions.*;

import java.util.ArrayList;
import java.util.List;

class SpyExampleTest {

    @Test
    void testSpy() {
        List<String> list = new ArrayList<>();
        List<String> spyList = Mockito.spy(list);

        // –æ–±—ã—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π –º–µ—Ç–æ–¥
        spyList.add("Hello");
        spyList.add("World");

        assertEquals(2, spyList.size());

        // –ø–æ–¥–º–µ–Ω—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
        Mockito.when(spyList.size()).thenReturn(100);

        assertEquals(100, spyList.size());

        // –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∑–æ–≤–∞
        Mockito.verify(spyList).add("Hello");
        Mockito.verify(spyList).add("World");
    }
}
```

üí° **–í–∞–∂–Ω–æ:** –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å–æ `spy` –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `doReturn`/`doThrow`, –∞ –Ω–µ `when`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≤—ã–∑–æ–≤–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞.

```java
Mockito.doReturn(42).when(spyList).size();
```


***

## ArgumentCaptor

–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å **–Ω–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞**, –Ω–æ –∏ **–∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –±—ã–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã**.

–î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `ArgumentCaptor`.

–û–±—ã—á–Ω—ã–π `verify()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ **—Ñ–∞–∫—Ç –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞**.

–ù–æ –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å **—á—Ç–æ –∏–º–µ–Ω–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –≤ –º–µ—Ç–æ–¥**.

–ù–∞–ø—Ä–∏–º–µ—Ä, —É —Ç–µ–±—è –µ—Å—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –≤ –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç, –∏ —Ç—ã —Ö–æ—á–µ—à—å —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç** —É—à—ë–ª –≤ –≤—ã–∑–æ–≤.

```java
service.createUser("Alice");

// –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ repo.save –≤—ã–∑–≤–∞–ª—Å—è —Å –æ–±—ä–µ–∫—Ç–æ–º User("Alice")
Mockito.verify(repo).save(new User("Alice")); // ‚ùå –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
```

–ü–æ—á–µ–º—É ‚ùå?

–ü–æ—Ç–æ–º—É —á—Ç–æ `new User("Alice")` –∏ `new User("Alice")` ‚Äî —ç—Ç–æ **—Ä–∞–∑–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç–∏**, –∏ `equals()` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω.


–ü—Ä–∏–º–µ—Ä —Å ArgumentCaptor

```java
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.Mockito;

import static org.junit.jupiter.api.Assertions.*;

class ArgumentCaptorTest {

    @Test
    void testCaptor() {
        UserRepository repo = Mockito.mock(UserRepository.class);
        UserService service = new UserService(repo);

        service.findUser("123");

        ArgumentCaptor<String> captor = ArgumentCaptor.forClass(String.class);
        Mockito.verify(repo).findById(captor.capture());

        String captured = captor.getValue();
        assertEquals("123", captured);
    }
}
```

üëâ Captor –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω, –µ—Å–ª–∏ –º–µ—Ç–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç **—Å–ª–æ–∂–Ω—ã–π –æ–±—ä–µ–∫—Ç**, –∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –µ–≥–æ –ø–æ–ª—è.


### Captor –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤

–ï—Å–ª–∏ –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–ª—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Äî –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å **–≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è**:

```java
Mockito.verify(repo, Mockito.times(2)).save(captor.capture());

List<User> capturedUsers = captor.getAllValues();
assertEquals("Alice", capturedUsers.get(0).getName());
assertEquals("Bob", capturedUsers.get(1).getName());
```


***

## –†–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ stubbing (doReturn, doThrow, doAnswer)

–ò–Ω–æ–≥–¥–∞ `when(...).thenReturn(...)` –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ —Å `spy`.

–¢–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `doReturn` / `doThrow` / `doAnswer`.


**`doReturn`**

```java
Mockito.doReturn("fixed value").when(spyList).get(0);
```


**`doThrow`**

```java
Mockito.doThrow(new RuntimeException("fail"))
       .when(repo).findById("badId");
```


**`doAnswer`** ‚Äî –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è

```java
Mockito.doAnswer(invocation -> {
    String arg = invocation.getArgument(0, String.class);
    return new User(arg, "Name_" + arg);
}).when(repo).findById(Mockito.anyString());
```


***

## `reset()` –∏ `clearInvocations()`

* `reset(mock)` ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –º–æ–∫ (–∑–∞–±—ã–≤–∞–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –≤—ã–∑–æ–≤–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏).
  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ, —Ç.–∫. –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç—ã –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–º–∏.
* `clearInvocations(mock)` ‚Äî —Å—Ç–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—é –≤—ã–∑–æ–≤–æ–≤, –Ω–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `when(...)`.


***

## Partial Mocks (—á–∞—Å—Ç–∏—á–Ω–æ–µ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ)

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –º–æ–∫, —É –∫–æ—Ç–æ—Ä–æ–≥–æ —á–∞—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤ –Ω–∞—Å—Ç–æ—è—â–∏–µ, –∞ —á–∞—Å—Ç—å –ø–æ–¥–º–µ–Ω–µ–Ω—ã.

```java
UserRepository repo = Mockito.mock(UserRepository.class, Mockito.CALLS_REAL_METHODS);
```

–ù–æ –ª—É—á—à–µ –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Spy** ‚Äî —ç—Ç–æ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π –ø–æ–¥—Ö–æ–¥.


***

## BDD-—Å—Ç–∏–ª—å –≤ Mockito

Mockito –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–∏–ª—å `given/when/then` (–∏–∑ BDD):

BDD (**Behavior-Driven Development**) ‚Äî —Å—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤, –≥–¥–µ —É–ø–æ—Ä –Ω–∞ **–ø–æ–≤–µ–¥–µ–Ω–∏–µ** —Å–∏—Å—Ç–µ–º—ã.

–°—Ü–µ–Ω–∞—Ä–∏–π —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ —à–∞–≥–∞–º:

* `given` ‚Üí –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É—Å–ª–æ–≤–∏–π, –º–æ–∫–æ–≤
* `when` ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ
* `then` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞


–û–±—ã—á–Ω—ã–π —Å—Ç–∏–ª—å:

```java
Mockito.when(repo.findById("1"))
       .thenReturn(new User("1", "Alice"));

User result = service.findUser("1");

Mockito.verify(repo).findById("1");
```


BDD-—Å—Ç–∏–ª—å:

```java
import static org.mockito.BDDMockito.*;

given(repo.findById("1"))
        .willReturn(new User("1", "Alice"));

User result = service.findUser("1");

then(repo).should().findById("1");
```

–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥—Ä—É–≥–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –Ω–æ —Ç–µ—Å—Ç—ã –≤—ã–≥–ª—è–¥—è—Ç "–ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω–æ".

* –° **BDDMockito** —Ç–µ—Å—Ç —á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ü–µ–Ω–∞—Ä–∏–π:
  ¬´**–î–∞–Ω–æ** —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí **–ö–æ–≥–¥–∞** —Å–µ—Ä–≤–∏—Å –∏—â–µ—Ç –ø–æ id ‚Üí **–¢–æ–≥–¥–∞** —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω¬ª.
* –≠—Ç–æ —É–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –¥–µ–ª–∞–µ—Ç —Ç–µ—Å—Ç—ã –±–ª–∏–∂–µ –∫ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ.


***

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Mockito

* –ú–æ–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ë–î, API, —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã).
* **–ù–µ –º–æ–∫–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ POJO-–∫–ª–∞—Å—Å—ã** ‚Äî –ª—É—á—à–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –Ω–∞–ø—Ä—è–º—É—é.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ArgumentCaptor` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –∞ –Ω–µ `assertEquals` "–≤—Å–ª–µ–ø—É—é".
* –ò–∑–±–µ–≥–∞—Ç—å `reset(mock)` ‚Äî –ª—É—á—à–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–∫.
* –î–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å `BDDMockito` (given/then).

