# ü™≤ –ì–ª–∞–≤–∞ 13. End-to-End (E2E) —Ç–µ—Å—Ç —Å H2 (–±–µ–∑ Testcontainers)

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

H2 —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω –≤ Spring Boot Starter (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `spring-boot-starter-data-jpa`), –Ω–æ –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤—å –≤—Ä—É—á–Ω—É—é:



Maven

```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```



Gradle

```groovy
testImplementation 'com.h2database:h2'
```





***

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Spring Boot –¥–ª—è H2

–í `src/test/resources/application-test.yml`:

```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
    driverClassName: org.h2.Driver
    username: sa
    password: 
  jpa:
    hibernate:
      ddl-auto: create-drop
    show-sql: true
```

‚ö†Ô∏è `DB_CLOSE_DELAY=-1` ‚Äî –±–∞–∑–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ —Ç–µ—Å—Ç–µ. 

`create-drop` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–µ–¥/–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤.





***

## –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∞—Å—Å

```java
package com.example.demo;

import com.example.demo.model.User;
import com.example.demo.repository.UserRepository;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.test.web.servlet.MockMvc;

import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@AutoConfigureMockMvc
class UserH2E2ETest {

    @Autowired
    MockMvc mockMvc;

    @Autowired
    UserRepository repo;

    @MockBean
    RestTemplate restTemplate;

    @Test
    void fullEndToEndTest_withH2() throws Exception {
        // –ú–æ–∫–∞–µ–º –≤–Ω–µ—à–Ω–∏–π API
        when(restTemplate.getForObject("https://api.example.com/city?name=Alice", String.class))
                .thenReturn("Paris");

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º HTTP-–∑–∞–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
        mockMvc.perform(post("/users/Alice"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.name").value("Alice"))
                .andExpect(jsonPath("$.city").value("Paris"));

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å –≤ H2
        assertThat(repo.findAll())
                .extracting(User::getCity)
                .containsExactly("Paris");
    }
}
```





***

## –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —á–∞—Å—Ç–æ –¥–µ–ª–∞—é—Ç —Ç–∞–∫:

* **–≤—Å–µ —Ç–µ—Å—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** ‚Äî —Å H2 (–±—ã—Å—Ç—Ä–æ);
* **–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å** (`@ActiveProfiles("integration")`) ‚Äî —Å Testcontainers;
* CI –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±–∞ –Ω–∞–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, nightly build —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏).



